<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplayer Game 1</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            position: relative;
        }
        h1 {
            color: #333;
        }
        #game-container {
            width: 600px;
            height: 400px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        .player {
            width: 50px;
            height: 50px;
            background-color: #ff6347;
            border-radius: 50%;
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            transition: transform 0.1s linear;
        }
        #nickname-container {
            margin-bottom: 20px;
        }
        #nickname {
            padding: 5px;
            font-size: 16px;
        }
        #set-nickname {
            padding: 5px 10px;
            font-size: 16px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }
        #set-nickname:disabled {
            background-color: #aaa;
        }
        #chat-container {
            width: 600px;
            height: 200px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: absolute;
            bottom: 60%;
            left: 60%;
            transition: bottom 0.3s ease;
        }
        #chat-container.open {
            bottom: 0;
        }
        #chat-messages {
            height: 140px;
            overflow-y: auto;
            padding: 10px;
            box-sizing: border-box;
        }
        #chat-input {
            display: flex;
            padding: 10px;
            box-sizing: border-box;
        }
        #chat-input input {
            flex: 1;
            padding: 5px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #chat-input button {
            padding: 5px 10px;
            font-size: 16px;
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            margin-left: 10px;
        }
        #toggle-chat {
            position: absolute;
            bottom: 210px;
            left: 50%;
            transform: translateX(-50%);
            padding: 5px 10px;
            font-size: 16px;
            background-color: #ff6347;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <link rel="stylesheet" href="styles.css">
    <nav class="navbar">
        <ul class="nav-links">
            <li class="nav-item"><a href="/">Home</a></li>
            <li class="nav-item"><a href="/#products">Products</a></li>
            <li class="nav-item"><a href="/#help">Help</a></li>
            <li class="nav-item"><a href="/#about">About</a></li>
            <li class="nav-item dropdown">
                <a href="javascript:void(0)" class="dropbtn">More</a>
                <div class="dropdown-content">
                    <a href="/#portfolio">Portfolio</a>
                    <a href="/#contact">Contact</a>
                    <a href="/#blog">Blog</a>
                    <a href="/live-chat">Live Chat</a>
                </div>
            </li>
        </ul>
    </nav>
    <div style="padding:30px;"></div>
    <div id="nickname-container">
        <input type="text" id="nickname" placeholder="Enter your nickname" maxlength="10">
        <button id="set-nickname">Set Nickname</button>
    </div>
    <h1>Multiplayer Game 1</h1>
    <div id="game-container"></div>

    <!-- Chat container -->

    <div id="chat-container" class="hidden">
        <div id="chat-messages"></div>
        <div id="chat-input">
            <input type="text" id="message" placeholder="Type a message..." maxlength="100">
            <button id="send-message">Send</button>
        </div>
    </div>
    <button id="toggle-chat">Show Chat</button>

    <script>
        const gameContainer = document.getElementById('game-container');
        const nicknameInput = document.getElementById('nickname');
        const setNicknameButton = document.getElementById('set-nickname');
        const chatContainer = document.getElementById('chat-container');
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message');
        const sendMessageButton = document.getElementById('send-message');
        const toggleChatButton = document.getElementById('toggle-chat');

        let playerNickname = '';
        let playerPosition = { x: 50, y: 50 };
        const playerSpeed = 10;
        const playerSize = 50; // Size of the player
        let players = {};

        // Store previous positions for interpolation
        const previousPositions = {};

        function createPlayerElement(nickname, position) {
            const player = document.createElement('div');
            player.classList.add('player');
            player.style.transform = `translate(${position.x}px, ${position.y}px)`;
            player.innerText = nickname;
            return player;
        }

        function updatePlayerElement(playerElement, position, previousPosition) {
            const interpolatedPosition = {
                x: previousPosition.x + (position.x - previousPosition.x) * 0.1,
                y: previousPosition.y + (position.y - previousPosition.y) * 0.1
            };
            playerElement.style.transform = `translate(${interpolatedPosition.x}px, ${interpolatedPosition.y}px)`;
        }

        function renderPlayers() {
            gameContainer.innerHTML = '';
            for (const [nickname, position] of Object.entries(players)) {
                let playerElement = document.querySelector(`.player[data-nickname="${nickname}"]`);
                if (!playerElement) {
                    playerElement = createPlayerElement(nickname, position);
                    playerElement.setAttribute('data-nickname', nickname);
                    gameContainer.appendChild(playerElement);
                }
                const previousPosition = previousPositions[nickname] || position;
                updatePlayerElement(playerElement, position, previousPosition);
                previousPositions[nickname] = position;
            }
        }

        function setPlayerNickname() {
            playerNickname = nicknameInput.value.trim();
            if (playerNickname.length > 0) {
                setNicknameButton.disabled = true;
                nicknameInput.disabled = true;
                // Register player with server
                fetch('/register_player', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        nickname: playerNickname,
                        position: playerPosition
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Player registered:', data);
                    fetchGameState();
                })
                .catch(error => {
                    console.error('Error registering player:', error);
                });
            }
        }

        function movePlayer(event) {
            switch (event.key) {
                case 'ArrowUp':
                    playerPosition.y = Math.max(0, playerPosition.y - playerSpeed);
                    break;
                case 'ArrowDown':
                    playerPosition.y = Math.min(gameContainer.clientHeight - playerSize, playerPosition.y + playerSpeed);
                    break;
                case 'ArrowLeft':
                    playerPosition.x = Math.max(0, playerPosition.x - playerSpeed);
                    break;
                case 'ArrowRight':
                    playerPosition.x = Math.min(gameContainer.clientWidth - playerSize, playerPosition.x + playerSpeed);
                    break;
            }
            players[playerNickname] = playerPosition;
            renderPlayers();
            // Update position on server
            fetch('/update_position', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    nickname: playerNickname,
                    position: playerPosition
                }),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Position updated:', data);
            })
            .catch(error => {
                console.error('Error updating position:', error);
            });
        }

        function fetchGameState() {
            fetch('/game_state')
                .then(response => response.json())
                .then(data => {
                    players = data.players;
                    renderPlayers();
                })
                .catch(error => {
                    console.error('Error fetching game state:', error);
                });
        }

        // Handle chat message sending
        function sendMessage() {
            const message = messageInput.value.trim();
            if (message.length > 0) {
                fetch('/send_message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: playerNickname,
                        message: message
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        messageInput.value = '';
                        fetchMessages();  // Fetch messages immediately after sending
                    } else {
                        alert(data.error || 'Failed to send message');
                    }
                })
                .catch(error => {
                    console.error('Error sending message:', error);
                });
            }
        }

        // Fetch chat messages
        function fetchMessages() {
            fetch('/get_messages')
                .then(response => response.json())
                .then(data => {
                    const messages = data.messages;
                    chatMessages.innerHTML = '';
                    messages.forEach(msg => {
                        const messageElement = document.createElement('div');
                        messageElement.textContent = msg;
                        chatMessages.appendChild(messageElement);
                    });
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                })
                .catch(error => {
                    console.error('Error fetching messages:', error);
                });
        }

        // Toggle chat visibility
        function toggleChat() {
            if (chatContainer.classList.contains('hidden')) {
                chatContainer.classList.remove('hidden');
                toggleChatButton.textContent = 'Hide Chat';
            } else {
                chatContainer.classList.add('hidden');
                toggleChatButton.textContent = 'Show Chat';
            }
        }

        // Event Listeners
        setNicknameButton.addEventListener('click', setPlayerNickname);
        window.addEventListener('keydown', movePlayer);
        sendMessageButton.addEventListener('click', sendMessage);
        toggleChatButton.addEventListener('click', toggleChat);

        // Polling for game state and chat messages
        setInterval(fetchGameState, 500);  // Update game state every 500ms
        setInterval(fetchMessages, 1000);  // Update chat messages every 1000ms
    </script>
</body>
</html>
