<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Unlim8ted - Product</title>
  <meta name="description" content="Unlim8ted Product page. Powered by Unlim8ted Studio Productions" />
  <link rel="icon" href="https://unlim8ted.com/favicon.ico" type="image/x-icon" />

  <!-- Components -->
  <script type="module" src="/components/site-navbar.js"></script>
  <script type="module" src="/components/site-loader.js"></script>

  <style>
    :root{
      --bg:#0b0b0f;
      --panel:#14141b;
      --panel2:#101017;
      --stroke: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --accent:#00ff99;
      --accent2:#ff0077;
      --shadow: 0 16px 40px rgba(0,0,0,.45);
      --r: 18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1000px 600px at 20% 10%, rgba(0,255,153,.10), transparent 55%),
                  radial-gradient(900px 600px at 80% 0%, rgba(255,0,119,.10), transparent 55%),
                  var(--bg);
      color: var(--text);
      padding-top: 56px; /* navbar space */
      min-height: 100vh;
    }

    .page{
      width: min(1100px, 92vw);
      margin: 26px auto 60px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 14px;
    }
    .title{
      font-size: 28px;
      letter-spacing: .2px;
      margin: 0;
    }
    .back{
      color: var(--muted);
      text-decoration:none;
      border: 1px solid var(--stroke);
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.03);
    }
    .back:hover{ border-color: rgba(0,255,153,.35); color: var(--text); }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 16px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-inner{ padding: 18px; }

    .media{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .hero{
      width:100%;
      aspect-ratio: 16/10;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
    }
    .hero img, .hero video, .hero iframe{
      width:100%;
      height:100%;
      object-fit: cover;
      border:0;
      display:block;
    }

    .thumbs{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .thumb{
      width: 74px;
      height: 54px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      overflow:hidden;
      cursor:pointer;
      opacity:.9;
    }
    .thumb:hover{ opacity: 1; border-color: rgba(0,255,153,.35); }
    .thumb img, .thumb video{
      width:100%; height:100%; object-fit: cover; display:block;
    }

    .product{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .product h2{
      margin: 0;
      font-size: 26px;
      line-height: 1.15;
    }
    .desc{
      margin:0;
      color: var(--muted);
      line-height: 1.55;
    }
    .price-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-top: 6px;
    }
    .price{
      font-size: 22px;
      font-weight: 800;
      color: var(--accent);
      text-shadow: 0 0 16px rgba(0,255,153,.22);
    }

    .btns{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .btn{
      border:none;
      border-radius: 999px;
      padding: 11px 14px;
      font-weight: 800;
      cursor:pointer;
      color:#0b0b0f;
      background: linear-gradient(45deg, var(--accent), #2bffd5);
      box-shadow: 0 0 0 3px rgba(0,255,153,.12);
    }
    .btn:hover{ filter: brightness(1.05); }
    .btn.secondary{
      background: rgba(255,255,255,.06);
      color: var(--text);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow:none;
    }
    .btn.secondary:hover{ border-color: rgba(0,255,153,.30); }

    /* ratings */
    .ratingBox{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    .avgRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .avg{
      display:flex;
      align-items:baseline;
      gap: 10px;
    }
    .avgNum{
      font-size: 40px;
      font-weight: 900;
      line-height:1;
    }
    .avgMeta{
      color: var(--muted);
      font-size: 13px;
    }
    .stars{
      display:flex;
      gap: 4px;
      color: #ffcc66;
      text-shadow: 0 0 10px rgba(255,204,102,.18);
      font-size: 18px;
    }

    .bars{
      display:grid;
      gap: 8px;
    }
    .barRow{
      display:grid;
      grid-template-columns: 50px 1fr 44px;
      gap: 10px;
      align-items:center;
      color: var(--muted);
      font-size: 13px;
    }
    .barTrack{
      height: 10px;
      background: rgba(255,255,255,.08);
      border-radius: 999px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.08);
    }
    .barFill{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(0,255,153,.9), rgba(255,0,119,.85));
    }

    /* comments */
    .commentsCard h3{ margin: 0 0 10px; }
    .commentForm{
      display:grid;
      gap: 10px;
      padding: 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.10);
      margin-bottom: 12px;
    }
    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 720px){
      .grid{ grid-template-columns: 1fr; }
      .row2{ grid-template-columns: 1fr; }
    }

    label{ font-size: 12px; color: rgba(255,255,255,.70); }
    select, textarea, input{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,255,153,.30);
      background: rgba(16,16,23,.88);
      color: var(--text);
      outline:none;
    }
    textarea{ min-height: 90px; resize: vertical; }
    select:focus, textarea:focus, input:focus{
      border-color: rgba(0,255,153,.65);
      box-shadow: 0 0 0 3px rgba(0,255,153,.10);
    }

    .commentList{
      display:grid;
      gap: 10px;
    }
    .comment{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding: 12px;
    }
    .commentTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 6px;
    }
    .who{
      color: rgba(255,255,255,.75);
      font-size: 13px;
    }
    .when{
      color: rgba(255,255,255,.45);
      font-size: 12px;
      white-space: nowrap;
    }
    .commentText{
      margin: 0;
      color: rgba(255,255,255,.86);
      line-height: 1.5;
      white-space: pre-wrap;
    }

    .empty{
      color: rgba(255,255,255,.55);
      padding: 10px 0;
      text-align:center;
    }

    .footer{
      margin-top: 18px;
      text-align:center;
      color: rgba(255,255,255,.55);
      font-size: 13px;
    }

    .mineBadge{
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0,255,153,.35);
      color: rgba(0,255,153,.95);
      background: rgba(0,255,153,.10);
      margin-left: 8px;
      font-weight: 800;
    }

    .formActions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      justify-content: space-between;
    }
    .smallBtn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 999px;
      padding: 10px 12px;
      font-weight: 800;
      cursor:pointer;
    }
    .smallBtn:hover{ border-color: rgba(0,255,153,.30); }
    .dangerBtn{
      border: 1px solid rgba(255,0,119,.35);
      background: rgba(255,0,119,.12);
      color: rgba(255,255,255,.92);
    }
    .dangerBtn:hover{ border-color: rgba(255,0,119,.55); }
  </style>
</head>

<body>
  <site-loader text="Loading..."></site-loader>
  <site-navbar cart-href="/cart" signin-href="https://unlim8ted.com/sign-in" profile-href="https://unlim8ted.com/profile"></site-navbar>

  <div class="page">
    <div class="topbar">
      <a class="back" href="#" onclick="history.back(); return false;">← Back</a>
      <h1 class="title">Product</h1>
      <div style="width:72px"></div>
    </div>

    <div class="grid">
      <!-- LEFT: product media + description -->
      <section class="card">
        <div class="card-inner">
          <div class="media">
            <div class="hero" id="hero"></div>
            <div class="thumbs" id="thumbs"></div>
          </div>

          <div class="product" style="margin-top:14px;">
            <h2 id="pName">Loading…</h2>
            <p class="desc" id="pDesc"></p>

            <div class="price-row">
              <div class="price" id="pPrice">$—</div>
              <div class="stars" id="avgStars" aria-label="Average rating stars"></div>
            </div>

            <div class="btns">
              <a class="btn secondary" id="buyBtn" href="#">Buy Now</a>
              <button class="btn" id="addBtn">Add to Cart</button>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT: ratings + comments -->
      <aside class="card">
        <div class="card-inner ratingBox">
          <div class="avgRow">
            <div class="avg">
              <div class="avgNum" id="avgNum">—</div>
              <div class="avgMeta">
                <div id="avgLabel">No ratings yet</div>
                <div id="countLabel">0 reviews</div>
              </div>
            </div>
            <div class="stars" id="avgStarsBig"></div>
          </div>

          <div class="bars" id="bars"></div>

          <div class="commentsCard">
            <h3>Reviews</h3>

            <div id="mustSignIn" class="empty" style="display:none;">
              Sign in to leave a review.
            </div>

            <form class="commentForm" id="commentForm" style="display:none;">
              <div class="row2">
                <div>
                  <label for="ratingSel">Rating</label>
                  <select id="ratingSel" required>
                    <option value="5">5 - Great</option>
                    <option value="4">4 - Good</option>
                    <option value="3">3 - Okay</option>
                    <option value="2">2 - Not great</option>
                    <option value="1">1 - Bad</option>
                  </select>
                </div>
                <div>
                  <label for="displayName">Name (optional)</label>
                  <input id="displayName" type="text" placeholder="Anonymous" />
                </div>
              </div>

              <div>
                <label for="commentText">Comment</label>
                <textarea id="commentText" placeholder="Write a review…" required></textarea>
              </div>

              <div class="formActions">
                <button class="btn" id="postBtn" type="submit">Post Review</button>
                <button class="smallBtn dangerBtn" id="deleteMyReviewBtn" type="button" style="display:none;">Delete my review</button>
              </div>

              <div id="formMsg" class="empty" style="text-align:left;"></div>
            </form>

            <div class="commentList" id="commentList"></div>
          </div>
        </div>
      </aside>
    </div>

    <div class="footer">
      <span id="footerText"></span>
    </div>
  </div>

<script type="module">
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import {
    collection, query, orderBy, onSnapshot, doc, setDoc, getDoc, deleteDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
  import { getFirebase } from "/components/firebase-init.js";

  const { auth, db } = getFirebase();
  const $ = (id) => document.getElementById(id);

  const hero = $("hero");
  const thumbs = $("thumbs");
  const pName = $("pName");
  const pDesc = $("pDesc");
  const pPrice = $("pPrice");
  const buyBtn = $("buyBtn");
  const addBtn = $("addBtn");

  const avgNum = $("avgNum");
  const avgLabel = $("avgLabel");
  const countLabel = $("countLabel");
  const avgStars = $("avgStars");
  const avgStarsBig = $("avgStarsBig");
  const bars = $("bars");

  const commentList = $("commentList");
  const commentForm = $("commentForm");
  const mustSignIn = $("mustSignIn");
  const ratingSel = $("ratingSel");
  const displayNameInput = $("displayName");
  const commentText = $("commentText");
  const formMsg = $("formMsg");
  const deleteMyReviewBtn = $("deleteMyReviewBtn");
  const postBtn = $("postBtn");

  const productId = (window.location.hash || "").replace("#", "").trim();

  // ----------------------------
  // Utils
  // ----------------------------
  function starsText(value) {
    const v = Math.max(0, Math.min(5, value));
    let out = "";
    for (let i = 1; i <= 5; i++) out += (i <= Math.round(v)) ? "★" : "☆";
    return out;
  }

  function toMoney(n) {
    if (typeof n !== "number" || Number.isNaN(n)) return "$—";
    return "$" + n.toFixed(2);
  }

  function extractYouTubeID(url) {
    const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|embed)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
    const m = (url || "").match(regex);
    return m ? m[1] : null;
  }

  function setHeroMedia(item) {
    hero.innerHTML = "";

    if (item.image) {
      const img = document.createElement("img");
      img.src = item.image;
      img.alt = item.name || "Product";
      hero.appendChild(img);
      return;
    }

    if (item.video) {
      if (item.video.includes("youtube.com") || item.video.includes("youtu.be")) {
        const id = extractYouTubeID(item.video);
        const iframe = document.createElement("iframe");
        iframe.src = `https://www.youtube.com/embed/${id}`;
        iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
        iframe.allowFullscreen = true;
        hero.appendChild(iframe);
      } else {
        const v = document.createElement("video");
        v.controls = true;
        v.src = item.video;
        hero.appendChild(v);
      }
    } else {
      hero.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;height:100%;color:rgba(255,255,255,.55);">No media</div>`;
    }
  }

  function buildThumbs(item) {
    thumbs.innerHTML = "";

    const sources = [];
    if (item.image) sources.push({ type: "img", src: item.image });
    (item.additional_images || []).forEach(src => sources.push({ type: "img", src }));
    if (item.video) sources.push({ type: "video", src: item.video });
    (item.additional_videos || []).forEach(src => sources.push({ type: "video", src }));

    sources.slice(0, 10).forEach(s => {
      const t = document.createElement("div");
      t.className = "thumb";

      if (s.type === "img") {
        const img = document.createElement("img");
        img.src = s.src;
        t.appendChild(img);

        t.addEventListener("click", () => {
          hero.innerHTML = "";
          const big = document.createElement("img");
          big.src = s.src;
          big.alt = item.name || "Product";
          hero.appendChild(big);
        });
      } else {
        t.innerHTML = `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,.75);font-weight:800;">▶</div>`;

        t.addEventListener("click", () => {
          hero.innerHTML = "";
          if (s.src.includes("youtube.com") || s.src.includes("youtu.be")) {
            const id = extractYouTubeID(s.src);
            const iframe = document.createElement("iframe");
            iframe.src = `https://www.youtube.com/embed/${id}`;
            iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
            iframe.allowFullscreen = true;
            hero.appendChild(iframe);
          } else {
            const v = document.createElement("video");
            v.controls = true;
            v.src = s.src;
            hero.appendChild(v);
          }
        });
      }

      thumbs.appendChild(t);
    });
  }

  async function loadProducts() {
    const r = await fetch("https://unlim8ted.com/tools/data/products.json", { cache: "no-store" });
    if (!r.ok) throw new Error("Failed to load products.json");
    return await r.json();
  }

  function renderBars(counts, total) {
    bars.innerHTML = "";
    for (let star = 5; star >= 1; star--) {
      const n = counts[star] || 0;
      const pct = total > 0 ? (n / total) * 100 : 0;

      const row = document.createElement("div");
      row.className = "barRow";

      const left = document.createElement("div");
      left.textContent = `${star} star`;

      const track = document.createElement("div");
      track.className = "barTrack";

      const fill = document.createElement("div");
      fill.className = "barFill";
      fill.style.width = `${pct.toFixed(1)}%`;

      const right = document.createElement("div");
      right.style.textAlign = "right";
      right.textContent = String(n);

      track.appendChild(fill);
      row.appendChild(left);
      row.appendChild(track);
      row.appendChild(right);
      bars.appendChild(row);
    }
  }

  function renderComments(docs, currentUid) {
    commentList.innerHTML = "";

    if (!docs.length) {
      const empty = document.createElement("div");
      empty.className = "empty";
      empty.textContent = "No reviews yet. Be the first.";
      commentList.appendChild(empty);
      return;
    }

    docs.forEach(d => {
      const data = d.data();
      const rating = Number(data.rating || 0);
      const text = (data.text || "").trim();
      const who = (data.displayName || "").trim() || "Anonymous";

      let when = "";
      const ts = data.createdAt;
      if (ts && typeof ts.toDate === "function") when = ts.toDate().toLocaleString();

      const el = document.createElement("div");
      el.className = "comment";

      const top = document.createElement("div");
      top.className = "commentTop";

      const whoEl = document.createElement("div");
      whoEl.className = "who";
      whoEl.style.color = "#ffcc66";
      whoEl.textContent = `${who} • ${starsText(rating)}`;

      if (currentUid && d.id === currentUid) {
        const badge = document.createElement("span");
        badge.className = "mineBadge";
        badge.textContent = "Yours";
        whoEl.appendChild(badge);
      }

      const whenEl = document.createElement("div");
      whenEl.className = "when";
      whenEl.textContent = when;

      const p = document.createElement("p");
      p.className = "commentText";
      p.textContent = text;

      top.appendChild(whoEl);
      top.appendChild(whenEl);

      el.appendChild(top);
      el.appendChild(p);

      commentList.appendChild(el);
    });
  }

  function toast(msg) {
    const t = document.createElement("div");
    t.textContent = msg;
    t.style.position = "fixed";
    t.style.right = "18px";
    t.style.bottom = "18px";
    t.style.padding = "12px 14px";
    t.style.borderRadius = "14px";
    t.style.background = "rgba(0,255,153,.92)";
    t.style.color = "#0b0b0f";
    t.style.fontWeight = "900";
    t.style.boxShadow = "0 12px 30px rgba(0,0,0,.35)";
    t.style.zIndex = "99999";
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 1600);
  }

  // Dispatch event so navbar/cart dropdown can refresh immediately
  function notifyCartChanged() {
    window.dispatchEvent(new CustomEvent("cart-changed"));
  }

  // --- CART: signed-in -> Firestore, signed-out -> localStorage fallback
  async function addToCart(item) {
    const user = auth.currentUser;

    if (user) {
      // put items under: users/{uid}/cartItems/{autoId}
      const cartItemRef = doc(collection(db, "users", user.uid, "cartItems"));
      await setDoc(cartItemRef, {
        productId: String(item.id),
        name: String(item.name || "").slice(0, 120),
        price: Number(item.price || 0),
        image: item.image ? String(item.image).slice(0, 600) : null,
        qty: 1,
        addedAt: serverTimestamp()
      });
      notifyCartChanged();
      return;
    }

    const key = "unlim8ted-cart";
    const existing = JSON.parse(localStorage.getItem(key) || "[]");
    existing.push({
      productId: String(item.id),
      name: String(item.name || "").slice(0, 120),
      price: Number(item.price || 0),
      image: item.image ? String(item.image).slice(0, 600) : null,
      qty: 1,
      addedAt: Date.now()
    });
    localStorage.setItem(key, JSON.stringify(existing));
    notifyCartChanged();
  }

  function setFormBusy(busy) {
    postBtn.disabled = busy;
    deleteMyReviewBtn.disabled = busy;
    ratingSel.disabled = busy;
    displayNameInput.disabled = busy;
    commentText.disabled = busy;
  }

  function showFormMessage(msg, isError=false) {
    formMsg.textContent = msg || "";
    formMsg.style.color = isError ? "rgba(255,120,120,.95)" : "rgba(255,255,255,.65)";
  }

  // ----------------------------
  // MAIN
  // ----------------------------
  if (!productId) {
    document.querySelector(".title").textContent = "Product Not Found";
    pName.textContent = "No product selected";
    pDesc.textContent = "Open a product using a URL like /product#some-id";
    addBtn.disabled = true;
  } else {
    const products = await loadProducts();
    const item = products.find(p => String(p.id) === String(productId));

    if (!item) {
      document.querySelector(".title").textContent = "Product Not Found";
      pName.textContent = "Product not found";
      pDesc.textContent = "That product ID doesn't exist in products.json.";
      addBtn.disabled = true;
    } else {
      document.querySelector(".title").textContent = item.name || "Product";
      pName.textContent = item.name || "Untitled";
      pDesc.textContent = item.description || "";
      pPrice.textContent = toMoney(item.price);
      buyBtn.href = `/buy#${encodeURIComponent(item.id)}`;

      setHeroMedia(item);
      buildThumbs(item);

      addBtn.addEventListener("click", async () => {
        try {
          await addToCart(item);
          toast("Added to cart");
        } catch (e) {
          console.error(e);
          toast("Could not add to cart");
        }
      });

      // -----------------------------------
      // COMMENTS LIVE QUERY
      // products/{productId}/comments
      // -----------------------------------
      const commentsRef = collection(db, "products", String(item.id), "comments");
      const commentsQ = query(commentsRef, orderBy("createdAt", "desc"));

      let currentUid = null;
      let myReviewCache = null; // store my review doc data for edit prefilling

      // Auth controls: show/hide review form + prefill if user's review exists
      onAuthStateChanged(auth, async (user) => {
        currentUid = user ? user.uid : null;

        if (user) {
          mustSignIn.style.display = "none";
          commentForm.style.display = "grid";

          // Try to load user's existing review doc (docId == uid)
          try {
            const myRef = doc(db, "products", String(item.id), "comments", user.uid);
            const mySnap = await getDoc(myRef);
            if (mySnap.exists()) {
              myReviewCache = mySnap.data();
              ratingSel.value = String(myReviewCache.rating || "5");
              displayNameInput.value = (myReviewCache.displayName || "").trim();
              commentText.value = (myReviewCache.text || "").trim();
              deleteMyReviewBtn.style.display = "inline-block";
              showFormMessage("Editing your review.");
            } else {
              myReviewCache = null;
              ratingSel.value = "5";
              displayNameInput.value = ""; // blank => Anonymous
              commentText.value = "";
              deleteMyReviewBtn.style.display = "none";
              showFormMessage("");
            }
          } catch (e) {
            console.error(e);
            myReviewCache = null;
            deleteMyReviewBtn.style.display = "none";
            showFormMessage("");
          }

        } else {
          myReviewCache = null;
          commentForm.style.display = "none";
          mustSignIn.style.display = "block";
          deleteMyReviewBtn.style.display = "none";
          showFormMessage("");
        }
      });

      // Live comments listener (for everyone)
      onSnapshot(
        commentsQ,
        (snap) => {
          const docs = snap.docs;

          // compute rating stats
          const total = docs.length;
          let sum = 0;
          const counts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };

          for (const d of docs) {
            const r = Number(d.data().rating || 0);
            if (r >= 1 && r <= 5) {
              sum += r;
              counts[r] = (counts[r] || 0) + 1;
            }
          }

          const avg = total ? (sum / total) : 0;

          avgNum.textContent = total ? avg.toFixed(1) : "—";
          avgLabel.textContent = total ? "Average rating" : "No ratings yet";
          countLabel.textContent = `${total} review${total === 1 ? "" : "s"}`;
          avgStars.textContent = starsText(avg);
          avgStarsBig.textContent = starsText(avg);

          renderBars(counts, total);
          renderComments(docs, currentUid);
        },
        (err) => {
          console.error("Comments listener error:", err);
          commentList.innerHTML = `<div class="empty">Reviews unavailable.</div>`;
        }
      );

      // Submit: create OR edit (same doc id = uid)
      commentForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const user = auth.currentUser;
        if (!user) return;

        const rating = parseInt(ratingSel.value, 10) || 0;
        const text = commentText.value.trim();

        // IMPORTANT: blank input => Anonymous (even if Firebase displayName exists)
        const raw = displayNameInput.value.trim();
        const finalName = raw ? raw : "Anonymous";

        if (!text) { showFormMessage("Please write a comment.", true); return; }
        if (text.length > 2000) { showFormMessage("Comment is too long (max 2000 chars).", true); return; }
        if (rating < 1 || rating > 5) { showFormMessage("Please select a rating 1–5.", true); return; }
        if (finalName.length > 80) { showFormMessage("Name too long (max 80 chars).", true); return; }

        showFormMessage("Saving…");
        setFormBusy(true);

        try {
          const myRef = doc(db, "products", String(item.id), "comments", user.uid);

          // If it exists, preserve createdAt (rules lock it). If new, set it.
          const createdAt = (myReviewCache && myReviewCache.createdAt) ? myReviewCache.createdAt : serverTimestamp();

          await setDoc(myRef, {
            userId: user.uid,
            rating,
            text,
            displayName: finalName,
            photoURL: user.photoURL || "",
            createdAt
          });

          // Refresh cache
          const snap = await getDoc(myRef);
          myReviewCache = snap.exists() ? snap.data() : null;

          deleteMyReviewBtn.style.display = myReviewCache ? "inline-block" : "none";
          showFormMessage("Saved");
          setTimeout(() => showFormMessage(myReviewCache ? "Editing your review." : ""), 900);
        } catch (err) {
          console.error(err);
          showFormMessage("Failed to save review.", true);
        } finally {
          setFormBusy(false);
        }
      });

      // Delete my review
      deleteMyReviewBtn.addEventListener("click", async () => {
        const user = auth.currentUser;
        if (!user) return;

        if (!confirm("Delete your review?")) return;

        showFormMessage("Deleting…");
        setFormBusy(true);

        try {
          const myRef = doc(db, "products", String(item.id), "comments", user.uid);
          await deleteDoc(myRef);

          myReviewCache = null;
          ratingSel.value = "5";
          displayNameInput.value = "";
          commentText.value = "";
          deleteMyReviewBtn.style.display = "none";
          showFormMessage("Deleted");
          setTimeout(() => showFormMessage(""), 900);
        } catch (err) {
          console.error(err);
          showFormMessage("Failed to delete.", true);
        } finally {
          setFormBusy(false);
        }
      });
    }
  }

  // footer
  const y = new Date().getFullYear();
  $("footerText").innerHTML = `&copy; 2019-${y} Unlim8ted Studio Productions. All rights reserved.`;
</script>

</body>
</html>
