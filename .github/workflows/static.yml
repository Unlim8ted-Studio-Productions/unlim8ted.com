name: Sync /assets and /services into their repos + publish /frontend to GitHub Pages (GitHub App auth)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: sync-assets-api-frontend
  cancel-in-progress: false

env:
  ASSETS_DIR: assets
  PUBLIC_API_DIR: services
  FRONTEND_DIR: frontend

  ASSETS_REPO: Unlim8ted-Studio-Productions/assets.unlim8ted.com
  API_REPO: Unlim8ted-Studio-Productions/services.unlim8ted.com
  TARGET_BRANCH: main

jobs:
  detect:
    name: Detect changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      assets_changed: ${{ steps.changes.outputs.assets_changed }}
      api_changed: ${{ steps.changes.outputs.api_changed }}
      frontend_changed: ${{ steps.changes.outputs.frontend_changed }}
    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed paths
        id: changes
        shell: bash
        run: |
          set -euo pipefail

          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          # workflow_dispatch doesn't always have a usable "before"
          if [ -z "${BEFORE}" ] || [ "${BEFORE}" = "0000000000000000000000000000000000000000" ]; then
            if git rev-parse "${AFTER}~1" >/dev/null 2>&1; then
              BEFORE="$(git rev-parse "${AFTER}~1")"
            else
              BEFORE="${AFTER}"
            fi
          fi

          echo "Diff range: $BEFORE..$AFTER"
          CHANGED="$(git diff --name-only "$BEFORE" "$AFTER" || true)"
          echo "$CHANGED" | sed 's/^/ - /' || true

          assets_changed=false
          api_changed=false
          frontend_changed=false

          if echo "$CHANGED" | grep -qE '^assets/'; then
            assets_changed=true
          fi

          # folder is literally "services" (space)
          if echo "$CHANGED" | grep -qE '^services/'; then
            api_changed=true
          fi

          if echo "$CHANGED" | grep -qE '^frontend/'; then
            frontend_changed=true
          fi

          echo "assets_changed=$assets_changed"   | tee -a "$GITHUB_OUTPUT"
          echo "api_changed=$api_changed"         | tee -a "$GITHUB_OUTPUT"
          echo "frontend_changed=$frontend_changed" | tee -a "$GITHUB_OUTPUT"

  sync:
    name: Sync assets + services
    runs-on: ubuntu-latest
    needs: [detect]
    if: needs.detect.outputs.assets_changed == 'true' || needs.detect.outputs.api_changed == 'true'
    permissions:
      contents: write
    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Configure git identity
        shell: bash
        run: |
          set -euo pipefail
          git config --global user.name  "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Validate GitHub App inputs (fail fast)
        shell: bash
        env:
          GH_APP_ID: ${{ vars.GH_APP_ID }}
          GH_APP_PRIVATE_KEY: ${{ secrets.GH_APP_PRIVATE_KEY }}
        run: |
          set -euo pipefail

          if [ -z "${GH_APP_ID:-}" ]; then
            echo "ERROR: vars.GH_APP_ID is not set (your GitHub App ID)."
            exit 1
          fi

          if [ -z "${GH_APP_PRIVATE_KEY:-}" ]; then
            echo "ERROR: secrets.GH_APP_PRIVATE_KEY is not set (GitHub App private key PEM)."
            exit 1
          fi

          if ! [[ "${GH_APP_ID}" =~ ^[0-9]+$ ]]; then
            echo "ERROR: vars.GH_APP_ID must be numeric. Got: '${GH_APP_ID}'"
            exit 1
          fi

          echo "App inputs look present."

      - name: Create GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
          owner: Unlim8ted-Studio-Productions
          repositories: |
            assets.unlim8ted.com
            api.unlim8ted.com

      - name: Fail if any file > 95MB in assets or services (only when needed)
        shell: bash
        run: |
          set -euo pipefail
          THRESHOLD_BYTES=$((95 * 1024 * 1024))
          echo "Checking for files over $THRESHOLD_BYTES bytes..."

          check_dir () {
            local DIR="$1"
            if [ -d "$DIR" ]; then
              BIG="$(find "$DIR" -type f -printf '%s %p\n' | awk -v t="$THRESHOLD_BYTES" '$1>t{print}')"
              if [ -n "$BIG" ]; then
                echo "ERROR: Found files too large for a normal git push in '$DIR':"
                echo "$BIG"
                exit 1
              fi
            fi
          }

          if [ "${{ needs.detect.outputs.assets_changed }}" = "true" ]; then
            check_dir "${ASSETS_DIR}"
          fi
          if [ "${{ needs.detect.outputs.api_changed }}" = "true" ]; then
            check_dir "${PUBLIC_API_DIR}"
          fi

      - name: Sync assets repo (only if assets changed)
        if: needs.detect.outputs.assets_changed == 'true'
        shell: bash
        env:
          GH_APP_TOKEN: ${{ steps.app-token.outputs.token }}
          REPO: ${{ env.ASSETS_REPO }}
          BRANCH: ${{ env.TARGET_BRANCH }}
          SRC_DIR: ${{ env.ASSETS_DIR }}
        run: |
          set -euo pipefail
          export GIT_TERMINAL_PROMPT=0

          SRC_PATH="${GITHUB_WORKSPACE}/${SRC_DIR}"
          if [ ! -d "${SRC_PATH}" ]; then
            echo "Source folder not found: ${SRC_PATH}" >&2
            exit 1
          fi

          WORKDIR="$(mktemp -d)"
          echo "Workdir (assets): $WORKDIR"
          PUSH_URL="https://x-access-token:${GH_APP_TOKEN}@github.com/${REPO}.git"

          git clone --branch "${BRANCH}" --depth 1 "${PUSH_URL}" "${WORKDIR}/repo"
          test -d "${WORKDIR}/repo/.git"

          rsync -a --delete \
            --exclude='.git/' \
            --exclude='.github/' \
            "${SRC_PATH}/" "${WORKDIR}/repo/"

          git -C "${WORKDIR}/repo" add -A
          if git -C "${WORKDIR}/repo" diff --cached --quiet; then
            echo "No changes to push to ${REPO}."
            rm -rf "$WORKDIR"
            exit 0
          fi

          git -C "${WORKDIR}/repo" commit -m "Deploy assets from unlim8ted.com (${GITHUB_SHA})"
          git -C "${WORKDIR}/repo" push "${PUSH_URL}" "HEAD:${BRANCH}"
          rm -rf "$WORKDIR"

      - name: Sync services repo (only if services changed)
        if: needs.detect.outputs.api_changed == 'true'
        shell: bash
        env:
          GH_APP_TOKEN: ${{ steps.app-token.outputs.token }}
          REPO: ${{ env.API_REPO }}
          BRANCH: ${{ env.TARGET_BRANCH }}
          SRC_DIR: ${{ env.PUBLIC_API_DIR }}
        run: |
          set -euo pipefail
          export GIT_TERMINAL_PROMPT=0

          SRC_PATH="${GITHUB_WORKSPACE}/${SRC_DIR}"
          if [ ! -d "${SRC_PATH}" ]; then
            echo "Source folder not found: ${SRC_PATH}" >&2
            exit 1
          fi

          WORKDIR="$(mktemp -d)"
          echo "Workdir (services): $WORKDIR"
          PUSH_URL="https://x-access-token:${GH_APP_TOKEN}@github.com/${REPO}.git"

          git clone --branch "${BRANCH}" --depth 1 "${PUSH_URL}" "${WORKDIR}/repo"
          test -d "${WORKDIR}/repo/.git"

          rsync -a --delete \
            --exclude='.git/' \
            --exclude='.github/' \
            "${SRC_PATH}/" "${WORKDIR}/repo/"

          git -C "${WORKDIR}/repo" add -A
          if git -C "${WORKDIR}/repo" diff --cached --quiet; then
            echo "No changes to push to ${REPO}."
            rm -rf "$WORKDIR"
            exit 0
          fi

          git -C "${WORKDIR}/repo" commit -m "Deploy services from unlim8ted.com (${GITHUB_SHA})"
          git -C "${WORKDIR}/repo" push "${PUSH_URL}" "HEAD:${BRANCH}"
          rm -rf "$WORKDIR"

  deploy_pages:
    name: Deploy frontend to GitHub Pages
    runs-on: ubuntu-latest
    needs: [detect]
    if: needs.detect.outputs.frontend_changed == 'true'
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Prepend snippet as the first thing in every HTML file *inside frontend/*
      - name: Prepend snippet to frontend HTML files
        shell: bash
        run: |
          set -euo pipefail

          OUT_DIR="${{ env.FRONTEND_DIR }}"
          SNIP_FILE="frontend/components/deploy-inject/head-snippet.html"
          MARK="<!--__INJECTED_FILE_PREFIX__-->"

          if [ ! -d "$OUT_DIR" ]; then
            echo "Frontend folder not found: $OUT_DIR" >&2
            exit 1
          fi

          if [ ! -f "$SNIP_FILE" ]; then
            echo "Snippet file not found: $SNIP_FILE" >&2
            exit 1
          fi

          SNIP="$(cat "$SNIP_FILE")"

          find "$OUT_DIR" -type f -name "*.html" -print0 | while IFS= read -r -d '' f; do
            if grep -qF "$MARK" "$f"; then
              echo "Already injected: $f"
              continue
            fi

            tmp="$(mktemp)"
            {
              printf '%s\n' "$MARK"
              printf '%s\n' "$SNIP"
              cat "$f"
            } > "$tmp"

            mv "$tmp" "$f"
            echo "Injected: $f"
          done

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "${{ env.FRONTEND_DIR }}"

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
