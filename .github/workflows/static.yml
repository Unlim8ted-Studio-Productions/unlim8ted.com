name: Deploy unlim8ted.com + update subdomain repos

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  # Source folders in THIS repo
  FRONTEND_DIR: "frontend"
  ASSETS_DIR: "assets"
  PUBLIC_API_DIR: "public api"

  # Injection snippet (only applied to frontend HTML)
  SNIP_FILE: "frontend/components/deploy-inject/head-snippet.html"
  MARK: "<!--__INJECTED_FILE_PREFIX__-->"

  # Target repos for subdomains
  ASSETS_REPO: "Unlim8ted-Studio-Productions/assets.unlim8ted.com"
  API_REPO: "Unlim8ted-Studio-Productions/api.unlim8ted.com"
  TARGET_BRANCH: "main"

jobs:
  deploy_main_site:
    name: Deploy unlim8ted.com (from /frontend, with injection)
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: https://unlim8ted.com

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare dist (frontend only)
        shell: bash
        run: |
          set -euo pipefail
          rm -rf dist
          mkdir -p dist/frontend
          rsync -a --delete "${FRONTEND_DIR}/" "dist/frontend/"

      - name: Prepend snippet to frontend HTML files ONLY
        shell: bash
        run: |
          set -euo pipefail

          OUT_DIR="dist/frontend"
          SNIP_PATH="${SNIP_FILE}"
          MARK="${MARK}"

          if [ ! -f "$SNIP_PATH" ]; then
            echo "Snippet file not found: $SNIP_PATH" >&2
            exit 1
          fi

          SNIP="$(cat "$SNIP_PATH")"
          SNIP_DIST_PATH="dist/frontend/components/deploy-inject/head-snippet.html"

          find "$OUT_DIR" -type f -name "*.html" -print0 | while IFS= read -r -d '' f; do
            # Skip the snippet file itself
            if [ "$f" = "$SNIP_DIST_PATH" ]; then
              continue
            fi

            # Prevent double injection
            if grep -qF "$MARK" "$f"; then
              echo "Already injected: $f"
              continue
            fi

            tmp="$(mktemp)"
            {
              printf '%s\n' "$MARK"
              printf '%s\n' "$SNIP"
              cat "$f"
            } > "$tmp"
            mv "$tmp" "$f"
            echo "Injected: $f"
          done

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "dist/frontend"

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

  update_subdomain_repos:
    name: Sync /assets and /public api into their repos (GitHub App auth)
    runs-on: ubuntu-latest
    needs: [deploy_main_site]
    permissions:
      contents: write   # must be write to allow pushes

    # Prevent simultaneous runs fighting each other
    concurrency:
      group: "sync-subdomain-repos"
      cancel-in-progress: true

    steps:
      - name: Checkout THIS repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Configure git identity
        shell: bash
        run: |
          set -euo pipefail
          git config --global user.name  "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create GitHub App token (cross-repo pushes)
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
          owner: ${{ vars.GH_APP_OWNER }}

      # ----------------------------
      # Mirror /assets -> assets.unlim8ted.com (deployment mirror)
      # ----------------------------
      - name: Sync assets.unlim8ted.com
        shell: bash
        env:
          GH_APP_TOKEN: ${{ steps.app-token.outputs.token }}
          REPO: ${{ env.ASSETS_REPO }}
          BRANCH: ${{ env.TARGET_BRANCH }}
          SRC_DIR: ${{ env.ASSETS_DIR }}
          DEST_PATH: target-assets
          COMMIT_MSG: Deploy assets from unlim8ted.com
        run: |
          set -euo pipefail
          export GIT_TERMINAL_PROMPT=0

          PUSH_URL="https://x-access-token:${GH_APP_TOKEN}@github.com/${REPO}.git"
          SRC_PATH="${GITHUB_WORKSPACE}/${SRC_DIR}"

          if [ ! -d "${SRC_PATH}" ]; then
            echo "Source folder not found: ${SRC_PATH}" >&2
            ls -la "${GITHUB_WORKSPACE}"
            exit 1
          fi

          rm -rf "${DEST_PATH}"

          # Install git-lfs (best-effort; migrating history to LFS is separate)
          git lfs install || true

          # Clone without shallow depth to avoid pack/index issues on push
          git clone --branch "${BRANCH}" "${PUSH_URL}" "${DEST_PATH}"

          (
            cd "${DEST_PATH}"

            # Ensure we are on the branch and match remote
            git fetch origin "${BRANCH}"
            git checkout "${BRANCH}"
            git reset --hard "origin/${BRANCH}"
            git clean -fdx

            # Helpful git settings for large transfers
            git config http.postBuffer 524288000
            git config --local core.compression 0 || true
            git config --local pack.windowMemory 100m || true

            rsync -a --delete "${SRC_PATH}/" "./"

            if git status --porcelain | grep -q .; then
              git add -A
              git commit -m "${COMMIT_MSG} (${GITHUB_SHA})"

              # Repack/gc to create optimized pack to send to remote
              git repack -a -d -f --window=250 --max-pack-size=20m || true
              git gc --aggressive --prune=now || true

              # Retry push (helps with transient remote index-pack failures)
              set +e
              PUSH_SUCCESS=1
              for i in 1 2 3; do
                echo "Attempt $i: pushing to ${REPO}..."
                git push --force "${PUSH_URL}" "HEAD:${BRANCH}" && { PUSH_SUCCESS=0; break; }
                echo "Push failed, running git gc and retrying..."
                git repack -a -d -f --window=250 --max-pack-size=20m || true
                git gc --aggressive --prune=now || true
                sleep 5
              done
              set -e

              if [ "${PUSH_SUCCESS}" -ne 0 ]; then
                echo "Failed to push to ${REPO} after retries." >&2
                exit 1
              fi
            else
              echo "No changes to push to ${REPO}."
            fi
          )

      # ----------------------------
      # Mirror /public api -> api.unlim8ted.com (deployment mirror)
      # ----------------------------
      - name: Sync api.unlim8ted.com
        shell: bash
        env:
          GH_APP_TOKEN: ${{ steps.app-token.outputs.token }}
          REPO: ${{ env.API_REPO }}
          BRANCH: ${{ env.TARGET_BRANCH }}
          SRC_DIR: ${{ env.PUBLIC_API_DIR }}
          DEST_PATH: target-api
          COMMIT_MSG: Deploy public api from unlim8ted.com
        run: |
          set -euo pipefail
          export GIT_TERMINAL_PROMPT=0

          PUSH_URL="https://x-access-token:${GH_APP_TOKEN}@github.com/${REPO}.git"
          SRC_PATH="${GITHUB_WORKSPACE}/${SRC_DIR}"

          if [ ! -d "${SRC_PATH}" ]; then
            echo "Source folder not found: ${SRC_PATH}" >&2
            ls -la "${GITHUB_WORKSPACE}"
            exit 1
          fi

          rm -rf "${DEST_PATH}"

          git lfs install || true
          git clone --branch "${BRANCH}" "${PUSH_URL}" "${DEST_PATH}"

          (
            cd "${DEST_PATH}"

            git fetch origin "${BRANCH}"
            git checkout "${BRANCH}"
            git reset --hard "origin/${BRANCH}"
            git clean -fdx

            git config http.postBuffer 524288000
            git config --local core.compression 0 || true
            git config --local pack.windowMemory 100m || true

            rsync -a --delete "${SRC_PATH}/" "./"

            if git status --porcelain | grep -q .; then
              git add -A
              git commit -m "${COMMIT_MSG} (${GITHUB_SHA})"

              git repack -a -d -f --window=250 --max-pack-size=20m || true
              git gc --aggressive --prune=now || true

              set +e
              PUSH_SUCCESS=1
              for i in 1 2 3; do
                echo "Attempt $i: pushing to ${REPO}..."
                git push --force "${PUSH_URL}" "HEAD:${BRANCH}" && { PUSH_SUCCESS=0; break; }
                echo "Push failed, running git gc and retrying..."
                git repack -a -d -f --window=250 --max-pack-size=20m || true
                git gc --aggressive --prune=now || true
                sleep 5
              done
              set -e

              if [ "${PUSH_SUCCESS}" -ne 0 ]; then
                echo "Failed to push to ${REPO} after retries." >&2
                exit 1
              fi
            else
              echo "No changes to push to ${REPO}."
            fi
          )
