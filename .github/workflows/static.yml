# .github/workflows/sync-assets-and-public-api.yml
name: Sync /assets and /public api into their repos (GitHub App auth)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: sync-assets-api
  cancel-in-progress: false

env:
  ASSETS_DIR: assets
  PUBLIC_API_DIR: public api

  ASSETS_REPO: Unlim8ted-Studio-Productions/assets.unlim8ted.com
  API_REPO: Unlim8ted-Studio-Productions/api.unlim8ted.com
  TARGET_BRANCH: main

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 1

      - name: Configure git identity
        shell: bash
        run: |
          set -euo pipefail
          git config --global user.name  "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # Put these in repo/org secrets:
      # - GH_APP_ID
      # - GH_APP_PRIVATE_KEY
      - name: Create GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
          owner: Unlim8ted-Studio-Productions

      - name: Fail if any file > 95MB in assets or public api
        shell: bash
        run: |
          set -euo pipefail
          THRESHOLD_BYTES=$((95 * 1024 * 1024))
          echo "Checking for files over $THRESHOLD_BYTES bytes..."
          for DIR in "${ASSETS_DIR}" "${PUBLIC_API_DIR}"; do
            if [ -d "$DIR" ]; then
              BIG="$(find "$DIR" -type f -printf '%s %p\n' | awk -v t="$THRESHOLD_BYTES" '$1>t{print}')"
              if [ -n "$BIG" ]; then
                echo "ERROR: Found files too large for a normal git push:"
                echo "$BIG"
                exit 1
              fi
            fi
          done

      - name: Sync assets + public api into their repos
        shell: bash
        env:
          GH_APP_TOKEN: ${{ steps.app-token.outputs.token }}
          ASSETS_REPO: ${{ env.ASSETS_REPO }}
          API_REPO: ${{ env.API_REPO }}
          BRANCH: ${{ env.TARGET_BRANCH }}
          ASSETS_DIR: ${{ env.ASSETS_DIR }}
          PUBLIC_API_DIR: ${{ env.PUBLIC_API_DIR }}
        run: |
          set -euo pipefail
          export GIT_TERMINAL_PROMPT=0

          sync_dir_to_repo () {
            local SRC_DIR="$1"
            local REPO="$2"
            local LABEL="$3"

            local SRC_PATH="${GITHUB_WORKSPACE}/${SRC_DIR}"
            if [ ! -d "${SRC_PATH}" ]; then
              echo "Source folder not found: ${SRC_PATH}" >&2
              ls -la "${GITHUB_WORKSPACE}"
              exit 1
            fi

            local WORKDIR
            WORKDIR="$(mktemp -d)"
            echo "Workdir (${LABEL}): $WORKDIR"

            # Clean up on return from function
            # shellcheck disable=SC2064
            trap "rm -rf \"$WORKDIR\"" RETURN

            local PUSH_URL="https://x-access-token:${GH_APP_TOKEN}@github.com/${REPO}.git"

            git clone --branch "${BRANCH}" --depth 1 "${PUSH_URL}" "${WORKDIR}/repo"

            # sanity: ensure .git exists
            if [ ! -d "${WORKDIR}/repo/.git" ]; then
              echo "ERROR: Clone did not produce a git repo at ${WORKDIR}/repo" >&2
              ls -la "${WORKDIR}/repo" || true
              exit 1
            fi

            # Ensure clean branch state
            git -C "${WORKDIR}/repo" fetch origin "${BRANCH}"
            git -C "${WORKDIR}/repo" checkout "${BRANCH}"
            git -C "${WORKDIR}/repo" reset --hard "origin/${BRANCH}"
            git -C "${WORKDIR}/repo" clean -fdx

            # Mirror content into repo root WITHOUT nuking .git (or .github if you keep workflows in target repos)
            rsync -a --delete \
              --exclude='.git/' \
              --exclude='.github/' \
              "${SRC_PATH}/" "${WORKDIR}/repo/"

            # Commit + push only if changed (robust; no command-substitution gotchas)
            if git -C "${WORKDIR}/repo" diff --quiet && git -C "${WORKDIR}/repo" diff --cached --quiet; then
              echo "No changes to push to ${REPO}."
              return 0
            fi

            # Stage and see if staging actually produces changes
            git -C "${WORKDIR}/repo" add -A
            if git -C "${WORKDIR}/repo" diff --cached --quiet; then
              echo "No staged changes after add; nothing to push to ${REPO}."
              return 0
            fi

            git -C "${WORKDIR}/repo" commit -m "Deploy ${LABEL} from unlim8ted.com (${GITHUB_SHA})"

            for i in 1 2 3; do
              echo "Attempt $i: pushing ${REPO}@${BRANCH}..."
              if git -C "${WORKDIR}/repo" push "${PUSH_URL}" "HEAD:${BRANCH}"; then
                echo "Pushed successfully."
                return 0
              fi
              echo "Push failed; retrying..."
              sleep 5
            done

            echo "Failed to push to ${REPO} after retries." >&2
            return 1
          }

          sync_dir_to_repo "${ASSETS_DIR}"     "${ASSETS_REPO}" "assets"
          sync_dir_to_repo "${PUBLIC_API_DIR}" "${API_REPO}"    "public api"
