<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WiseSize — Merchant Dashboard</title>

  <meta name="robots" content="noindex,nofollow" />
  <meta name="referrer" content="strict-origin-when-cross-origin" />

  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    img-src 'self' data: https:;
    style-src 'self' 'unsafe-inline';
    script-src 'self' https://www.gstatic.com 'unsafe-inline';
    connect-src 'self' https:;">

  <style>
    :root{
      --bg:#0b0c10;
      --panel: rgba(20, 22, 28, .92);
      --card: rgba(255,255,255,.05);
      --border: rgba(255,255,255,.12);
      --muted: rgba(255,255,255,.72);

      --field: rgba(255,255,255,.06);
      --field2: rgba(255,255,255,.08);
      --focus: rgba(255,255,255,.28);

      --good: #4ade80;
      --warn: #fbbf24;
      --bad:  #fb7185;

      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{ box-sizing:border-box; }
    html{ color-scheme: dark; }
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(255,255,255,.06), transparent 55%),
        radial-gradient(900px 550px at 90% 0%, rgba(255,255,255,.04), transparent 60%),
        var(--bg);
      color:#e8e8ea;
    }
    a{ color:#e8e8ea; }

    .topbar{
      position: sticky; top: 0; z-index: 20;
      display:flex; align-items:center; gap:14px;
      padding:14px 16px;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(10px);
    }
    .brand{ font-weight: 950; letter-spacing: .35px; }
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; }

    .tab{
      cursor:pointer;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.07);
      color:#fff;
      padding:8px 10px;
      font-weight: 900;
      font-size: 13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .tab.active{ background:#fff; color:#000; }
    .tab[disabled]{ opacity:.45; cursor:not-allowed; }

    .auth{
      margin-left:auto;
      display:flex;
      gap:10px;
      align-items:center;
    }

    .container{ max-width: min(1600px, calc(100vw - 32px)); margin:0 auto; padding:18px 16px; }
    .grid{ display:grid; grid-template-columns: 1.25fr 1fr; gap:16px; }
    @media (min-width: 1400px){ .grid{ grid-template-columns: 1.35fr 1fr; } }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.045);
      border-radius: 16px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }

    h1{ margin:0 0 10px; font-size: 20px; }
    h2{ margin:0 0 8px; font-size: 16px; }

    .muted{ color: var(--muted); font-size: 12px; line-height: 1.35; }
    .row{ display:grid; gap:8px; margin:10px 0; }
    label{ font-size: 12.5px; opacity: .92; }

    input, textarea, select, button{
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--field);
      color:#fff;
      padding:10px 12px;
      font-size: 14px;
      outline: none;
      transition: border-color .12s ease, background .12s ease, transform .04s ease;
    }
    input::placeholder, textarea::placeholder{ color: rgba(255,255,255,.45); }
    input:focus, textarea:focus, select:focus{ border-color: var(--focus); background: var(--field2); }
    textarea{ width:100%; }

    button{ cursor:pointer; font-weight: 900; background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.16); }
    button:hover{ background: rgba(255,255,255,.13); }
    button:active{ transform: translateY(1px); }
    button.primary{ background:#fff; color:#000; border-color: rgba(255,255,255,.35); }
    button.primary:hover{ opacity: .93; }
    button.ghost{ background: transparent; }
    button:disabled{ opacity:.6; cursor:not-allowed; }

    select{
      appearance:none;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(255,255,255,.65) 50%),
        linear-gradient(135deg, rgba(255,255,255,.65) 50%, transparent 50%);
      background-position:
        calc(100% - 18px) calc(1em + 2px),
        calc(100% - 13px) calc(1em + 2px);
      background-size: 5px 5px, 5px 5px;
      background-repeat: no-repeat;
      padding-right: 36px;
    }
    select option{ background:#0f1116; color:#e8e8ea; }

    hr{ border:none; border-top:1px solid var(--border); margin:12px 0; }

    .notice{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding:10px;
    }

    .pills{ display:flex; gap:8px; flex-wrap:wrap; margin-top: 6px; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-size: 12px;
    }
    .pill.good{ border-color: rgba(74,222,128,.35); }
    .pill.warn{ border-color: rgba(251,191,36,.35); }
    .pill.bad{ border-color: rgba(251,113,133,.35); }

    .list{ display:grid; gap:10px; }
    .item{ border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); border-radius:14px; padding:12px; }
    .itemTop{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
    .itemTitle{ font-weight: 950; }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .inline{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:end; }
    .control{ min-width:200px; flex:1; }

    .code{
      margin-top:10px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      padding:10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      white-space: pre-wrap;
      overflow:auto;
    }

    .progressWrap{
      margin-top:10px;
      height:10px;
      background: rgba(255,255,255,.06);
      border-radius: 999px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
    }
    .progressBar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(255,255,255,.92), rgba(255,255,255,.75));
    }

    .route{ display:none; }
    .route.active{ display:block; }

    .kpiGrid{ display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap:10px; }
    .kpi{ border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); border-radius:14px; padding:10px; }
    .kpi .n{ font-size:20px; font-weight: 950; }
    .kpi .t{ font-size:12px; color: var(--muted); }
    @media (max-width: 980px){ .kpiGrid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }

    /* Drawer */
    .drawerBack{
      position:fixed; inset:0; z-index:50;
      background: rgba(0,0,0,.55);
      display:none;
      padding:16px;
    }
    .drawerBack.show{ display:flex; justify-content:flex-end; }
    .drawer{
      width:min(720px, 100%);
      height:100%;
      background:#0f1116;
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      overflow:auto;
      box-shadow: 0 20px 70px rgba(0,0,0,.45);
    }
    .drawerHead{
      position:sticky; top:0;
      background: rgba(15,17,22,.94);
      border-bottom: 1px solid rgba(255,255,255,.10);
      padding:12px 12px;
      display:flex; align-items:center; gap:10px;
    }
    .drawerBody{ padding:12px; }

    /* Table */
    .table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow:hidden;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
    }
    .table th, .table td{
      padding:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      border-right:1px solid rgba(255,255,255,.08);
      font-size:13px;
    }
    .table th{ text-align:left; background: rgba(255,255,255,.06); border-bottom:1px solid rgba(255,255,255,.10); }
    .table tr:last-child td{ border-bottom:none; }
    .table th:last-child, .table td:last-child{ border-right:none; }

    /* Horizontal size pills */
    .sizesRow{ display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; }
    .sizePill{
      padding:6px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      font-size:13px;
      font-weight:800;
      user-select:none;
      transition: all .15s ease;
    }
    .sizePill:hover{ background: rgba(255,255,255,.12); }
    .sizePill.active{ background:#fff; color:#000; border-color: rgba(255,255,255,.45); }

    .pillActions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
    .pillActions button{ padding:7px 10px; border-radius:999px; font-size:12px; }

    /* Toast */
    .toastWrap{
      position:fixed; right:16px; bottom:16px; z-index:999;
      display:grid; gap:10px;
      max-width: min(520px, calc(100vw - 32px));
    }
    .toast{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(15,17,22,.96);
      border-radius: 14px;
      padding:10px 12px;
      box-shadow: 0 20px 70px rgba(0,0,0,.45);
    }
    .toast .t{ font-weight: 950; }
    .toast .d{ margin-top:4px; color: var(--muted); font-size:12px; line-height:1.35; }

    /* Stepper */
    .stepper{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .step{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-size:12px; font-weight:900;
    }
    .step.active{ background:#fff; color:#000; border-color: rgba(255,255,255,.35); }
    .step.done{ border-color: rgba(74,222,128,.35); }
    .step small{ font-weight:800; opacity:.85; }
    .stepPane{ display:none; }
    .stepPane.active{ display:block; }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">WiseSize</div>

    <div class="tabs" id="tabs" role="tablist" aria-label="Dashboard tabs">
      <button class="tab active" data-route="onboarding" role="tab" aria-selected="true">Onboarding</button>
      <button class="tab" data-route="items" role="tab">Items</button>
      <button class="tab" data-route="usage" role="tab">Usage</button>
      <button class="tab" data-route="docs" role="tab">Docs</button>
      <button class="tab" data-route="settings" role="tab">Settings</button>
    </div>

    <div class="auth">
      <span id="authState" class="muted" aria-live="polite"></span>
      <button id="btnSignIn">Sign in</button>
      <button id="btnSignOut" style="display:none;">Sign out</button>
    </div>
  </div>

  <div class="container">
    <!-- ONBOARDING (step-based) -->
    <section class="route active" id="route-onboarding">
      <div class="grid">
        <div class="card">
          <h1>Onboarding</h1>
          <div class="muted">
            We only ask for what’s needed to unlock the dashboard:
            <ul>
              <li>Step 1: Store profile</li>
              <li>Step 2: Verify your website</li>
              <li>Step 3: Done</li>
            </ul>
          </div>

          <div class="notice" style="margin-top:12px;">
            <div style="font-weight:950; margin-bottom:6px;">Setup status</div>
            <div class="pills" id="setupPills"></div>
            <div class="progressWrap">
              <div class="progressBar" id="setupProgress"></div>
            </div>
            <div id="setupMsg" class="muted" style="margin-top:8px;"></div>
          </div>

          <div class="stepper" id="onboardingSteps" aria-label="Onboarding steps" style="margin-top:12px;">
            <div class="step active" data-step="1"><small>1</small> Profile</div>
            <div class="step" data-step="2"><small>2</small> Verify website</div>
            <div class="step" data-step="3"><small>3</small> Done</div>
          </div>

          <hr />

          <!-- STEP 1 -->
          <div class="stepPane active" id="step-1">
            <h2>Step 1 — Store profile</h2>

            <div class="row">
              <label for="settingsName">Store name</label>
              <input id="settingsName" placeholder="Your store name" />
            </div>

            <div class="row">
              <label for="settingsWebsite">Website</label>
              <input id="settingsWebsite" placeholder="https://example.com" inputmode="url" />
            </div>

            <div class="actions">
              <button id="btnSaveMerchant" class="primary">Save profile</button>
              <button id="btnNextToVerify">Next</button>
            </div>
            <div id="merchantMsg" class="muted" style="margin-top:10px" aria-live="polite"></div>

            <div class="muted" style="margin-top:10px;">
              Tip: Use your canonical domain (no trailing slash).
            </div>
          </div>

          <!-- STEP 2 -->
          <div class="stepPane" id="step-2">
            <h2>Step 2 — Verify website ownership</h2>

            <div class="row">
              <label for="verifyWebsite">Website to verify</label>
              <input id="verifyWebsite" placeholder="https://example.com" inputmode="url" />
              <div class="muted">Defaults to the website from your profile.</div>
            </div>

            <div class="row">
              <label for="verifyMethod">Verification method</label>
              <select id="verifyMethod">
                <option value="dns" selected>DNS TXT record (recommended)</option>
                <option value="wellknown">HTTP file: /.well-known/wisesize-verification.txt</option>
              </select>
            </div>

            <div class="actions">
              <button id="btnStartVerify">Start verification</button>
              <button id="btnCheckVerify" class="primary">Check verification</button>
              <button id="btnBackToProfile" class="ghost">Back</button>
            </div>

            <div id="verifyBox" class="notice" style="display:none; margin-top:10px;">
              <div style="font-weight:950; margin-bottom:6px;">Instructions</div>
              <div id="verifyInstructions" class="muted"></div>
              <div class="actions" style="margin-top:8px;">
                <button id="btnCopyVerifyToken">Copy token</button>
              </div>
              <div id="verifyTokenLabel" class="code"></div>
              <div id="verifyState" class="muted" style="margin-top:8px;"></div>
            </div>

            <div class="muted" style="margin-top:10px;">
              When verified, we unlock Items/Usage/Docs automatically.
            </div>
          </div>

          <!-- STEP 3 -->
          <div class="stepPane" id="step-3">
            <h2>Step 3 — Done</h2>
            <div class="notice">
              <div style="font-weight:950">You’re verified ✓</div>
              <div class="muted" style="margin-top:6px;">
                You can now submit items and embed WiseSize on your product pages.
              </div>

              <div class="actions" style="margin-top:10px;">
                <button id="btnContinue" class="primary">Go to Items</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <h1>Embed snippet preview</h1>
          <div class="muted">Per item you’ll copy something like this:</div>
          <div class="code" id="docsEmbedSnippet"></div>

          <hr />

          <h2>Security notes</h2>
          <div class="muted">
            This dashboard is <b>noindex</b>. Access is gated by Firebase Auth + server-side website verification.
          </div>
        </div>
      </div>
    </section>

    <!-- ITEMS -->
    <section class="route" id="route-items">
      <div class="grid">
        <div class="card">
          <h1>Submit a product</h1>
          <div class="muted">Build a chart below (recommended). JSON is auto-generated.</div>

          <div class="row">
            <label for="itemBrand">Brand</label>
            <input id="itemBrand" placeholder="Brand" autocomplete="organization" />
          </div>

          <div class="row">
            <label for="itemName">Product name</label>
            <input id="itemName" placeholder="Product name" autocomplete="off" />
          </div>

          <div class="row">
            <label for="itemCategory">Category</label>
            <select id="itemCategory">
              <option value="top">Top</option>
              <option value="bottom">Bottom</option>
              <option value="outerwear">Outerwear</option>
              <option value="dress">Dress</option>
            </select>
          </div>

          <div class="row">
            <label for="chartType">Chart represents</label>
            <select id="chartType">
              <option value="body" selected>Body measurements (recommended sizing chart)</option>
              <option value="garment">Garment measurements (flat-lay product measurements)</option>
            </select>
            <div class="muted">Body chart uses min/max ranges. Garment chart uses value ± tolerance (stored as min/max).</div>
          </div>

          <div class="row">
            <label for="chartUnit">Units</label>
            <select id="chartUnit">
              <option value="cm" selected>cm</option>
              <option value="in">in</option>
            </select>
          </div>

          <hr />

          <h2>Size chart builder</h2>

          <div class="controls">
            <div class="control">
              <label for="sizeSet">Size set</label>
              <select id="sizeSet">
                <option value="alpha" selected>Alpha (XS–XL)</option>
                <option value="alpha_extended">Alpha (XXS–3XL)</option>
                <option value="women_us">Women US (0–16)</option>
                <option value="women_us_extended">Women US (00–24)</option>
                <option value="men_waist">Men waist (28–40)</option>
              </select>
            </div>

            <div class="control">
              <label>Sizes (select one or more)</label>
              <div class="pillActions">
                <button id="btnSizesAll" type="button">Select all</button>
                <button id="btnSizesNone" type="button" class="ghost">Select none</button>
              </div>
              <div id="sizesSelect" class="sizesRow"></div>
              <div class="muted">Click pills to toggle. Rebuild table to change columns.</div>
            </div>
          </div>

          <div class="actions">
            <button id="btnBuildTable">Build table</button>
            <button id="btnClearTable" class="ghost">Clear</button>
            <button id="btnValidate">Validate</button>
          </div>

          <div class="row">
            <div id="tableWrap" class="notice muted">Build a table to start.</div>
          </div>

          <textarea id="itemSizeChart" style="display:none;">{}</textarea>

          <div class="actions">
            <button id="btnSubmitItem" class="primary">Submit item</button>
          </div>

          <div id="itemMsg" class="muted" style="margin-top:10px" aria-live="polite"></div>
        </div>

        <div class="card">
          <h1>Your items</h1>

          <div class="controls">
            <div class="control">
              <label for="filterSearch">Search</label>
              <input id="filterSearch" placeholder="Search name/brand/itemId" />
            </div>
            <div class="control">
              <label for="filterPublish">Publish status</label>
              <select id="filterPublish">
                <option value="all" selected>All</option>
                <option value="draft">draft</option>
                <option value="submitted">submitted</option>
                <option value="published">published</option>
                <option value="rejected">rejected</option>
              </select>
            </div>
            <div class="control">
              <label for="filterNeedsAction">Needs action</label>
              <select id="filterNeedsAction">
                <option value="all" selected>All</option>
                <option value="yes">Yes (has nextAction)</option>
                <option value="no">No</option>
              </select>
            </div>
          </div>

          <div class="actions">
            <button id="btnRefreshItems">Refresh</button>
          </div>

          <div id="itemsList" class="list" style="margin-top:10px"></div>
        </div>
      </div>
    </section>

    <!-- USAGE -->
    <section class="route" id="route-usage">
      <div class="grid">
        <div class="card">
          <h1>Usage overview</h1>
          <div class="muted">Last 100 raw events (MVP). Add rollups later for scale.</div>
          <div class="actions">
            <button id="btnRefreshUsage">Refresh</button>
          </div>

          <div class="kpiGrid" style="margin-top:10px;">
            <div class="kpi"><div class="n" id="kpiTotal">—</div><div class="t">Events (last 100)</div></div>
            <div class="kpi"><div class="n" id="kpiOpens">—</div><div class="t">open_embed</div></div>
            <div class="kpi"><div class="n" id="kpiRecs">—</div><div class="t">recommendation</div></div>
            <div class="kpi"><div class="n" id="kpiSaves">—</div><div class="t">save_profile</div></div>
          </div>

          <div id="usageList" class="list" style="margin-top:10px;"></div>
        </div>

        <div class="card">
          <h1>Top items (by recommendations)</h1>
          <div class="muted">Computed from last 100 events.</div>
          <div id="topItems" class="list" style="margin-top:10px;"></div>
        </div>
      </div>
    </section>

    <!-- DOCS -->
    <section class="route" id="route-docs">
      <div class="grid">
        <div class="card">
          <h1>Embed instructions</h1>
          <div class="muted">Copy the snippet shown per item. Only merchantId + itemId are required.</div>
          <div class="code" id="docsEmbedSnippet2"></div>
        </div>

        <div class="card">
          <h1>Measurement verification</h1>
          <div class="muted">
            Recommended pipeline:
            <ul>
              <li><b>Auto checks</b>: plausibility, monotonic sizing, unit normalization.</li>
              <li><b>Proof</b>: flat-lay photo with tape, or manufacturer PDF.</li>
              <li><b>Sampling</b>: human review a % based on trust & complaints.</li>
              <li><b>User feedback</b>: tight/ok/loose signals flag bad charts.</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section class="route" id="route-settings">
      <div class="grid">
        <div class="card">
          <h1>Merchant profile</h1>
          <div class="muted">Edits here update onboarding too.</div>

          <div class="row">
            <label for="settingsName2">Store name</label>
            <input id="settingsName2" placeholder="Your store name" />
          </div>

          <div class="row">
            <label for="settingsWebsite2">Website</label>
            <input id="settingsWebsite2" placeholder="https://example.com" inputmode="url" />
          </div>

          <div class="actions">
            <button id="btnSaveMerchant2" class="primary">Save</button>
          </div>

          <div id="merchantMsg2" class="muted" style="margin-top:10px" aria-live="polite"></div>
        </div>

        <div class="card">
          <h1>System</h1>
          <div class="notice">
            <div style="font-weight:950;">No merchant “API URL” required</div>
            <div class="muted" style="margin-top:6px;">
              Website verification is handled by the WiseSize verification service.
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- ITEM DRAWER -->
  <div class="drawerBack" id="drawerBack" aria-hidden="true">
    <div class="drawer" role="dialog" aria-modal="true">
      <div class="drawerHead">
        <div style="min-width:0">
          <div id="drawerTitle" style="font-weight:950; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Item</div>
          <div id="drawerSub" class="muted" style="margin-top:2px"></div>
        </div>
        <div style="margin-left:auto" class="inline">
          <button class="ghost" id="btnCloseDrawer">Close</button>
        </div>
      </div>
      <div class="drawerBody" id="drawerBody"></div>
    </div>
  </div>

  <div class="toastWrap" id="toastWrap" aria-live="polite"></div>

  <script type="module">
    import { getFirebase } from "/components/firebase-init.js";

    import { signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      doc, getDoc, setDoc, addDoc,
      collection, query, where, orderBy, limit, getDocs,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // -----------------------------
    // IMPORTANT: your verification service (hosted by YOU)
    // -----------------------------
    const VERIFY_API_ORIGIN = "https://api.wisesize.com"; // <- change to your Cloud Run / Functions URL

    // -----------------------------
    // Redirect if not signed in
    // -----------------------------
    const SIGNIN_PATH = "/signin"; // adjust if needed
    function redirectToSignIn() {
      const current = encodeURIComponent(window.location.href);
      window.location.href = `${SIGNIN_PATH}?redirect=${current}`;
    }

    // -----------------------------
    // Firestore path helpers (robust)
    // /wise-size/app/{subcollection}/{docId}
    // -----------------------------
    const WS_ROOT_COLLECTION = "wise-size";
    const WS_ROOT_DOC_ID = "app";

    function wsCollection(db, sub) {
      return collection(db, WS_ROOT_COLLECTION, WS_ROOT_DOC_ID, sub);
    }
    function wsDoc(db, sub, id) {
      return doc(db, WS_ROOT_COLLECTION, WS_ROOT_DOC_ID, sub, id);
    }

    // -----------------------------
    // Constants
    // -----------------------------
    const EMBED_SCRIPT_URL = "https://services.unlim8ted.com/wisesize/v1/embed.js";
    function buildEmbedSnippet(merchant, item) {
      return `<script src="${EMBED_SCRIPT_URL}" data-wisesize-merchant="${merchant}" data-wisesize-item="${item}" defer><\\/script>`;
    }

    const SIZE_SETS = {
      alpha: ["XS","S","M","L","XL"],
      alpha_extended: ["XXS","XS","S","M","L","XL","XXL","3XL"],
      women_us: ["0","2","4","6","8","10","12","14","16"],
      women_us_extended: ["00","0","2","4","6","8","10","12","14","16","18","20","22","24"],
      men_waist: ["28","29","30","31","32","33","34","35","36","38","40"]
    };

    const MEASURE_PRESETS = {
      top: ["chest","waist","shoulder","length"],
      bottom: ["waist","hip","inseam","rise"],
      outerwear: ["chest","waist","shoulder","length"],
      dress: ["bust","waist","hip","length"]
    };

    const PLAUSIBLE_RANGES_CM = {
      chestCm:[50,200], bustCm:[50,200], waistCm:[40,180], hipCm:[50,220],
      inseamCm:[40,120], shoulderCm:[30,80], lengthCm:[40,160], riseCm:[10,60]
    };

    // -----------------------------
    // App bootstrap
    // -----------------------------
    const { auth, db } = getFirebase();
    if (!auth || !db) {
      alert("firebase-init.js must export auth and db via getFirebase()");
      throw new Error("Missing firebase init (auth/db)");
    }

    // -----------------------------
    // UI refs
    // -----------------------------
    const tabsEl = document.getElementById("tabs");
    const authStateEl = document.getElementById("authState");
    const btnSignIn = document.getElementById("btnSignIn");
    const btnSignOut = document.getElementById("btnSignOut");
    const toastWrap = document.getElementById("toastWrap");

    // Onboarding status UI
    const setupPills = document.getElementById("setupPills");
    const setupProgress = document.getElementById("setupProgress");
    const setupMsg = document.getElementById("setupMsg");
    const btnContinue = document.getElementById("btnContinue");

    // Stepper
    const stepsEl = document.getElementById("onboardingSteps");
    const step1 = document.getElementById("step-1");
    const step2 = document.getElementById("step-2");
    const step3 = document.getElementById("step-3");
    const btnNextToVerify = document.getElementById("btnNextToVerify");
    const btnBackToProfile = document.getElementById("btnBackToProfile");

    // Profile inputs
    const settingsName = document.getElementById("settingsName");
    const settingsWebsite = document.getElementById("settingsWebsite");
    const btnSaveMerchant = document.getElementById("btnSaveMerchant");
    const merchantMsg = document.getElementById("merchantMsg");

    // Settings tab duplicate inputs
    const settingsName2 = document.getElementById("settingsName2");
    const settingsWebsite2 = document.getElementById("settingsWebsite2");
    const btnSaveMerchant2 = document.getElementById("btnSaveMerchant2");
    const merchantMsg2 = document.getElementById("merchantMsg2");

    // Verification
    const verifyWebsite = document.getElementById("verifyWebsite");
    const verifyMethod = document.getElementById("verifyMethod");
    const btnStartVerify = document.getElementById("btnStartVerify");
    const btnCheckVerify = document.getElementById("btnCheckVerify");
    const verifyBox = document.getElementById("verifyBox");
    const verifyInstructions = document.getElementById("verifyInstructions");
    const verifyTokenLabel = document.getElementById("verifyTokenLabel");
    const verifyState = document.getElementById("verifyState");
    const btnCopyVerifyToken = document.getElementById("btnCopyVerifyToken");
    let lastVerifyToken = null;

    // Builder
    const itemBrand = document.getElementById("itemBrand");
    const itemName = document.getElementById("itemName");
    const itemCategory = document.getElementById("itemCategory");
    const chartType = document.getElementById("chartType");
    const chartUnit = document.getElementById("chartUnit");
    const sizeSet = document.getElementById("sizeSet");
    const sizesSelect = document.getElementById("sizesSelect");
    const btnSizesAll = document.getElementById("btnSizesAll");
    const btnSizesNone = document.getElementById("btnSizesNone");
    const btnBuildTable = document.getElementById("btnBuildTable");
    const btnClearTable = document.getElementById("btnClearTable");
    const btnValidate = document.getElementById("btnValidate");
    const tableWrap = document.getElementById("tableWrap");
    const itemSizeChart = document.getElementById("itemSizeChart");
    const btnSubmitItem = document.getElementById("btnSubmitItem");
    const itemMsg = document.getElementById("itemMsg");

    // Lists
    const filterSearch = document.getElementById("filterSearch");
    const filterPublish = document.getElementById("filterPublish");
    const filterNeedsAction = document.getElementById("filterNeedsAction");
    const btnRefreshItems = document.getElementById("btnRefreshItems");
    const itemsList = document.getElementById("itemsList");

    // Usage
    const btnRefreshUsage = document.getElementById("btnRefreshUsage");
    const usageList = document.getElementById("usageList");
    const topItems = document.getElementById("topItems");
    const kpiTotal = document.getElementById("kpiTotal");
    const kpiOpens = document.getElementById("kpiOpens");
    const kpiRecs = document.getElementById("kpiRecs");
    const kpiSaves = document.getElementById("kpiSaves");

    // Drawer
    const drawerBack = document.getElementById("drawerBack");
    const btnCloseDrawer = document.getElementById("btnCloseDrawer");
    const drawerTitle = document.getElementById("drawerTitle");
    const drawerSub = document.getElementById("drawerSub");
    const drawerBody = document.getElementById("drawerBody");

    // Docs previews
    document.getElementById("docsEmbedSnippet").textContent = buildEmbedSnippet("YOUR_MERCHANT_ID", "YOUR_ITEM_ID");
    document.getElementById("docsEmbedSnippet2").textContent = buildEmbedSnippet("YOUR_MERCHANT_ID", "YOUR_ITEM_ID");

    // -----------------------------
    // State
    // -----------------------------
    let merchantId = null;
    let itemsCache = [];
    let merchantDocCache = null;

    // -----------------------------
    // Utilities
    // -----------------------------
    function escapeHtml(s) {
      return String(s ?? "").replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function toast(title, detail = "", ms = 2400) {
      const el = document.createElement("div");
      el.className = "toast";
      el.innerHTML = `<div class="t">${escapeHtml(title)}</div>${detail ? `<div class="d">${escapeHtml(detail)}</div>` : ""}`;
      toastWrap.appendChild(el);
      setTimeout(() => { el.style.opacity = "0"; el.style.transition = "opacity .2s"; }, Math.max(600, ms - 200));
      setTimeout(() => el.remove(), ms);
    }

    function setBusy(btn, busy, labelWhileBusy = "Working…") {
      if (!btn) return;
      if (busy) {
        btn.dataset._prev = btn.textContent;
        btn.textContent = labelWhileBusy;
        btn.disabled = true;
      } else {
        btn.textContent = btn.dataset._prev || btn.textContent;
        btn.disabled = false;
      }
    }

    function isValidHttpUrl(u) {
      try {
        const x = new URL(u);
        return x.protocol === "http:" || x.protocol === "https:";
      } catch { return false; }
    }

    async function copyText(text) {
      try { await navigator.clipboard.writeText(text); return true; } catch {}
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      return true;
    }

    function requireAuth() {
      if (!merchantId) {
        toast("Sign in required");
        throw new Error("Not signed in");
      }
    }

    // -----------------------------
    // Flow gating
    // -----------------------------
    function isMerchantReady(m) {
      const hasName = !!(m && String(m.name || "").trim());
      const hasWebsite = !!(m && isValidHttpUrl(m.website || ""));
      const verified = !!(m && m.websiteVerified === true);
      return { hasName, hasWebsite, verified, ready: (hasName && hasWebsite && verified) };
    }

    function setTabsEnabled(ready) {
      document.querySelectorAll(".tab").forEach(t => {
        const r = t.dataset.route;
        if (r === "onboarding") { t.disabled = false; return; }
        t.disabled = !ready;
      });
    }

    function activateRoute(route) {
      document.querySelectorAll(".tab").forEach(t => t.classList.toggle("active", t.dataset.route === route));
      document.querySelectorAll(".route").forEach(r => r.classList.toggle("active", r.id === "route-" + route));
    }

    function setStep(n) {
      const panes = [step1, step2, step3];
      panes.forEach((p, i) => p.classList.toggle("active", i === (n-1)));
      stepsEl.querySelectorAll(".step").forEach(el => {
        const k = Number(el.dataset.step);
        el.classList.toggle("active", k === n);
      });
    }

    function renderOnboardingStatus(m) {
      const st = isMerchantReady(m);

      setupPills.innerHTML = [
        `<span class="pill ${st.hasName && st.hasWebsite ? "good":"warn"}">profile: ${st.hasName && st.hasWebsite ? "ok":"needed"}</span>`,
        `<span class="pill ${st.verified ? "good":"warn"}">website: ${st.verified ? "verified":"not verified"}</span>`
      ].join("");

      const pct = Math.round(
        (Number(st.hasName && st.hasWebsite) + Number(st.verified)) / 2 * 100
      );
      setupProgress.style.width = `${pct}%`;

      if (st.ready) {
        setupMsg.textContent = "Setup complete ✓ You can access the dashboard.";
        btnContinue.disabled = false;
        setTabsEnabled(true);
        // show done step
        setStep(3);
        stepsEl.querySelector('[data-step="1"]').classList.add("done");
        stepsEl.querySelector('[data-step="2"]').classList.add("done");
      } else {
        const missing = [];
        if (!(st.hasName && st.hasWebsite)) missing.push("profile");
        if (!st.verified) missing.push("website verification");
        setupMsg.textContent = "Complete: " + missing.join(", ") + ".";
        btnContinue.disabled = true;
        setTabsEnabled(false);

        // auto-step logic
        if (!(st.hasName && st.hasWebsite)) setStep(1);
        else setStep(2);

        stepsEl.querySelector('[data-step="1"]').classList.toggle("done", (st.hasName && st.hasWebsite));
        stepsEl.querySelector('[data-step="2"]').classList.toggle("done", st.verified);
        stepsEl.querySelector('[data-step="3"]').classList.remove("done");
      }
    }

    btnContinue.addEventListener("click", () => {
      if (merchantDocCache && isMerchantReady(merchantDocCache).ready) {
        activateRoute("items");
      } else {
        toast("Finish onboarding first");
      }
    });

    // -----------------------------
    // Routing (tabs) with gate
    // -----------------------------
    tabsEl.addEventListener("click", (e) => {
      const btn = e.target.closest(".tab");
      if (!btn) return;
      if (btn.disabled) {
        toast("Complete onboarding", "Verify your website to unlock the dashboard.");
        activateRoute("onboarding");
        return;
      }
      activateRoute(btn.dataset.route);
    });

    // -----------------------------
    // Auth buttons
    // -----------------------------
    btnSignIn.addEventListener("click", redirectToSignIn);
    btnSignOut.addEventListener("click", async () => {
      try { await signOut(auth); }
      catch (e) { console.error(e); toast("Sign-out failed"); }
    });

    // -----------------------------
    // Merchant doc: create on first visit (RULES-COMPATIBLE)
    // -----------------------------
    async function ensureMerchantDoc() {
      const ref = wsDoc(db, "merchants", merchantId);
      const snap = await getDoc(ref);

      if (!snap.exists()) {
        // Only write fields your rules allow on create:
        await setDoc(ref, {
          ownerUid: merchantId,
          createdAt: serverTimestamp(),
          websiteVerified: false
        }, { merge: true });

        return (await getDoc(ref)).data();
      }
      return snap.data();
    }

    function syncSettingsUIFromMerchant(m) {
      settingsName.value = m?.name || "";
      settingsWebsite.value = m?.website || "";
      verifyWebsite.value = m?.website || "";

      settingsName2.value = m?.name || "";
      settingsWebsite2.value = m?.website || "";
    }

    // -----------------------------
    // Save profile (both tabs)
    // -----------------------------
    async function saveMerchantProfileFromInputs(name, website, msgEls=[]) {
      requireAuth();
      if (!String(name || "").trim()) { toast("Store name required"); return false; }
      if (!String(website || "").trim()) { toast("Website required"); return false; }
      if (!isValidHttpUrl(website)) { toast("Invalid website URL", "Use https://example.com"); return false; }

      const ref = wsDoc(db, "merchants", merchantId);
      await setDoc(ref, {
        ownerUid: merchantId, // keep stable
        name: String(name).trim(),
        website: String(website).trim().replace(/\/+$/, ""),
        updatedAt: serverTimestamp()
      }, { merge: true });

      msgEls.forEach(el => { el.textContent = "Saved ✓"; setTimeout(() => el.textContent = "", 1400); });
      toast("Saved", "Merchant profile updated.");

      const snap = await getDoc(ref);
      merchantDocCache = snap.data();
      syncSettingsUIFromMerchant(merchantDocCache);
      renderOnboardingStatus(merchantDocCache);

      return true;
    }

    btnSaveMerchant.addEventListener("click", async () => {
      try {
        setBusy(btnSaveMerchant, true, "Saving…");
        merchantMsg.textContent = "Saving…";
        await saveMerchantProfileFromInputs(settingsName.value, settingsWebsite.value, [merchantMsg]);
      } catch (e) {
        console.error(e);
        merchantMsg.textContent = "Save failed.";
        toast("Save failed", "Check console + Firestore rules.");
      } finally {
        setBusy(btnSaveMerchant, false);
      }
    });

    btnSaveMerchant2.addEventListener("click", async () => {
      try {
        setBusy(btnSaveMerchant2, true, "Saving…");
        merchantMsg2.textContent = "Saving…";
        await saveMerchantProfileFromInputs(settingsName2.value, settingsWebsite2.value, [merchantMsg2]);
      } catch (e) {
        console.error(e);
        merchantMsg2.textContent = "Save failed.";
        toast("Save failed", "Check console + Firestore rules.");
      } finally {
        setBusy(btnSaveMerchant2, false);
      }
    });

    // Stepper nav buttons
    btnNextToVerify.addEventListener("click", async () => {
      // Don’t force save, but encourage it
      const ok = (merchantDocCache && isMerchantReady(merchantDocCache).hasName && isMerchantReady(merchantDocCache).hasWebsite);
      if (!ok) {
        toast("Save your profile first");
        return;
      }
      setStep(2);
    });
    btnBackToProfile.addEventListener("click", () => setStep(1));

    // -----------------------------
    // Verification token cache (per host + method)
    // -----------------------------
    function safeHostFromUrl(u) {
      try { return new URL(u).host; }
      catch { return String(u || "").replace(/^https?:\/\//, "").split("/")[0]; }
    }
    function verifyTokenKey(website, method) {
      const host = safeHostFromUrl(website);
      return `wisesize_verify_token:${method}:${host}`;
    }
    function saveLastVerifyToken(website, method, token) {
      try { localStorage.setItem(verifyTokenKey(website, method), token); } catch {}
    }
    function loadLastVerifyToken(website, method) {
      try { return localStorage.getItem(verifyTokenKey(website, method)); } catch { return null; }
    }

    function renderVerifyInstructions(website, method, token, outEl) {
      const host = safeHostFromUrl(website);

      if (method === "dns") {
        outEl.innerHTML =
          `<div class="muted">Add a DNS TXT record for <b>${escapeHtml(host)}</b>:</div>
           <ul class="muted" style="margin:8px 0 0 18px;">
             <li><b>Type:</b> TXT</li>
             <li><b>Name/Host:</b> <code>wisesize-verify</code> (or <code>wisesize-verify.${escapeHtml(host)}</code>)</li>
             <li><b>Value:</b> (copy below)</li>
           </ul>
           <div class="muted" style="margin-top:8px;">Tip: DNS can take time to propagate.</div>`;
      } else {
        outEl.innerHTML =
          `<div class="muted">Create a public file on your website:</div>
           <ul class="muted" style="margin:8px 0 0 18px;">
             <li><b>Path:</b> <code>/.well-known/wisesize-verification.txt</code></li>
             <li><b>Contents:</b> (copy below)</li>
           </ul>
           <div class="muted" style="margin-top:8px;">Tip: Must return 200 and be reachable without auth.</div>`;
      }
    }

    async function startVerifyFlow({ website, method, setBusyBtn, boxEl, instrEl, tokenEl, stateEl, setToken }) {
      requireAuth();
      if (!website) { toast("Website required"); return; }
      if (!isValidHttpUrl(website)) { toast("Invalid website URL"); return; }

      setBusy(setBusyBtn, true, "Starting…");
      stateEl.textContent = "Starting…";

      try {
        const idToken = await auth.currentUser.getIdToken(true);
        const res = await fetch(VERIFY_API_ORIGIN + "/v1/merchant/verify/start", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({
            firebaseIdToken: idToken,
            merchantId,
            website,
            method
          })
        });
        if (!res.ok) throw new Error("start failed " + res.status);
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "start not ok");

        setToken(data.token);
        saveLastVerifyToken(website, method, data.token);

        boxEl.style.display = "";
        renderVerifyInstructions(website, method, data.token, instrEl);
        tokenEl.textContent = data.token;
        stateEl.textContent = "Add the proof, then click Check verification.";
        toast("Verification started", "Add proof then check.");
      } catch (e) {
        console.error(e);
        stateEl.textContent = "Failed to start verification.";
        toast("Verification start failed", "Check VERIFY_API_ORIGIN + server logs.");
      } finally {
        setBusy(setBusyBtn, false);
      }
    }

    async function checkVerifyFlow({ website, method, token, setBusyBtn, stateEl }) {
      requireAuth();
      if (!website) { toast("Website required"); return; }
      if (!isValidHttpUrl(website)) { toast("Invalid website URL"); return; }
      if (!token) { toast("Start verification first"); return; }

      setBusy(setBusyBtn, true, "Checking…");
      stateEl.textContent = "Checking…";

      try {
        const idToken = await auth.currentUser.getIdToken(true);
        const res = await fetch(VERIFY_API_ORIGIN + "/v1/merchant/verify/check", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({
            firebaseIdToken: idToken,
            merchantId,
            website,
            method,
            token
          })
        });
        if (!res.ok) throw new Error("check failed " + res.status);
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "check not ok");

        if (data.verified === true) {
          stateEl.textContent = "Verified ✓";

          // IMPORTANT: server should update /wise-size/app/merchants/{merchantId}.websiteVerified = true
          // Client just reloads it.
          const ref = wsDoc(db, "merchants", merchantId);
          const snap = await getDoc(ref);
          merchantDocCache = snap.data();

          renderOnboardingStatus(merchantDocCache);

          toast("Verified ✓", "Website ownership confirmed.");
        } else {
          stateEl.textContent = "Not found yet. DNS can take time—try again.";
          toast("Not found yet", "DNS and caches can take time.");
        }
      } catch (e) {
        console.error(e);
        stateEl.textContent = "Verification check failed.";
        toast("Verification check failed", "Check server logs + proof placement.");
      } finally {
        setBusy(setBusyBtn, false);
      }
    }

    btnStartVerify.addEventListener("click", () => {
      const website = (verifyWebsite.value.trim() || settingsWebsite.value.trim());
      startVerifyFlow({
        website,
        method: verifyMethod.value,
        setBusyBtn: btnStartVerify,
        boxEl: verifyBox,
        instrEl: verifyInstructions,
        tokenEl: verifyTokenLabel,
        stateEl: verifyState,
        setToken: (t) => lastVerifyToken = t
      });
    });

    btnCheckVerify.addEventListener("click", async () => {
      const website = (verifyWebsite.value.trim() || settingsWebsite.value.trim());
      if (!lastVerifyToken) {
        const cached = loadLastVerifyToken(website, verifyMethod.value);
        if (cached) lastVerifyToken = cached;
      }
      await checkVerifyFlow({
        website,
        method: verifyMethod.value,
        token: lastVerifyToken,
        setBusyBtn: btnCheckVerify,
        stateEl: verifyState
      });
    });

    btnCopyVerifyToken.addEventListener("click", async () => {
      const t = (verifyTokenLabel.textContent || "").trim();
      if (!t) { toast("No token to copy"); return; }
      await copyText(t);
      toast("Copied ✓");
    });

    // -----------------------------
    // Builder logic
    // -----------------------------
    function normMeasureKey(k) {
      const raw = String(k).trim();
      if (!raw) return null;
      if (/Cm$/.test(raw) || /In$/.test(raw)) return raw;
      const map = {
        chest:"chestCm", bust:"bustCm", waist:"waistCm", hip:"hipCm",
        inseam:"inseamCm", shoulder:"shoulderCm", length:"lengthCm", rise:"riseCm"
      };
      return map[raw.toLowerCase()] || raw;
    }

    function getMeasuresForBuilder() {
      const cat = itemCategory.value;
      const base = MEASURE_PRESETS[cat] || ["chest","waist"];
      return base.map(normMeasureKey).filter(Boolean);
    }

    function escapeId(s) { return String(s).replace(/[^a-zA-Z0-9_-]/g, "_"); }

    function toNum(v) {
      if (v == null || v === "") return null;
      const n = Number(String(v).trim());
      return Number.isFinite(n) ? n : null;
    }

    function safeJsonParse(s) {
      try { return JSON.parse(s); } catch { return null; }
    }

    function fillSizesOptions(list) {
      sizesSelect.innerHTML = "";
      list.forEach(sz => {
        const el = document.createElement("div");
        el.className = "sizePill active";
        el.textContent = sz;
        el.dataset.value = sz;
        el.addEventListener("click", () => {
          el.classList.toggle("active");
          if (document.getElementById("builderTable")) btnBuildTable.click();
          else syncJsonFromTable();
        });
        sizesSelect.appendChild(el);
      });
    }

    function setAllSizes(active) {
      sizesSelect.querySelectorAll(".sizePill").forEach(p => p.classList.toggle("active", !!active));
      if (document.getElementById("builderTable")) btnBuildTable.click();
      else syncJsonFromTable();
    }

    function getSelectedSizes() {
      return Array.from(sizesSelect.querySelectorAll(".sizePill.active")).map(el => el.dataset.value);
    }

    function refreshSizesFromSet() {
      fillSizesOptions(SIZE_SETS[sizeSet.value] || SIZE_SETS.alpha);
    }

    function validateSizeChart(chart) {
      const issues = [];
      if (!chart || typeof chart !== "object") return { ok:false, issues:["Chart missing or invalid JSON."] };
      if (!["cm","in"].includes(chart.unit)) issues.push("unit must be 'cm' or 'in'.");
      if (!["body","garment"].includes(chart.type)) issues.push("type must be 'body' or 'garment'.");
      if (!Array.isArray(chart.sizes) || chart.sizes.length === 0) issues.push("sizes[] is required.");

      const sizes = chart.sizes || [];
      Object.entries(chart).forEach(([k, v]) => {
        if (k === "sizes" || k === "unit" || k === "type") return;
        if (!v || typeof v !== "object") return;

        sizes.forEach(sz => {
          const r = v[sz];
          if (r == null) return;
          if (!Array.isArray(r) || r.length !== 2) { issues.push(`${k}.${sz} must be [min,max].`); return; }
          const min = r[0], max = r[1];
          if (!Number.isFinite(min) || !Number.isFinite(max)) issues.push(`${k}.${sz} must be numbers.`);
          if (min > max) issues.push(`${k}.${sz} min > max.`);
          if (chart.unit === "cm" && PLAUSIBLE_RANGES_CM[k]) {
            const [lo, hi] = PLAUSIBLE_RANGES_CM[k];
            if (min < lo || max > hi) issues.push(`${k}.${sz} out of plausible range (${lo}-${hi}cm).`);
          }
        });

        let prev = null;
        for (let i = 0; i < sizes.length; i++) {
          const sz = sizes[i];
          const r = v[sz];
          if (!r) continue;
          const mid = (r[0] + r[1]) / 2;
          if (prev != null && mid + 0.001 < prev) { issues.push(`${k} not monotonic at ${sz}.`); break; }
          prev = mid;
        }
      });

      return { ok: issues.length === 0, issues };
    }

    function renderBuilderTable(sizes, measures) {
      const isBody = chartType.value === "body";
      const unit = chartUnit.value;

      const headCells = ["Size"].concat(measures.map(m => `${m} (${unit})`));
      const thead = "<tr>" + headCells.map(h => `<th>${escapeHtml(h)}</th>`).join("") + "</tr>";

      const rows = sizes.map(sz => {
        const tds = measures.map(m => {
          const minId = `cell_${escapeId(sz)}_${escapeId(m)}_min`;
          const maxId = `cell_${escapeId(sz)}_${escapeId(m)}_max`;

          if (isBody) {
            return `
              <td>
                <div class="inline">
                  <input style="width:110px" inputmode="decimal" placeholder="min" id="${minId}"/>
                  <span class="muted">–</span>
                  <input style="width:110px" inputmode="decimal" placeholder="max" id="${maxId}"/>
                </div>
              </td>`;
          }

          return `
            <td>
              <div class="inline">
                <input style="width:110px" inputmode="decimal" placeholder="value" id="${minId}"/>
                <span class="muted">±</span>
                <input style="width:110px" inputmode="decimal" placeholder="tol" id="${maxId}"/>
              </div>
              <div class="muted" style="margin-top:6px">If tol empty → min=max.</div>
            </td>`;
        }).join("");

        return `<tr><td><b>${escapeHtml(sz)}</b></td>${tds}</tr>`;
      }).join("");

      tableWrap.innerHTML = `
        <table class="table" id="builderTable" data-body="${isBody ? "1" : "0"}" data-unit="${escapeHtml(unit)}">
          <thead>${thead}</thead>
          <tbody>${rows}</tbody>
        </table>
        <div class="muted" style="margin-top:10px;">Tip: JSON syncs as you type.</div>
      `;

      tableWrap.querySelectorAll("input").forEach(inp => {
        inp.addEventListener("input", syncJsonFromTable);
        inp.addEventListener("blur", syncJsonFromTable);
      });
    }

    function syncJsonFromTable() {
      const tbl = document.getElementById("builderTable");
      if (!tbl) {
        const chart = safeJsonParse(itemSizeChart.value) || {};
        chart.sizes = getSelectedSizes();
        chart.unit = chartUnit.value;
        chart.type = chartType.value;
        itemSizeChart.value = JSON.stringify(chart, null, 2);
        return;
      }

      const isBody = tbl.dataset.body === "1";
      const unit = tbl.dataset.unit;

      const sizes = getSelectedSizes();
      const measures = getMeasuresForBuilder();

      const chart = {
        unit,
        type: isBody ? "body" : "garment",
        sizes: sizes.slice()
      };
      measures.forEach(m => { chart[m] = {}; });

      sizes.forEach(sz => {
        measures.forEach(m => {
          const minEl = document.getElementById(`cell_${escapeId(sz)}_${escapeId(m)}_min`);
          const maxEl = document.getElementById(`cell_${escapeId(sz)}_${escapeId(m)}_max`);
          const a = toNum(minEl ? minEl.value : null);
          const b = toNum(maxEl ? maxEl.value : null);
          if (a == null && b == null) return;

          if (isBody) {
            const min = (a != null) ? a : b;
            const max = (b != null) ? b : a;
            chart[m][sz] = [min, max].sort((x, y) => x - y);
          } else {
            const val = a;
            if (val == null) return;
            const tol = (b != null) ? b : 0;
            chart[m][sz] = [val - tol, val + tol].sort((x, y) => x - y);
          }
        });
      });

      itemSizeChart.value = JSON.stringify(chart, null, 2);
    }

    btnSizesAll.addEventListener("click", () => setAllSizes(true));
    btnSizesNone.addEventListener("click", () => setAllSizes(false));

    sizeSet.addEventListener("change", () => {
      refreshSizesFromSet();
      if (document.getElementById("builderTable")) btnBuildTable.click();
    });

    btnClearTable.addEventListener("click", () => {
      tableWrap.innerHTML = '<div class="notice muted">Build a table to start.</div>';
      itemSizeChart.value = "{}";
      toast("Cleared");
    });

    btnBuildTable.addEventListener("click", () => {
      const sizes = getSelectedSizes();
      if (!sizes.length) { toast("Select at least one size"); return; }
      const measures = getMeasuresForBuilder();
      if (!measures.length) { toast("Select at least one measure"); return; }
      renderBuilderTable(sizes, measures);
      syncJsonFromTable();
      toast("Table built");
    });

    btnValidate.addEventListener("click", () => {
      syncJsonFromTable();
      const report = validateSizeChart(safeJsonParse(itemSizeChart.value));
      if (report.ok) toast("Looks good ✓");
      else toast("Validation issues", report.issues.slice(0, 3).join(" • ") + (report.issues.length > 3 ? " …" : ""));
      if (!report.ok) alert("Validation issues:\n\n" + report.issues.join("\n"));
    });

    // Default sizes
    refreshSizesFromSet();

    // -----------------------------
    // Items list / usage (gated)
    // -----------------------------
    function chip(label, value) {
      const v = String(value ?? "—");
      const cls =
        (label === "publish" && v === "published") ? "good" :
        (label === "publish" && v === "rejected") ? "bad" :
        (label === "status" && v === "pass") ? "good" :
        (label === "status" && v === "fail") ? "bad" : "";
      return `<span class="pill ${cls}">${escapeHtml(label)}: ${escapeHtml(v)}</span>`;
    }

    async function loadItems() {
      if (!merchantId) {
        itemsList.innerHTML = '<div class="muted">Sign in to manage items.</div>';
        return;
      }
      itemsList.innerHTML = '<div class="muted">Loading…</div>';

      const qy = query(
        wsCollection(db, "items"),
        where("merchantId", "==", merchantId),
        orderBy("createdAt", "desc"),
        limit(60)
      );

      const snap = await getDocs(qy);
      itemsCache = snap.docs.map(d => Object.assign({ id: d.id }, d.data()));
      renderItems(itemsCache);
    }

    function renderItems(items) {
      const search = filterSearch.value.trim().toLowerCase();
      const pub = filterPublish.value;
      const needs = filterNeedsAction.value;

      const filtered = items.filter(it => {
        const status = it.publishStatus || "draft";
        if (pub !== "all" && status !== pub) return false;

        const hasNext = !!(it.verification && it.verification.nextAction);
        if (needs === "yes" && !hasNext) return false;
        if (needs === "no" && hasNext) return false;

        if (search) {
          const hay = (it.id + " " + (it.brand || "") + " " + (it.name || "")).toLowerCase();
          if (!hay.includes(search)) return false;
        }
        return true;
      });

      itemsList.innerHTML = "";
      if (!filtered.length) {
        itemsList.innerHTML = '<div class="muted">No items match filters.</div>';
        return;
      }

      filtered.forEach(it => {
        const v = it.verification || {};
        const embedSnippet = buildEmbedSnippet(merchantId, it.id);

        const el = document.createElement("div");
        el.className = "item";

        el.innerHTML =
          `<div class="itemTop">
             <div style="min-width:0">
               <div class="itemTitle">${escapeHtml((it.brand || "") + " — " + (it.name || ""))}</div>
               <div class="muted" style="margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                 ${escapeHtml(it.category || "—")} • id: ${escapeHtml(it.id)}
               </div>
               <div class="pills">
                 ${chip("publish", it.publishStatus || "draft")}
               </div>
             </div>
             <div class="inline" style="align-items:flex-start;">
               <button data-act="view">View</button>
               <button data-act="copy">Copy embed</button>
             </div>
           </div>
           <div class="code" data-embed></div>`;

        el.querySelector('[data-embed]').textContent = embedSnippet;
        el.querySelector('[data-act="view"]').addEventListener("click", () => openDrawer(it));
        el.querySelector('[data-act="copy"]').addEventListener("click", async () => {
          await copyText(embedSnippet);
          const b = el.querySelector('[data-act="copy"]');
          b.textContent = "Copied ✓";
          setTimeout(() => b.textContent = "Copy embed", 1100);
        });

        itemsList.appendChild(el);
      });
    }

    async function loadUsage() {
      if (!merchantId) {
        usageList.innerHTML = '<div class="muted">Sign in to see usage.</div>';
        topItems.innerHTML = "";
        kpiTotal.textContent = "—";
        kpiOpens.textContent = "—";
        kpiRecs.textContent = "—";
        kpiSaves.textContent = "—";
        return;
      }

      usageList.innerHTML = '<div class="muted">Loading…</div>';
      topItems.innerHTML = "";

      const qy = query(
        wsCollection(db, "usageEvents"),
        where("merchantId", "==", merchantId),
        orderBy("ts", "desc"),
        limit(100)
      );

      const snap = await getDocs(qy);
      const events = snap.docs.map(d => d.data());

      const counts = events.reduce((acc, e) => {
        const k = e.type || "unknown";
        acc[k] = (acc[k] || 0) + 1;
        return acc;
      }, {});

      kpiTotal.textContent = String(events.length);
      kpiOpens.textContent = String(counts.open_embed || 0);
      kpiRecs.textContent = String(counts.recommendation || 0);
      kpiSaves.textContent = String(counts.save_profile || 0);

      usageList.innerHTML = "";
      events.slice(0, 20).forEach(e => {
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML =
          `<div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
             <div>
               <div style="font-weight:950">${escapeHtml(e.type || "unknown")}</div>
               <div class="muted">item: ${escapeHtml(e.itemId || "—")} • session: ${escapeHtml(e.anonSessionId || "—")}</div>
             </div>
           </div>`;
        usageList.appendChild(el);
      });

      if (!events.length) usageList.innerHTML = '<div class="muted">No events yet.</div>';

      const byItem = {};
      events.forEach(e => {
        if (e.type !== "recommendation") return;
        const id = e.itemId || "unknown";
        byItem[id] = (byItem[id] || 0) + 1;
      });

      const top = Object.entries(byItem).sort((a,b) => b[1]-a[1]).slice(0,10);

      topItems.innerHTML = "";
      if (!top.length) {
        topItems.innerHTML = '<div class="muted">No recommendations yet.</div>';
      } else {
        top.forEach(([id, n]) => {
          const el = document.createElement("div");
          el.className = "item";
          el.innerHTML =
            `<div style="display:flex; justify-content:space-between; gap:10px;">
               <div>
                 <div style="font-weight:950">${escapeHtml(id)}</div>
                 <div class="muted">Recommendations</div>
               </div>
               <div class="pill good">${escapeHtml(n)}</div>
             </div>`;
          topItems.appendChild(el);
        });
      }
    }

    // Buttons
    [filterSearch, filterPublish, filterNeedsAction].forEach(el => {
      el.addEventListener("input", () => renderItems(itemsCache));
      el.addEventListener("change", () => renderItems(itemsCache));
    });
    btnRefreshItems.addEventListener("click", loadItems);
    btnRefreshUsage.addEventListener("click", loadUsage);

    // Submit item (gated)
    btnSubmitItem.addEventListener("click", async () => {
      try {
        requireAuth();

        if (!merchantDocCache || !isMerchantReady(merchantDocCache).ready) {
          toast("Complete onboarding", "Verify your website to submit items.");
          activateRoute("onboarding");
          return;
        }

        syncJsonFromTable();

        const brand = itemBrand.value.trim();
        const name = itemName.value.trim();
        const category = itemCategory.value;

        if (!brand || !name) { toast("Brand and product name required"); return; }

        const chart = safeJsonParse(itemSizeChart.value);
        const report = validateSizeChart(chart);
        if (!report.ok) {
          alert("Fix these issues before submitting:\n\n" + report.issues.join("\n"));
          return;
        }

        setBusy(btnSubmitItem, true, "Submitting…");
        itemMsg.textContent = "Submitting…";

        await addDoc(wsCollection(db, "items"), {
          merchantId,
          brand,
          name,
          category,
          sizeChart: chart,
          measurement: {
            type: chart.type === "garment" ? "garment" : "body_recommended",
            unit: chart.unit,
            method: "merchant_entered",
            tolerances: {}
          },
          publishStatus: "submitted",
          verification: {
            stage: "auto_schema",
            status: "pending",
            progress: 10,
            score: 0,
            nextAction: null,
            humanRequired: false,
            lastUpdatedAt: serverTimestamp()
          },
          createdAt: serverTimestamp()
        });

        itemMsg.textContent = "Submitted ✓";
        toast("Submitted ✓", "Item added to verification pipeline.");

        itemBrand.value = "";
        itemName.value = "";

        await loadItems();
      } catch (e) {
        console.error(e);
        itemMsg.textContent = "Submit failed.";
        toast("Submit failed", "Check Firestore rules and console.");
      } finally {
        setBusy(btnSubmitItem, false);
      }
    });

    // -----------------------------
    // Drawer
    // -----------------------------
    btnCloseDrawer.addEventListener("click", closeDrawer);
    drawerBack.addEventListener("click", (e) => { if (e.target === drawerBack) closeDrawer(); });

    function openDrawer(item) {
      drawerTitle.textContent = (item.brand || "") + " — " + (item.name || "");
      drawerSub.textContent = "Item ID: " + item.id + " • " + (item.category || "—") + " • " + (item.publishStatus || "—");

      drawerBack.classList.add("show");
      drawerBack.setAttribute("aria-hidden", "false");

      const embedSnippet = buildEmbedSnippet(merchantId, item.id);

      drawerBody.innerHTML =
        `<div class="card" style="margin-bottom:12px;">
           <h2>Embed</h2>
           <div class="actions"><button id="drawerCopyEmbed">Copy embed</button></div>
           <div class="code" id="drawerEmbedCode"></div>
         </div>
         <div class="card">
           <h2>Size chart</h2>
           <div class="code">${escapeHtml(JSON.stringify(item.sizeChart || {}, null, 2))}</div>
         </div>`;

      document.getElementById("drawerEmbedCode").textContent = embedSnippet;
      document.getElementById("drawerCopyEmbed").addEventListener("click", async () => {
        await copyText(embedSnippet);
        const b = document.getElementById("drawerCopyEmbed");
        b.textContent = "Copied ✓";
        setTimeout(() => b.textContent = "Copy embed", 1100);
      });
    }

    function closeDrawer() {
      drawerBack.classList.remove("show");
      drawerBack.setAttribute("aria-hidden", "true");
      drawerBody.innerHTML = "";
    }

    // -----------------------------
    // Auth boot
    // -----------------------------
    onAuthStateChanged(auth, async (u) => {
      if (!u) {
        merchantId = null;
        authStateEl.textContent = "Signed out";
        btnSignIn.style.display = "";
        btnSignOut.style.display = "none";
        redirectToSignIn();
        return;
      }

      merchantId = u.uid;
      authStateEl.textContent = u.email ?? u.uid;
      btnSignIn.style.display = "none";
      btnSignOut.style.display = "";

      try {
        merchantDocCache = await ensureMerchantDoc();
        syncSettingsUIFromMerchant(merchantDocCache);

        // Load cached verification token for this browser (reduce friction)
        const website = (merchantDocCache.website || "").trim();
        if (website && isValidHttpUrl(website)) {
          const cached = loadLastVerifyToken(website, verifyMethod.value);
          if (cached) {
            lastVerifyToken = cached;
            verifyBox.style.display = "";
            renderVerifyInstructions(website, verifyMethod.value, cached, verifyInstructions);
            verifyTokenLabel.textContent = cached;
            verifyState.textContent = "Token loaded from this browser. Click Check verification after adding proof.";
          }
        }

        renderOnboardingStatus(merchantDocCache);

        const st = isMerchantReady(merchantDocCache);
        if (!st.ready) {
          activateRoute("onboarding");
          return;
        }

        activateRoute("items");
        await loadItems();
      } catch (e) {
        console.error(e);
        toast("Load failed", "Check Firestore rules/indexes + firebase-init.js.");
        activateRoute("onboarding");
      }
    });
  </script>
</body>
</html>