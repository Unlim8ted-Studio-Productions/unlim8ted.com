<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Unlim8ted - Cart</title>
  <meta name="description" content="View your Unlim8ted cart, powered by Unlim8ted Studio Productions" />
  <link rel="icon" href="https://unlim8ted.com/favicon.ico" type="image/x-icon">

  <!-- Components -->
  <script type="module" src="/components/site-navbar.js"></script>
  <script type="module" src="/components/site-loader.js"></script>

  <!-- Square Web Payments SDK (PRODUCTION) -->
  <script src="https://web.squarecdn.com/v1/square.js"></script>

  <style>
    :root {
      --bg0: #05040a;
      --bg1: #0c0620;
      --ink: rgba(233, 231, 255, .92);
      --muted: rgba(233, 231, 255, .72);
      --glass: rgba(0, 0, 0, .38);
      --stroke: rgba(180, 130, 255, .24);
      --accent: #b86bff;
      --accent2: #63d6ff;
      --danger: #ff4d4d;
      --warn: #ffd166;
      --shadow: 0 18px 40px rgba(0, 0, 0, .45);
      --r: 18px;
    }

    body {
      margin: 0;
      color: var(--ink);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 600px at 20% 15%, rgba(184, 107, 255, .16), transparent 55%),
        radial-gradient(900px 650px at 80% 25%, rgba(99, 214, 255, .14), transparent 60%),
        radial-gradient(900px 700px at 55% 95%, rgba(255, 77, 45, .08), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height: 100vh;
      padding-top: 56px;
    }

    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 28px 16px 70px;
    }

    .topbar {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 14px;
      margin-bottom: 14px;
    }

    h1 {
      margin: 0;
      font-size: 28px;
      letter-spacing: .2px;
    }

    .sub {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 14px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1.55fr .85fr;
      gap: 16px;
      align-items: start;
    }

    .card {
      background: var(--glass);
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
    }

    /* Left */
    .list {
      padding: 14px;
    }

    .notice {
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, .10);
      background: rgba(255, 255, 255, .06);
      color: var(--muted);
      margin-bottom: 12px;
      font-size: 13px;
      line-height: 1.35;
    }

    .notice strong {
      color: rgba(255, 255, 255, .92);
    }

    .notice.ok {
      border-color: rgba(99, 214, 255, .22);
      background: rgba(99, 214, 255, .08);
      color: rgba(255, 255, 255, .82);
    }

    .notice.warn {
      border-color: rgba(255, 209, 102, .22);
      background: rgba(255, 209, 102, .08);
      color: rgba(255, 255, 255, .78);
    }

    .notice.bad {
      border-color: rgba(255, 77, 77, .28);
      background: rgba(255, 77, 77, .10);
      color: rgba(255, 255, 255, .86);
    }

    .empty {
      padding: 18px;
      color: var(--muted);
    }

    /* Item */
    .item {
      display: grid;
      grid-template-columns: 88px 1fr auto;
      gap: 14px;
      padding: 12px;
      border-radius: 16px;
      background: rgba(255, 255, 255, .04);
      border: 1px solid rgba(255, 255, 255, .06);
      margin-bottom: 10px;
      align-items: center;
    }

    .thumb {
      width: 88px;
      height: 88px;
      border-radius: 16px;
      overflow: hidden;
      background: rgba(255, 255, 255, .07);
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255, 255, 255, .55);
      font-size: 12px;
      border: 1px solid rgba(255, 255, 255, .08);
    }

    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .meta {
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .title {
      font-size: 15px;
      font-weight: 850;
      letter-spacing: .2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .mini {
      font-size: 12px;
      color: rgba(255, 255, 255, .64);
    }

    .row2 {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .price {
      font-weight: 900;
      color: rgba(255, 255, 255, .92);
    }

    .price .free {
      color: rgba(99, 214, 255, .95);
      letter-spacing: .3px;
    }

    /* Qty */
    .qty {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, .06);
      border: 1px solid rgba(255, 255, 255, .10);
      border-radius: 999px;
      padding: 6px 10px;
    }

    .qty button {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: rgba(255, 255, 255, .08);
      color: var(--ink);
      font-size: 18px;
      line-height: 0;
    }

    .qty button:hover {
      background: rgba(184, 107, 255, .16);
      color: rgba(184, 107, 255, 1);
    }

    .qty input {
      width: 42px;
      border: none;
      background: transparent;
      color: var(--ink);
      text-align: center;
      outline: none;
      font-weight: 900;
      font-size: 14px;
    }

    /* Actions */
    .actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: flex-end;
      justify-content: center;
    }

    .iconbtn {
      width: 40px;
      height: 40px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, .10);
      background: rgba(255, 255, 255, .05);
      color: rgba(255, 255, 255, .88);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .iconbtn:hover {
      border-color: rgba(255, 77, 77, .35);
      background: rgba(255, 77, 77, .12);
      color: var(--danger);
    }

    .btn {
      border: none;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 950;
      cursor: pointer;
      text-decoration: none;
      text-align: center;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      user-select: none;
    }

    .btn:disabled {
      opacity: .55;
      cursor: not-allowed;
      filter: grayscale(.2);
    }

    .btn-primary {
      background: linear-gradient(90deg, rgba(184, 107, 255, 1), rgba(99, 214, 255, 1));
      color: #071022;
      box-shadow: 0 12px 26px rgba(184, 107, 255, .16);
    }

    .btn-primary:hover {
      filter: brightness(.98);
    }

    .btn-ghost {
      background: rgba(255, 255, 255, .05);
      color: var(--ink);
      border: 1px solid rgba(255, 255, 255, .10);
    }

    .btn-ghost:hover {
      background: rgba(255, 255, 255, .08);
    }

    .btn-danger {
      background: rgba(255, 77, 77, .16);
      color: rgba(255, 255, 255, .92);
      border: 1px solid rgba(255, 77, 77, .30);
    }

    .btn-danger:hover {
      background: rgba(255, 77, 77, .22);
      border-color: rgba(255, 77, 77, .38);
    }

    /* Right / Summary */
    .summary {
      padding: 16px;
      position: sticky;
      top: 76px;
    }

    .sum-title {
      font-weight: 950;
      letter-spacing: .2px;
      margin-bottom: 10px;
    }

    .sumline {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 0;
      color: var(--muted);
      border-bottom: 1px solid rgba(255, 255, 255, .08);
      font-size: 14px;
    }

    .sumline strong {
      color: rgba(255, 255, 255, .92);
    }

    .total {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 0 6px;
      font-size: 16px;
      font-weight: 950;
    }

    .cta {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .helper {
      margin-top: 10px;
      color: rgba(255, 255, 255, .62);
      font-size: 12px;
      line-height: 1.35;
    }

    .foot {
      margin-top: 20px;
      text-align: center;
      color: rgba(255, 255, 255, .6);
      font-size: 13px;
    }

    /* Generic modal */
    .modalOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .62);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 9999;
    }

    .modalOverlay.show {
      display: flex;
    }

    .modal {
      width: min(740px, 100%);
      background: rgba(10, 8, 18, .88);
      border: 1px solid rgba(180, 130, 255, .28);
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, .55);
      overflow: hidden;
    }

    .modalHead {
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, .08);
      background: rgba(255, 255, 255, .04);
    }

    .modalTitle {
      font-weight: 950;
      letter-spacing: .2px;
    }

    .modalClose {
      width: 38px;
      height: 38px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, .10);
      background: rgba(255, 255, 255, .05);
      color: rgba(255, 255, 255, .9);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .modalClose:hover {
      background: rgba(255, 255, 255, .08);
    }

    .modalBody {
      padding: 14px 16px;
      color: rgba(255, 255, 255, .82);
      line-height: 1.35;
      font-size: 13px;
    }

    .modalActions {
      padding: 14px 16px 16px;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      border-top: 1px solid rgba(255, 255, 255, .08);
    }

    /* Donation popup form */
    .donateGrid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    /* Checkout grid */
    .checkoutGrid {
      display: grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 12px;
      align-items: start;
      margin-top: 10px;
    }

    .fieldGrid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    .fieldGrid .full {
      grid-column: 1 / -1;
    }

    select,
    input[type="text"],
    input[type="email"],
    input[type="tel"] {
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(10, 8, 18, .72);
      color: rgba(255, 255, 255, .92);
      padding: 10px 12px;
      outline: none;
      font-weight: 850;
      width: 100%;
      box-sizing: border-box;
    }

    select option {
      background: #0b0a12;
      color: rgba(255, 255, 255, .92);
    }

    .hint {
      margin-top: 8px;
      color: rgba(255, 255, 255, .62);
      font-size: 12px;
      line-height: 1.35;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border-radius: 999px;
      padding: 8px 10px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(255, 255, 255, .06);
      color: rgba(255, 255, 255, .85);
      font-weight: 900;
      font-size: 12px;
    }

    .divider {
      height: 1px;
      background: rgba(255, 255, 255, .08);
      margin: 12px 0;
    }

    #card-container {
      border: 1px solid rgba(255, 255, 255, .10);
      border-radius: 16px;
      padding: 10px;
      background: rgba(255, 255, 255, .04);
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }

      .summary {
        position: static;
      }

      .item {
        grid-template-columns: 74px 1fr;
        grid-template-rows: auto auto;
        align-items: start;
      }

      .actions {
        grid-column: 1 / -1;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }

      .donateGrid {
        grid-template-columns: 1fr;
      }

      .checkoutGrid {
        grid-template-columns: 1fr;
      }

      .fieldGrid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <site-loader text="Loading..."></site-loader>
  <site-navbar cart-href="/cart" signin-href="https://unlim8ted.com/sign-in"
    profile-href="https://unlim8ted.com/profile"></site-navbar>

  <!-- Modal: Confirm (clear cart) -->
  <div id="modalOverlay" class="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modalHead">
        <div id="modalTitle" class="modalTitle">Confirm</div>
        <button id="modalClose" class="modalClose" type="button" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" style="width:18px;height:18px;">
            <path d="M6 6l12 12M18 6 6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
          </svg>
        </button>
      </div>
      <div id="modalBody" class="modalBody"></div>
      <div class="modalActions">
        <button id="modalCancel" class="btn btn-ghost" type="button">Cancel</button>
        <button id="modalConfirm" class="btn btn-danger" type="button">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Modal: Donation popup -->
  <div id="donateOverlay" class="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="donateTitle">
      <div class="modalHead">
        <div id="donateTitle" class="modalTitle">Support Unlim8ted</div>
        <button id="donateClose" class="modalClose" type="button" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" style="width:18px;height:18px;">
            <path d="M6 6l12 12M18 6 6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
          </svg>
        </button>
      </div>
      <div class="modalBody">
        Choose how you’d like to support, then we’ll open Square in a secure popup.

        <div class="donateGrid">
          <div>
            <div class="mini" style="margin-bottom:6px;">Frequency</div>
            <select id="donateFreq" aria-label="Donation frequency">
              <option value="one_time">One-time</option>
              <option value="weekly">Weekly</option>
              <option value="monthly">Monthly</option>
              <option value="annual">Annual</option>
            </select>
          </div>

          <div>
            <div class="mini" style="margin-bottom:6px;">Amount</div>
            <select id="donateAmount" aria-label="Donation amount">
              <option value="custom">Custom</option>
              <option value="1">$1</option>
              <option value="5">$5</option>
              <option value="10">$10</option>
            </select>
          </div>
        </div>

        <div class="hint">
          Square will handle your payment securely. Thank you for supporting Unlim8ted.
        </div>
      </div>
      <div class="modalActions">
        <button id="donateCancel" class="btn btn-ghost" type="button">Cancel</button>
        <button id="donateGo" class="btn btn-primary" type="button">Donate via Square</button>
      </div>
    </div>
  </div>

  <!-- Modal: Checkout (address + shipping + card payment) -->
  <div id="checkoutOverlay" class="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="checkoutTitle">
      <div class="modalHead">
        <div id="checkoutTitle" class="modalTitle">Checkout</div>
        <button id="checkoutClose" class="modalClose" type="button" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" style="width:18px;height:18px;">
            <path d="M6 6l12 12M18 6 6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
          </svg>
        </button>
      </div>

      <div class="modalBody">
        <div class="mini">Enter your shipping address, choose a shipping method, then pay securely.</div>

        <div class="checkoutGrid">
          <!-- Left: address + shipping + totals -->
          <div>
            <div class="fieldGrid">
              <div class="full">
                <div class="mini" style="margin-bottom:6px;">Full name</div>
                <input id="ship_full_name" type="text" autocomplete="name" placeholder="Full name" />
              </div>

              <div>
                <div class="mini" style="margin-bottom:6px;">Email</div>
                <input id="ship_email" type="email" autocomplete="email" placeholder="you@example.com" />
              </div>

              <div>
                <div class="mini" style="margin-bottom:6px;">Phone</div>
                <input id="ship_phone" type="tel" autocomplete="tel" placeholder="(optional but recommended)" />
              </div>

              <div class="full">
                <div class="mini" style="margin-bottom:6px;">Address line 1</div>
                <input id="ship_address1" type="text" autocomplete="address-line1" placeholder="Street address" />
              </div>

              <div class="full">
                <div class="mini" style="margin-bottom:6px;">Address line 2</div>
                <input id="ship_address2" type="text" autocomplete="address-line2" placeholder="Apt, suite, unit (optional)" />
              </div>

              <div>
                <div class="mini" style="margin-bottom:6px;">City</div>
                <input id="ship_city" type="text" autocomplete="address-level2" placeholder="City" />
              </div>

              <div>
                <div class="mini" style="margin-bottom:6px;">State (US)</div>
                <input id="ship_state_code" type="text" autocomplete="address-level1" placeholder="MA" />
              </div>

              <div>
                <div class="mini" style="margin-bottom:6px;">ZIP / Postal</div>
                <input id="ship_zip" type="text" autocomplete="postal-code" placeholder="02110" />
              </div>

              <div>
                <div class="mini" style="margin-bottom:6px;">Country (ISO2)</div>
                <input id="ship_country_code" type="text" autocomplete="country" placeholder="US" />
              </div>
            </div>

            <div class="divider"></div>

            <div class="mini" style="margin-bottom:6px;">Shipping method</div>
            <select id="ship_method">
              <option value="">Get a quote first…</option>
            </select>

            <div class="hint" id="quoteHint">
              We’ll calculate shipping options and totals before you pay.
            </div>

            <div class="divider"></div>

            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
              <span class="pill">Items: <span id="q_items">0</span></span>
              <span class="pill">Subtotal: $<span id="q_subtotal">0.00</span></span>
              <span class="pill">Shipping: $<span id="q_shipping">0.00</span></span>
              <span class="pill">Total: $<span id="q_total">0.00</span></span>
              <span class="pill" id="q_exp" style="display:none;">Expires: <span id="q_exp_time"></span></span>
            </div>
          </div>

          <!-- Right: payment -->
          <div>
            <div class="mini" style="margin-bottom:8px;">Payment</div>
            <div id="card-container"></div>
            <div class="hint" id="payHint">
              Card details are handled by Square securely.
            </div>
            <div class="divider"></div>
            <div id="payStatus" class="notice" style="display:none;"></div>
          </div>
        </div>
      </div>

      <div class="modalActions">
        <button id="btnQuote" class="btn btn-ghost" type="button">Get quote</button>
        <button id="btnPay" class="btn btn-primary" type="button" disabled>Pay</button>
      </div>
    </div>
  </div>

  <!-- Modal: Expired -->
  <div id="expiredOverlay" class="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="expiredTitle">
      <div class="modalHead">
        <div id="expiredTitle" class="modalTitle">Checkout expired</div>
        <button id="expiredClose" class="modalClose" type="button" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" style="width:18px;height:18px;">
            <path d="M6 6l12 12M18 6 6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
          </svg>
        </button>
      </div>
      <div class="modalBody">
        This checkout session expired to keep pricing and shipping accurate. Please reload the page and try again.
      </div>
      <div class="modalActions">
        <button id="expiredReload" class="btn btn-primary" type="button">Reload</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="topbar">
      <div>
        <h1 id="pageTitle">Your Cart</h1>
        <p id="pageSub" class="sub">Everything in one list. Adjust quantities, then checkout.</p>
      </div>
    </div>

    <div id="notice" class="notice" style="display:none;"></div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card list">
        <div id="cartList"></div>
        <div id="cartEmpty" class="empty" style="display:none;">Your cart is empty.</div>
      </div>

      <!-- RIGHT -->
      <div class="card summary">
        <div class="sum-title">Order summary</div>

        <div class="sumline">
          <span>Items</span>
          <strong><span id="itemsCount">0</span></strong>
        </div>

        <div class="sumline">
          <span>Subtotal</span>
          <strong>$<span id="subtotal">0.00</span></strong>
        </div>

        <div class="total">
          <span>Total</span>
          <span>$<span id="total">0.00</span></span>
        </div>

        <div class="helper">Shipping is calculated in the checkout step before payment.</div>

        <div class="cta">
          <button id="checkoutBtn" class="btn btn-primary" type="button">Checkout</button>
          <button id="clearBtn" class="btn btn-ghost" type="button">Clear cart</button>
          <a id="continueBtn" class="btn btn-ghost" href="/products">Continue shopping</a>
          <button id="openDonate" class="btn btn-ghost" type="button">Support / Donate</button>
        </div>

        <div class="helper" style="margin-top:12px;">
          Free items show as <strong>FREE</strong>. Paid physical items require shipping + payment.
        </div>
      </div>
    </div>

    <div class="foot">
      <span id="footer-text"></span>
    </div>
  </div>

  <script type="module">
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import {
      collection, onSnapshot, doc, deleteDoc, updateDoc, serverTimestamp, getDocs
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    import { getFirebase } from "/components/firebase-init.js";
    const { auth, db } = getFirebase();

    /* =============================
       CONFIG
    ============================= */
    const WORKER_BASE = "https://api.unlim8ted.com";

    // Your Square IDs (public + safe on frontend)
    const SQUARE_APP_ID = "sq0idp-Nnvnru9L9hR3CwVKikShGA";
    const SQUARE_LOCATION_ID = "L4KPR2BE0PAA4";

    // Frontend safety expiry: 10 minutes earlier than backend TTL
    // If your backend uses 2 hours: frontend treats it as 1h50m.
    const FRONTEND_QUOTE_TTL_MS = (2 * 60 - 10) * 60 * 1000; // 110 minutes

    /* =============================
       URL mode: single-item checkout
       /cart?source=buy&product=theglitch
    ============================= */
    const QS = new URLSearchParams(location.search);
    const BUY_MODE = (QS.get("source") || "").toLowerCase() === "buy";
    const BUY_PRODUCT = String(QS.get("product") || "").trim();

    /* =============================
       Donation links
    ============================= */
    const SQUARE_DONATION = {
      one_time: {
        custom: "https://square.link/u/h4bY1vEF",
        "1": "https://square.link/u/bWytGN4p",
        "5": "https://square.link/u/4XBSzfLg",
        "10": "https://square.link/u/AvF6x51S",
      },
      weekly: { custom: "https://square.link/u/FkJZDx1R" },
      monthly: { custom: "https://square.link/u/ZK2wPwwU" },
      annual: { custom: "https://square.link/u/ypx1lQj1" }, // replace/remove if you don't have it
    };

    /* =============================
       products.json cache/index
    ============================= */
    let _productsLoaded = false;
    let _productsLoading = null;
    let _productById = new Map();
    let _variantByKey = new Map();
    let _productsArray = [];

    function safeUrl(u) {
      const s = String(u || "").trim();
      if (!s) return "";
      if (s.startsWith("https://") || s.startsWith("http://") || s.startsWith("/")) return s;
      return "";
    }

    async function loadProducts() {
      if (_productsLoaded) return;
      if (_productsLoading) return _productsLoading;

      _productsLoading = (async () => {
        try {
          const r = await fetch("https://unlim8ted.com/tools/data/products.json", { cache: "no-store" });
          if (!r.ok) throw new Error("Failed to load products.json");
          const data = await r.json();
          const products = Array.isArray(data) ? data : (data?.products || []);
          _productsArray = Array.isArray(products) ? products : [];
          indexProducts(_productsArray);
          _productsLoaded = true;
        } catch (e) {
          console.warn("products.json load failed:", e);
        } finally {
          _productsLoading = null;
        }
      })();

      return _productsLoading;
    }

    function indexProducts(products) {
      _productById = new Map();
      _variantByKey = new Map();

      for (const p of (products || [])) {
        const pid = String(p.id ?? p.productId ?? "").trim();
        if (!pid) continue;
        _productById.set(pid, p);

        const vars = Array.isArray(p.varients) ? p.varients : (Array.isArray(p.variants) ? p.variants : []);
        for (const v of vars) {
          const vid = String(v.id ?? v.variantId ?? "").trim();
          if (!vid) continue;
          _variantByKey.set(`${pid}::${vid}`, v);
        }
      }
    }

    function parsePrice(val) {
      if (val == null) return null;
      if (typeof val === "number") return Number.isFinite(val) ? val : null;
      const s = String(val).trim();
      if (!s) return null;
      const cleaned = s.replace(/[^0-9.\-]/g, "");
      if (!cleaned) return null;
      const n = Number(cleaned);
      return Number.isFinite(n) ? n : null;
    }

    function normalizePriceNumber(n) {
      if (!Number.isFinite(n)) return null;
      if (n >= 1000 && Math.abs(n - Math.round(n)) < 1e-9) return n / 100;
      return n;
    }

    const money = (n) => (normalizePriceNumber(Number(n)) ?? 0).toFixed(2);

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, (c) => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
      }[c]));
    }

    function setNotice(kind, msgHtml) {
      const el = document.getElementById("notice");
      el.style.display = "block";
      el.className = "notice " + (kind || "");
      el.innerHTML = msgHtml;
    }

    function clearNotice() {
      const el = document.getElementById("notice");
      el.style.display = "none";
      el.className = "notice";
      el.innerHTML = "";
    }

    /* =============================
       Modal: Confirm (clear cart)
    ============================= */
    const modalOverlay = document.getElementById("modalOverlay");
    const modalTitle = document.getElementById("modalTitle");
    const modalBody = document.getElementById("modalBody");
    const modalClose = document.getElementById("modalClose");
    const modalCancel = document.getElementById("modalCancel");
    const modalConfirm = document.getElementById("modalConfirm");
    let _modalResolver = null;
    let _lastFocus = null;

    function openModal({ title = "Confirm", bodyHtml = "", confirmText = "Confirm", confirmClass = "btn btn-danger" } = {}) {
      modalTitle.textContent = title;
      modalBody.innerHTML = bodyHtml;
      modalConfirm.textContent = confirmText;
      modalConfirm.className = confirmClass;

      modalOverlay.classList.add("show");
      modalOverlay.setAttribute("aria-hidden", "false");
      _lastFocus = document.activeElement;
      setTimeout(() => modalConfirm.focus(), 0);

      return new Promise(resolve => { _modalResolver = resolve; });
    }

    function closeModal(result) {
      modalOverlay.classList.remove("show");
      modalOverlay.setAttribute("aria-hidden", "true");
      const r = _modalResolver;
      _modalResolver = null;
      if (typeof r === "function") r(result);
      if (_lastFocus && typeof _lastFocus.focus === "function") _lastFocus.focus();
    }

    modalClose.addEventListener("click", () => closeModal(false));
    modalCancel.addEventListener("click", () => closeModal(false));
    modalConfirm.addEventListener("click", () => closeModal(true));
    modalOverlay.addEventListener("click", (e) => { if (e.target === modalOverlay) closeModal(false); });
    document.addEventListener("keydown", (e) => {
      if (!modalOverlay.classList.contains("show")) return;
      if (e.key === "Escape") closeModal(false);
    });

    /* =============================
       Modal: Donation popup
    ============================= */
    const donateOverlay = document.getElementById("donateOverlay");
    const donateClose = document.getElementById("donateClose");
    const donateCancel = document.getElementById("donateCancel");
    const donateGo = document.getElementById("donateGo");
    const donateFreq = document.getElementById("donateFreq");
    const donateAmount = document.getElementById("donateAmount");
    let _donateLastFocus = null;

    function openDonateModal() {
      donateOverlay.classList.add("show");
      donateOverlay.setAttribute("aria-hidden", "false");
      _donateLastFocus = document.activeElement;
      setTimeout(() => donateGo.focus(), 0);
    }

    function closeDonateModal() {
      donateOverlay.classList.remove("show");
      donateOverlay.setAttribute("aria-hidden", "true");
      if (_donateLastFocus && typeof _donateLastFocus.focus === "function") _donateLastFocus.focus();
    }

    donateClose.addEventListener("click", closeDonateModal);
    donateCancel.addEventListener("click", closeDonateModal);
    donateOverlay.addEventListener("click", (e) => { if (e.target === donateOverlay) closeDonateModal(); });

    document.addEventListener("keydown", (e) => {
      if (!donateOverlay.classList.contains("show")) return;
      if (e.key === "Escape") closeDonateModal();
    });

    function openPopup(url, name = "popup", features = "width=520,height=760,noopener,noreferrer") {
      return window.open(url, name, features);
    }

    donateGo.addEventListener("click", () => {
      const freq = donateFreq.value;
      const amt = donateAmount.value;

      const url = SQUARE_DONATION?.[freq]?.[amt] || SQUARE_DONATION?.[freq]?.custom || "";
      if (!url) {
        closeDonateModal();
        setNotice("warn", `<strong>Donation link missing.</strong> Update SQUARE_DONATION in this page.`);
        return;
      }

      const popup = openPopup(url, "squareDonate", "width=520,height=760,noopener,noreferrer");
      closeDonateModal();

      if (!popup) {
        setNotice("warn", `<strong>Popup blocked.</strong> Allow popups and try again.`);
        return;
      }

      setNotice("ok",
        `<div style="display:flex;gap:10px;align-items:flex-start">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" style="width:18px;height:18px;margin-top:2px;">
            <path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <div><strong>Donation popup opened.</strong><br/>Thank you for supporting Unlim8ted.</div>
        </div>`
      );
    });

    /* =============================
       Modal: Expired
    ============================= */
    const expiredOverlay = document.getElementById("expiredOverlay");
    const expiredClose = document.getElementById("expiredClose");
    const expiredReload = document.getElementById("expiredReload");
    function showExpired() {
      try { closeCheckoutModal(false); } catch {}
      expiredOverlay.classList.add("show");
      expiredOverlay.setAttribute("aria-hidden", "false");
      setTimeout(() => expiredReload.focus(), 0);
    }
    function closeExpired() {
      expiredOverlay.classList.remove("show");
      expiredOverlay.setAttribute("aria-hidden", "true");
    }
    expiredClose.addEventListener("click", () => { closeExpired(); location.reload(); });
    expiredReload.addEventListener("click", () => location.reload());
    expiredOverlay.addEventListener("click", (e) => { if (e.target === expiredOverlay) location.reload(); });
    document.addEventListener("keydown", (e) => {
      if (!expiredOverlay.classList.contains("show")) return;
      if (e.key === "Escape") location.reload();
    });

    /* =============================
       Checkout modal: open/close + state
    ============================= */
    const checkoutOverlay = document.getElementById("checkoutOverlay");
    const checkoutClose = document.getElementById("checkoutClose");
    const btnQuote = document.getElementById("btnQuote");
    const btnPay = document.getElementById("btnPay");

    const shipMethodEl = document.getElementById("ship_method");
    const payStatusEl = document.getElementById("payStatus");
    const quoteHintEl = document.getElementById("quoteHint");

    const qItemsEl = document.getElementById("q_items");
    const qSubtotalEl = document.getElementById("q_subtotal");
    const qShippingEl = document.getElementById("q_shipping");
    const qTotalEl = document.getElementById("q_total");
    const qExpWrap = document.getElementById("q_exp");
    const qExpTime = document.getElementById("q_exp_time");

    let _checkoutLastFocus = null;
    let _quote = null;                 // { quoteId, expiresAt? , shippingOptions, subtotal, itemsCount }
    let _quoteExpiresAt = 0;           // ms epoch (frontend safety)
    let _quoteExpireTimer = null;

    let _squarePayments = null;
    let _squareCard = null;
    let _cardMounted = false;

    function setPayStatus(kind, html) {
      payStatusEl.style.display = "block";
      payStatusEl.className = "notice " + (kind || "");
      payStatusEl.innerHTML = html;
    }
    function clearPayStatus() {
      payStatusEl.style.display = "none";
      payStatusEl.className = "notice";
      payStatusEl.innerHTML = "";
    }

    function openCheckoutModal() {
      checkoutOverlay.classList.add("show");
      checkoutOverlay.setAttribute("aria-hidden", "false");
      _checkoutLastFocus = document.activeElement;
      setTimeout(() => btnQuote.focus(), 0);
    }

    function closeCheckoutModal() {
      checkoutOverlay.classList.remove("show");
      checkoutOverlay.setAttribute("aria-hidden", "true");
      if (_checkoutLastFocus && typeof _checkoutLastFocus.focus === "function") _checkoutLastFocus.focus();
    }

    checkoutClose.addEventListener("click", () => closeCheckoutModal());
    checkoutOverlay.addEventListener("click", (e) => { if (e.target === checkoutOverlay) closeCheckoutModal(); });
    document.addEventListener("keydown", (e) => {
      if (!checkoutOverlay.classList.contains("show")) return;
      if (e.key === "Escape") closeCheckoutModal();
    });

    function resetCheckoutState() {
      _quote = null;
      _quoteExpiresAt = 0;
      if (_quoteExpireTimer) clearTimeout(_quoteExpireTimer);
      _quoteExpireTimer = null;

      shipMethodEl.innerHTML = `<option value="">Get a quote first…</option>`;
      btnPay.disabled = true;
      clearPayStatus();

      qItemsEl.textContent = "0";
      qSubtotalEl.textContent = "0.00";
      qShippingEl.textContent = "0.00";
      qTotalEl.textContent = "0.00";
      qExpWrap.style.display = "none";
      qExpTime.textContent = "";

      quoteHintEl.textContent = "We’ll calculate shipping options and totals before you pay.";

      // keep card mounted but disable pay until quote exists
    }

    /* =============================
       Catalog resolution
    ============================= */
    function resolveProductImage(productId, variantId) {
      const pid = String(productId || "").trim();
      if (!pid) return "";
      const p = _productById.get(pid) || null;
      if (!p) return "";

      const vid = String(variantId || "").trim();
      if (vid) {
        const v = _variantByKey.get(`${pid}::${vid}`) || null;
        const vImg =
          (v && Array.isArray(v.images) && v.images.length && safeUrl(v.images[0])) ||
          safeUrl(v?.image) ||
          safeUrl(v?.imageUrl) ||
          safeUrl(v?.thumbnail) ||
          "";
        if (vImg) return vImg;
      }

      const pImg =
        safeUrl(p.image) ||
        safeUrl(p.imageUrl) ||
        safeUrl(p.thumbnail) ||
        safeUrl(p.thumb) ||
        "";
      if (pImg) return pImg;

      if (Array.isArray(p.images) && p.images.length) {
        const first = p.images[0];
        if (typeof first === "string") return safeUrl(first);
        if (first && typeof first === "object") return safeUrl(first.url || first.src || first.imageUrl || first.image);
      }
      return "";
    }

    function resolveFromCatalog(item) {
      const it = { ...(item || {}) };
      const productId = String(it.productId || "").trim();
      const variantId = String(it.variantId || "").trim();

      const p = productId ? (_productById.get(productId) || null) : null;
      const v = (productId && variantId) ? (_variantByKey.get(`${productId}::${variantId}`) || null) : null;

      if (!String(it.title || it.name || "").trim()) {
        it.title = String(p?.name || p?.title || productId || it.id || "Item").trim();
      }

      if (!String(it.variantLabel || "").trim()) {
        it.variantLabel = String(v?.name || "").trim();
      }

      const hasPrice =
        it.price !== null &&
        it.price !== undefined &&
        Number.isFinite(Number(it.price));

      if (!hasPrice) {
        const catalogPrice =
          (v && Number.isFinite(Number(v.price)) ? Number(v.price) : null) ??
          (p && Number.isFinite(Number(p.price)) ? Number(p.price) : null) ??
          null;
        if (catalogPrice !== null) it.price = catalogPrice;
      }

      const hasImage = !!safeUrl(it.image || it.imageUrl || "");
      if (!hasImage) {
        const img = resolveProductImage(productId, variantId);
        if (img) it.image = img;
      }

      return it;
    }

    function getProductByQueryKey(keyRaw) {
      const key = String(keyRaw || "").trim().toLowerCase();
      if (!key) return null;

      for (const [pid, p] of _productById.entries()) {
        if (String(pid).toLowerCase() === key) return p;
      }

      for (const p of (_productsArray || [])) {
        const candidates = [
          p.id, p.productId, p.slug, p.handle, p.key, p.shortId,
          p?.meta?.slug, p?.meta?.handle
        ].filter(Boolean).map(x => String(x).trim().toLowerCase());
        if (candidates.includes(key)) return p;
      }

      for (const p of (_productsArray || [])) {
        const name = String(p.name || p.title || "").trim().toLowerCase();
        if (name && name.replace(/\s+/g, "") === key.replace(/\s+/g, "")) return p;
      }

      return null;
    }

    function pickDefaultVariant(product) {
      const vars = Array.isArray(product?.varients) ? product.varients : (Array.isArray(product?.variants) ? product.variants : []);
      if (!vars.length) return null;
      for (const v of vars) {
        const vid = String(v?.id ?? v?.variantId ?? "").trim();
        if (vid) return v;
      }
      return vars[0] || null;
    }

    /* =============================
       Local cart helpers (signed-out)
    ============================= */
    function getLocalCart() {
      try {
        const raw = localStorage.getItem("unlim8ted-cart");
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch { return []; }
    }

    function setLocalCart(items) {
      try {
        localStorage.setItem("unlim8ted-cart", JSON.stringify(items || []));
        window.dispatchEvent(new CustomEvent("cart-changed"));
      } catch { }
    }

    /* =============================
       Cart state + listeners
    ============================= */
    let currentUser = null;
    let cartItems = [];
    let unsubCart = null;

    async function emitCart(items) {
      await loadProducts();
      cartItems = (items || []).map(x => resolveFromCatalog(x));
      renderCart();
    }

    window.addEventListener("cart-changed", () => {
      if (BUY_MODE) return;
      if (!currentUser) emitCart(getLocalCart());
    });

    function startCartData() {
      onAuthStateChanged(auth, (user) => {
        currentUser = user || null;

        if (unsubCart) { unsubCart(); unsubCart = null; }
        if (BUY_MODE) return;

        if (!user) {
          emitCart(getLocalCart());
          return;
        }

        const cartRef = collection(db, "users", user.uid, "cartItems");
        unsubCart = onSnapshot(cartRef, (snap) => {
          const raw = [];
          snap.forEach(d => {
            const data = d.data() || {};
            raw.push({
              id: d.id,
              productId: data.productId ?? null,
              variantId: data.variantId ?? null,
              variantLabel: data.variantLabel ?? "",
              title: data.title || data.name || data.productName || "",
              price: (data.price ?? data.priceNum ?? null),
              qty: Number.isFinite(data.qty) ? Number(data.qty) : 1,
              image: data.image ?? data.imageUrl ?? null,
              accessUrl: data.accessUrl ?? data.downloadUrl ?? data.url ?? data.link ?? null,
            });
          });
          emitCart(raw);
        });
      });
    }

    /* =============================
       Cart mutations
    ============================= */
    async function setQty(id, qty) {
      qty = Math.max(1, qty | 0);

      if (BUY_MODE) {
        const idx = cartItems.findIndex(x => String(x.id) === String(id));
        if (idx >= 0) {
          cartItems[idx].qty = qty;
          renderCart();
        }
        return;
      }

      if (!currentUser?.uid) {
        const arr = getLocalCart();
        const idx = arr.findIndex(x => String(x.id) === String(id));
        if (idx >= 0) {
          arr[idx].qty = qty;
          setLocalCart(arr);
        }
        return;
      }

      await updateDoc(doc(db, "users", currentUser.uid, "cartItems", id), {
        qty,
        updatedAt: serverTimestamp(),
      });
    }

    async function removeItem(id) {
      if (BUY_MODE) {
        cartItems = cartItems.filter(x => String(x.id) !== String(id));
        renderCart();
        return;
      }

      if (!currentUser?.uid) {
        setLocalCart(getLocalCart().filter(x => String(x.id) !== String(id)));
        return;
      }
      await deleteDoc(doc(db, "users", currentUser.uid, "cartItems", id));
    }

    async function clearCart() {
      if (BUY_MODE) {
        cartItems = [];
        renderCart();
        return;
      }

      if (!currentUser?.uid) {
        setLocalCart([]);
        return;
      }
      const snap = await getDocs(collection(db, "users", currentUser.uid, "cartItems"));
      await Promise.all(snap.docs.map(d => deleteDoc(d.ref)));
    }

    /* =============================
       Checkout helpers
    ============================= */
    function getPaidPhysicalItems(allItems) {
      return (allItems || [])
        .map(it => {
          const qty = Math.max(1, Number(it.qty) || 1);
          const price = normalizePriceNumber(parsePrice(it.price)) || 0;
          const variationId = String(it.variantId || "").trim();
          return { ...it, qty, price, variationId };
        })
        .filter(x => x.price > 0); // treat all paid items as needing shipping/payment
    }

    function findPaidMissingVariant(allItems) {
      return (allItems || [])
        .map(it => ({
          title: String(it.title || it.name || "Item"),
          price: normalizePriceNumber(parsePrice(it.price)) || 0,
          variationId: String(it.variantId || "").trim()
        }))
        .filter(x => x.price > 0 && !x.variationId);
    }

    function getShippingForm() {
      const get = (id) => document.getElementById(id).value.trim();
      return {
        full_name: get("ship_full_name"),
        email: get("ship_email"),
        phone: get("ship_phone"),
        address1: get("ship_address1"),
        address2: get("ship_address2"),
        city: get("ship_city"),
        state_code: get("ship_state_code"),
        zip: get("ship_zip"),
        country_code: get("ship_country_code").toUpperCase(),
      };
    }

    function validateShippingForm(s) {
      const errs = [];

      const req = (field, label) => {
        if (!String(s[field] || "").trim()) errs.push(`${label} is required.`);
      };

      req("full_name", "Full name");
      req("email", "Email");
      req("address1", "Address line 1");
      req("city", "City");
      req("zip", "ZIP / Postal");
      req("country_code", "Country");

      // basic email
      if (s.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s.email)) errs.push("Email looks invalid.");

      // US specific
      if (s.country_code === "US") {
        if (!/^[A-Z]{2}$/.test(String(s.state_code || "").toUpperCase())) errs.push("State must be 2 letters (US).");
        if (!/^\d{5}(-\d{4})?$/.test(String(s.zip || ""))) errs.push("ZIP must be 5 digits (or 5+4).");
      }

      // phone: optional, but if present must have enough digits
      if (s.phone) {
        const digits = s.phone.replace(/[^\d]/g, "");
        if (digits.length < 7) errs.push("Phone looks too short.");
      }

      return errs;
    }

    function centsToUsdString(cents) {
      const n = Number(cents || 0) / 100;
      return n.toFixed(2);
    }

    function computeSubtotalCents(items) {
      return (items || []).reduce((sum, it) => {
        const qty = Math.max(1, Number(it.qty) || 1);
        const price = normalizePriceNumber(parsePrice(it.price)) || 0;
        return sum + Math.round(price * 100) * qty;
      }, 0);
    }

    function scheduleQuoteExpiry(expiresAtMs) {
      if (_quoteExpireTimer) clearTimeout(_quoteExpireTimer);
      const msLeft = Math.max(0, expiresAtMs - Date.now());
      _quoteExpireTimer = setTimeout(() => showExpired(), msLeft);
    }

    function formatTime(msEpoch) {
      const d = new Date(msEpoch);
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      return `${hh}:${mm}`;
    }

    async function ensureSquareCardMounted() {
      if (!window.Square) throw new Error("Square Web Payments SDK not loaded.");
      if (_cardMounted && _squareCard) return;

      _squarePayments = _squarePayments || window.Square.payments(SQUARE_APP_ID, SQUARE_LOCATION_ID);
      _squareCard = _squareCard || await _squarePayments.card();

      // attach once
      await _squareCard.attach("#card-container");
      _cardMounted = true;
    }

    /* =============================
       Worker calls
    ============================= */
    async function workerQuote(payload) {
      const res = await fetch(`${WORKER_BASE}/quote`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const j = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(j?.error ? `${j.error}: ${JSON.stringify(j.details || j)}` : `HTTP ${res.status}`);
      return j;
    }

    async function workerPay(payload) {
      const res = await fetch(`${WORKER_BASE}/pay`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const j = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(j?.error ? `${j.error}: ${JSON.stringify(j.details || j)}` : `HTTP ${res.status}`);
      return j;
    }

    async function workerPaymentStatus(quoteId) {
      const res = await fetch(`${WORKER_BASE}/payment-status?quoteId=${encodeURIComponent(quoteId)}`, { method: "GET" });
      const j = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(j?.error ? `${j.error}` : `HTTP ${res.status}`);
      return j;
    }

    /* =============================
       Checkout flow
    ============================= */
    async function beginCheckoutFlow() {
      clearNotice();

      if (!cartItems.length) {
        setNotice("warn", `<strong>Your cart is empty.</strong> Add something first.`);
        return;
      }

      // free-only cart shortcut
      const paid = getPaidPhysicalItems(cartItems);
      if (!paid.length) {
        setNotice("ok",
          `<div style="display:flex;gap:10px;align-items:flex-start">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" style="width:18px;height:18px;margin-top:2px;">
              <path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <div><strong>No paid items.</strong><br/>Your free items are ready via their links.</div>
          </div>`
        );
        return;
      }

      // block if paid items missing variant id
      const missing = findPaidMissingVariant(cartItems);
      if (missing.length) {
        setNotice("warn",
          `<strong>Some paid items can’t be checked out yet.</strong><br/>
           These need a variantId in your cart data/products.json:<br/>
           <div style="margin-top:6px;opacity:.9">${missing.map(m => `• ${escapeHtml(m.title)}`).join("<br/>")}</div>`
        );
        return;
      }

      resetCheckoutState();
      openCheckoutModal();

      try {
        await ensureSquareCardMounted();
      } catch (err) {
        console.error(err);
        setNotice("bad", `<strong>Payment system error:</strong> ${escapeHtml(err?.message || String(err))}`);
        closeCheckoutModal();
      }

      // seed totals (subtotal only) in the modal UI
      const itemsCount = cartItems.reduce((s, it) => s + (Number(it.qty) || 1), 0);
      const subtotalCents = computeSubtotalCents(paid);
      qItemsEl.textContent = String(itemsCount);
      qSubtotalEl.textContent = centsToUsdString(subtotalCents);
      qShippingEl.textContent = "0.00";
      qTotalEl.textContent = centsToUsdString(subtotalCents);
    }

    btnQuote.addEventListener("click", async () => {
      clearPayStatus();

      const paid = getPaidPhysicalItems(cartItems);
      if (!paid.length) {
        setPayStatus("warn", `<strong>No paid items.</strong> Nothing to quote.`);
        return;
      }

      const shipping = getShippingForm();
      const errs = validateShippingForm(shipping);
      if (errs.length) {
        setPayStatus("warn",
          `<strong>Please fix:</strong><br/>${errs.map(e => `• ${escapeHtml(e)}`).join("<br/>")}`
        );
        return;
      }

      btnQuote.disabled = true;
      btnPay.disabled = true;
      shipMethodEl.disabled = true;
      shipMethodEl.innerHTML = `<option value="">Calculating…</option>`;
      quoteHintEl.textContent = "Calculating shipping options…";

      try {
        const itemsPayload = paid.map(it => ({
          variationId: String(it.variantId).trim(),
          quantity: Math.max(1, Number(it.qty) || 1),
          // send price so backend can compute subtotal; backend should still trust products.json if you want stricter security
          price: normalizePriceNumber(parsePrice(it.price)) || 0,
          productId: it.productId || null,
          title: it.title || it.name || "Item",
        }));

        const resp = await workerQuote({
          currency: "USD",
          items: itemsPayload,
          shipping,
          context: {
            uid: currentUser?.uid || null,
            mode: BUY_MODE ? "buy" : "cart",
            product: BUY_MODE ? BUY_PRODUCT : null
          }
        });

        // Expected from worker:
        // { quoteId, shippingOptions: [{id,name,cost,estimated_days?}], subtotal, expiresAt? }
        const quoteId = String(resp.quoteId || "").trim();
        const shippingOptions = Array.isArray(resp.shippingOptions) ? resp.shippingOptions : [];
        const subtotalCents = typeof resp.subtotal === "number" ? resp.subtotal : computeSubtotalCents(paid);

        if (!quoteId) throw new Error("Worker did not return quoteId.");
        if (!shippingOptions.length) throw new Error("No shipping options returned.");

        _quote = { quoteId, shippingOptions, subtotalCents };

        // expiry: if worker provides expiresAt, still apply a safety clamp to be "10 min earlier"
        const workerExpiresAt = Number(resp.expiresAt || 0);
        const frontendExpiresAt = Date.now() + FRONTEND_QUOTE_TTL_MS;
        _quoteExpiresAt = workerExpiresAt > 0 ? Math.min(workerExpiresAt, frontendExpiresAt) : frontendExpiresAt;

        scheduleQuoteExpiry(_quoteExpiresAt);

        qExpWrap.style.display = "inline-flex";
        qExpTime.textContent = formatTime(_quoteExpiresAt);

        // populate shipping select
        shipMethodEl.innerHTML = "";
        for (const opt of shippingOptions) {
          const id = String(opt.id || "").trim();
          const name = String(opt.name || opt.service_name || "Shipping").trim();
          const cost = Number(opt.cost || 0); // cents
          const days = opt.estimated_days ? String(opt.estimated_days) : "";
          const label = days ? `${name} — $${centsToUsdString(cost)} (${days} days)` : `${name} — $${centsToUsdString(cost)}`;

          const o = document.createElement("option");
          o.value = id;
          o.textContent = label;
          shipMethodEl.appendChild(o);
        }

        shipMethodEl.disabled = false;

        // default select first option
        const first = shipMethodEl.value;
        const shipCents = Number(shippingOptions.find(x => String(x.id) === String(first))?.cost || 0);

        qItemsEl.textContent = String(cartItems.reduce((s, it) => s + (Number(it.qty) || 1), 0));
        qSubtotalEl.textContent = centsToUsdString(subtotalCents);
        qShippingEl.textContent = centsToUsdString(shipCents);
        qTotalEl.textContent = centsToUsdString(subtotalCents + shipCents);

        quoteHintEl.textContent = "Quote ready. Choose a shipping method, then pay.";
        btnPay.disabled = false;
        setPayStatus("ok",
          `<div style="display:flex;gap:10px;align-items:flex-start">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" style="width:18px;height:18px;margin-top:2px;">
              <path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <div><strong>Quote created.</strong><br/>Complete payment before it expires.</div>
          </div>`
        );

      } catch (err) {
        console.error(err);
        shipMethodEl.innerHTML = `<option value="">Get a quote first…</option>`;
        shipMethodEl.disabled = true;
        quoteHintEl.textContent = "We’ll calculate shipping options and totals before you pay.";
        setPayStatus("bad", `<strong>Quote error:</strong> ${escapeHtml(err?.message || String(err))}`);
      } finally {
        btnQuote.disabled = false;
      }
    });

    shipMethodEl.addEventListener("change", () => {
      if (!_quote) return;
      const id = shipMethodEl.value;
      const shipCents = Number(_quote.shippingOptions.find(x => String(x.id) === String(id))?.cost || 0);
      qShippingEl.textContent = centsToUsdString(shipCents);
      qTotalEl.textContent = centsToUsdString(_quote.subtotalCents + shipCents);
    });

    btnPay.addEventListener("click", async () => {
      clearPayStatus();

      if (!_quote?.quoteId) {
        setPayStatus("warn", `<strong>Get a quote first.</strong>`);
        return;
      }

      if (Date.now() >= _quoteExpiresAt) {
        showExpired();
        return;
      }

      const selectedShippingId = String(shipMethodEl.value || "").trim();
      if (!selectedShippingId) {
        setPayStatus("warn", `<strong>Select a shipping method.</strong>`);
        return;
      }

      btnPay.disabled = true;
      btnQuote.disabled = true;
      shipMethodEl.disabled = true;

      setPayStatus("warn", `<strong>Processing payment…</strong> Do not refresh.`);

      try {
        await ensureSquareCardMounted();

        const tokenizeResult = await _squareCard.tokenize();
        if (tokenizeResult.status !== "OK") {
          const msg = tokenizeResult.errors?.[0]?.message || "Card tokenization failed.";
          throw new Error(msg);
        }

        if (Date.now() >= _quoteExpiresAt) {
          showExpired();
          return;
        }

        // Pay via worker
        const payResp = await workerPay({
          quoteId: _quote.quoteId,
          selectedShippingId,
          sourceId: tokenizeResult.token,
        });

        // Poll status (authoritative check)
        const start = Date.now();
        const maxMs = Math.max(0, _quoteExpiresAt - Date.now());
        const hardStop = Math.min(maxMs, 60 * 1000); // stop polling after 60s or expiry (whichever first)

        while (true) {
          if (Date.now() >= _quoteExpiresAt) {
            showExpired();
            return;
          }
          if (Date.now() - start > hardStop) break;

          const st = await workerPaymentStatus(_quote.quoteId);

          const status = String(st.squareStatus || st.status || "").toLowerCase();
          if (status === "paid" || status === "completed") {
            setPayStatus("ok",
              `<div style="display:flex;gap:10px;align-items:flex-start">
                <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" style="width:18px;height:18px;margin-top:2px;">
                  <path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <div><strong>Payment confirmed.</strong><br/>Thank you! Your order will be processed.</div>
              </div>`
            );

            // Clear cart (paid items) on success
            // For now: clear entire cart for simplicity; adjust if you mix digital/free.
            try { await clearCart(); } catch {}
            renderCart();

            // Close modal after a moment
            setTimeout(() => closeCheckoutModal(), 900);
            return;
          }

          if (status === "failed" || status === "canceled") {
            setPayStatus("bad", `<strong>Payment failed.</strong> Please try again.`);
            btnPay.disabled = false;
            btnQuote.disabled = false;
            shipMethodEl.disabled = false;
            return;
          }

          // pending
          await new Promise(r => setTimeout(r, 1200));
        }

        setPayStatus("warn",
          `<strong>Payment processing.</strong><br/>If you were charged, it will finalize shortly. You can keep this page open and retry “Pay” if needed.`
        );

      } catch (err) {
        console.error(err);
        setPayStatus("bad", `<strong>Payment error:</strong> ${escapeHtml(err?.message || String(err))}`);
      } finally {
        if (!expiredOverlay.classList.contains("show")) {
          btnQuote.disabled = false;
          shipMethodEl.disabled = !_quote;
          btnPay.disabled = !_quote;
        }
      }
    });

    /* =============================
       Render
    ============================= */
    function itemHTML(it) {
      const qty = Math.max(1, Number(it.qty) || 1);
      const price = normalizePriceNumber(parsePrice(it.price)) || 0;

      const title = escapeHtml(it.title || it.name || "Item");
      const variantLabel = String(it.variantLabel || "").trim();
      const variantLine = variantLabel
        ? `<div class="mini">Variant: <strong>${escapeHtml(variantLabel)}</strong></div>`
        : ``;

      const imgUrl = safeUrl(it.image || it.imageUrl || "");
      const img = imgUrl ? `<img src="${escapeHtml(imgUrl)}" alt="">` : "No image";

      const priceHtml = price > 0
        ? `$${money(price)}`
        : `<span class="free">FREE</span>`;

      return `
        <div class="item">
          <div class="thumb">${img}</div>

          <div class="meta">
            <div class="title">${title}</div>
            ${variantLine}

            <div class="row2">
              <div class="price">${priceHtml}</div>

              <div class="qty" aria-label="Quantity">
                <button type="button" data-dec="${escapeHtml(it.id)}" aria-label="Decrease quantity">−</button>
                <input type="text" inputmode="numeric" value="${qty}" data-qty="${escapeHtml(it.id)}" aria-label="Quantity value">
                <button type="button" data-inc="${escapeHtml(it.id)}" aria-label="Increase quantity">+</button>
              </div>
            </div>

            ${
              safeUrl(it.accessUrl) && price <= 0
                ? `<div class="mini">Free access: <a href="${escapeHtml(it.accessUrl)}" target="_blank" rel="noopener" style="color:rgba(99,214,255,.95);text-decoration:none;font-weight:900;">Open link</a></div>`
                : ``
            }
          </div>

          <div class="actions">
            <button class="iconbtn" type="button" data-remove="${escapeHtml(it.id)}" title="Remove" aria-label="Remove">
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" style="width:18px;height:18px;">
                <path d="M4 7h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                <path d="M10 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                <path d="M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                <path d="M6 7l1 14h10l1-14" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                <path d="M9 7V4h6v3" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              </svg>
            </button>
          </div>
        </div>
      `;
    }

    function renderCart() {
      const list = document.getElementById("cartList");
      const empty = document.getElementById("cartEmpty");

      list.innerHTML = "";
      if (!cartItems.length) {
        empty.style.display = "block";
      } else {
        empty.style.display = "none";
        for (const it of cartItems) {
          const d = document.createElement("div");
          d.innerHTML = itemHTML(it);
          list.appendChild(d.firstElementChild);
        }
      }

      const itemsCount = cartItems.reduce((s, it) => s + (Number(it.qty) || 1), 0);
      const subtotal = cartItems.reduce((s, it) => {
        const price = normalizePriceNumber(parsePrice(it.price)) || 0;
        return s + price * (Number(it.qty) || 1);
      }, 0);

      document.getElementById("itemsCount").textContent = String(itemsCount);
      document.getElementById("subtotal").textContent = money(subtotal);
      document.getElementById("total").textContent = money(subtotal);

      const checkoutBtn = document.getElementById("checkoutBtn");
      checkoutBtn.disabled = cartItems.length === 0;

      if (BUY_MODE) {
        const it = cartItems[0] || null;
        const price = it ? (normalizePriceNumber(parsePrice(it.price)) || 0) : 0;
        const url = it ? safeUrl(it.accessUrl) : "";
        checkoutBtn.textContent = (it && price <= 0 && url) ? "Get free item" : "Checkout";
      } else {
        checkoutBtn.textContent = "Checkout";
      }

      const clearBtn = document.getElementById("clearBtn");
      clearBtn.disabled = cartItems.length === 0 || BUY_MODE;
      clearBtn.style.display = BUY_MODE ? "none" : "inline-flex";
    }

    /* =============================
       UI events
    ============================= */
    document.addEventListener("click", async (e) => {
      const rm = e.target.closest("[data-remove]");
      if (rm) {
        const id = rm.getAttribute("data-remove");
        try { await removeItem(id); } catch (err) { console.error(err); }
        return;
      }

      const inc = e.target.closest("[data-inc]");
      if (inc) {
        const id = inc.getAttribute("data-inc");
        const input = document.querySelector(`[data-qty="${CSS.escape(id)}"]`);
        const current = Math.max(1, parseInt(input?.value || "1", 10) || 1);
        input.value = String(current + 1);
        try { await setQty(id, current + 1); } catch (err) { console.error(err); }
        return;
      }

      const dec = e.target.closest("[data-dec]");
      if (dec) {
        const id = dec.getAttribute("data-dec");
        const input = document.querySelector(`[data-qty="${CSS.escape(id)}"]`);
        const current = Math.max(1, parseInt(input?.value || "1", 10) || 1);
        const next = Math.max(1, current - 1);
        input.value = String(next);
        try { await setQty(id, next); } catch (err) { console.error(err); }
        return;
      }

      if (e.target.closest("#checkoutBtn")) {
        // BUY mode free item: open link instead of checkout
        if (BUY_MODE && cartItems.length === 1) {
          const it = cartItems[0];
          const price = normalizePriceNumber(parsePrice(it.price)) || 0;
          const url = safeUrl(it.accessUrl);

          if (price <= 0 && url) {
            setNotice("ok",
              `<div style="display:flex;gap:10px;align-items:flex-start">
                <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" style="width:18px;height:18px;margin-top:2px;">
                  <path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <div><strong>Opening your free item…</strong></div>
              </div>`
            );
            window.open(url, "_blank", "noopener,noreferrer");
            return;
          }
        }

        await beginCheckoutFlow();
        return;
      }

      if (e.target.closest("#clearBtn")) {
        if (BUY_MODE) return;
        clearNotice();
        if (!cartItems.length) return;

        const ok = await openModal({
          title: "Clear cart?",
          bodyHtml: `This will remove <strong>all items</strong> from your cart. This can’t be undone.`,
          confirmText: "Clear cart",
          confirmClass: "btn btn-danger"
        });

        if (!ok) return;
        try { await clearCart(); } catch (err) { console.error(err); }
        return;
      }

      if (e.target.closest("#openDonate")) {
        openDonateModal();
        return;
      }
    });

    let t = null;
    document.addEventListener("input", (e) => {
      const inp = e.target.closest("[data-qty]");
      if (!inp) return;

      const id = inp.getAttribute("data-qty");
      let qty = parseInt(inp.value, 10);
      if (!Number.isFinite(qty) || qty < 1) qty = 1;

      clearTimeout(t);
      t = setTimeout(async () => {
        try { await setQty(id, qty); } catch (err) { console.error(err); }
      }, 300);
    });

    /* =============================
       BUY MODE bootstrap
    ============================= */
    async function startBuyMode(productKey) {
      await loadProducts();

      const p = getProductByQueryKey(productKey);
      if (!p) {
        cartItems = [];
        renderCart();
        setNotice("warn",
          `<strong>Product not found:</strong> ${escapeHtml(productKey)}<br/>
           <a href="/products" style="color:rgba(99,214,255,.95);text-decoration:none;font-weight:900;">Go to products</a>`
        );
        return;
      }

      const pid = String(p.id ?? p.productId ?? "").trim();
      const v = pickDefaultVariant(p);
      const vid = String(v?.id ?? v?.variantId ?? "").trim();

      const price = normalizePriceNumber(parsePrice(v?.price ?? p?.price)) || 0;
      const accessUrl = p.accessUrl ?? p.downloadUrl ?? p.url ?? p.link ?? null;

      if (price > 0 && !vid) {
        cartItems = [];
        renderCart();
        setNotice("warn",
          `<strong>This product can’t be purchased yet.</strong><br/>
           Missing variantId in products.json for <strong>${escapeHtml(pid || productKey)}</strong>.`
        );
        return;
      }

      if (price <= 0 && !safeUrl(accessUrl)) {
        cartItems = [];
        renderCart();
        setNotice("warn",
          `<strong>This free item is missing its link.</strong><br/>
           Add <code>accessUrl</code> (or <code>downloadUrl/url/link</code>) in products.json.`
        );
        return;
      }

      const image = resolveProductImage(pid, vid) || safeUrl(p.image || p.imageUrl || "");
      const title = String(p.name || p.title || pid || productKey || "Item").trim();
      const variantLabel = String(v?.name || "").trim();

      cartItems = [
        resolveFromCatalog({
          id: `buy-${pid}-${vid || "free"}`,
          productId: pid,
          variantId: vid || null,
          title,
          variantLabel,
          price,
          qty: 1,
          image: image || null,
          accessUrl
        })
      ];

      renderCart();
      clearNotice();
    }

    /* =============================
       Start
    ============================= */
    const y = new Date().getFullYear();
    document.getElementById("footer-text").innerHTML =
      `&copy; 2019-${y} Unlim8ted Studio Productions. All rights reserved.`;

    if (BUY_MODE) {
      document.getElementById("pageTitle").textContent = "Checkout";
      document.getElementById("pageSub").textContent = "One item. Adjust quantity, then checkout.";
      document.getElementById("continueBtn").textContent = "Back to products";
      document.getElementById("continueBtn").setAttribute("href", "/products");
      document.title = "Unlim8ted - Checkout";
      document.getElementById("openDonate").style.display = "none";
    }

    loadProducts().catch(() => { });
    startCartData();

    if (BUY_MODE) {
      if (!BUY_PRODUCT) {
        setNotice("warn",
          `<strong>Missing product.</strong> Use <code>?source=buy&amp;product=theglitch</code><br/>
           <a href="/products" style="color:rgba(99,214,255,.95);text-decoration:none;font-weight:900;">Go to products</a>`
        );
      } else {
        startBuyMode(BUY_PRODUCT).catch(err => {
          console.error(err);
          setNotice("warn", `<strong>Error:</strong> ${escapeHtml(err?.message || String(err))}`);
        });
      }
    } else {
      renderCart();
    }

    // Prefill country default for convenience
    document.getElementById("ship_country_code").value = "US";
  </script>
</body>

</html>
