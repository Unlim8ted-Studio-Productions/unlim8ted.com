<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Unlim8ted - Cart</title>
  <meta name="description" content="View your Unlim8ted cart, powered by Unlim8ted Studio Productions" />
  <link rel="icon" href="https://unlim8ted.com/favicon.ico" type="image/x-icon">

  <!-- Components -->
  <script type="module" src="/components/site-navbar.js"></script>
  <script type="module" src="/components/site-loader.js"></script>

  <style>
    :root {
      --bg0: #05040a;
      --bg1: #0c0620;
      --ink: rgba(233, 231, 255, .92);
      --muted: rgba(233, 231, 255, .72);
      --glass: rgba(0, 0, 0, .38);
      --stroke: rgba(180, 130, 255, .24);
      --accent: #b86bff;
      --accent2: #63d6ff;
      --danger: #ff4d4d;
      --shadow: 0 18px 40px rgba(0, 0, 0, .45);
      --r: 18px;
    }

    body {
      margin: 0;
      color: var(--ink);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 600px at 20% 15%, rgba(184, 107, 255, .16), transparent 55%),
        radial-gradient(900px 650px at 80% 25%, rgba(99, 214, 255, .14), transparent 60%),
        radial-gradient(900px 700px at 55% 95%, rgba(255, 77, 45, .08), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height: 100vh;
      padding-top: 56px;
    }

    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 28px 16px 70px;
    }

    .topbar {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 14px;
      margin-bottom: 14px;
    }

    h1 {
      margin: 0;
      font-size: 28px;
      letter-spacing: .2px;
    }

    .sub {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 14px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1.55fr .85fr;
      gap: 16px;
      align-items: start;
    }

    .card {
      background: var(--glass);
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
    }

    .list {
      padding: 14px;
    }

    .notice {
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, .10);
      background: rgba(255, 255, 255, .06);
      color: var(--muted);
      margin-bottom: 12px;
      font-size: 13px;
      line-height: 1.35;
    }

    .notice strong {
      color: rgba(255, 255, 255, .92);
    }

    .notice.ok {
      border-color: rgba(99, 214, 255, .22);
      background: rgba(99, 214, 255, .08);
      color: rgba(255, 255, 255, .82);
    }

    .notice.warn {
      border-color: rgba(255, 209, 102, .22);
      background: rgba(255, 209, 102, .08);
      color: rgba(255, 255, 255, .78);
    }

    .empty {
      padding: 18px;
      color: var(--muted);
    }

    .item {
      display: grid;
      grid-template-columns: 88px 1fr auto;
      gap: 14px;
      padding: 12px;
      border-radius: 16px;
      background: rgba(255, 255, 255, .04);
      border: 1px solid rgba(255, 255, 255, .06);
      margin-bottom: 10px;
      align-items: center;
    }

    .thumb {
      width: 88px;
      height: 88px;
      border-radius: 16px;
      overflow: hidden;
      background: rgba(255, 255, 255, .07);
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255, 255, 255, .55);
      font-size: 12px;
      border: 1px solid rgba(255, 255, 255, .08);
    }

    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .meta {
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .title {
      font-size: 15px;
      font-weight: 850;
      letter-spacing: .2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .mini {
      font-size: 12px;
      color: rgba(255, 255, 255, .64);
    }

    .row2 {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .price {
      font-weight: 900;
      color: rgba(255, 255, 255, .92);
    }

    .price .free {
      color: rgba(99, 214, 255, .95);
      letter-spacing: .3px;
    }

    .qty {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, .06);
      border: 1px solid rgba(255, 255, 255, .10);
      border-radius: 999px;
      padding: 6px 10px;
    }

    .qty button {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: rgba(255, 255, 255, .08);
      color: var(--ink);
      font-size: 18px;
      line-height: 0;
    }

    .qty button:hover {
      background: rgba(184, 107, 255, .16);
      color: rgba(184, 107, 255, 1);
    }

    .qty input {
      width: 42px;
      border: none;
      background: transparent;
      color: var(--ink);
      text-align: center;
      outline: none;
      font-weight: 900;
      font-size: 14px;
    }

    .actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: flex-end;
      justify-content: center;
    }

    .iconbtn {
      width: 40px;
      height: 40px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, .10);
      background: rgba(255, 255, 255, .05);
      color: rgba(255, 255, 255, .88);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .iconbtn:hover {
      border-color: rgba(255, 77, 77, .35);
      background: rgba(255, 77, 77, .12);
      color: var(--danger);
    }

    .btn {
      border: none;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 950;
      cursor: pointer;
      text-decoration: none;
      text-align: center;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      user-select: none;
    }

    .btn:disabled {
      opacity: .55;
      cursor: not-allowed;
      filter: grayscale(.2);
    }

    .btn-primary {
      background: linear-gradient(90deg, rgba(184, 107, 255, 1), rgba(99, 214, 255, 1));
      color: #071022;
      box-shadow: 0 12px 26px rgba(184, 107, 255, .16);
    }

    .btn-primary:hover {
      filter: brightness(.98);
    }

    .btn-ghost {
      background: rgba(255, 255, 255, .05);
      color: var(--ink);
      border: 1px solid rgba(255, 255, 255, .10);
    }

    .btn-ghost:hover {
      background: rgba(255, 255, 255, .08);
    }

    .summary {
      padding: 16px;
      position: sticky;
      top: 76px;
    }

    .sum-title {
      font-weight: 950;
      letter-spacing: .2px;
      margin-bottom: 10px;
    }

    .sumline {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 0;
      color: var(--muted);
      border-bottom: 1px solid rgba(255, 255, 255, .08);
      font-size: 14px;
    }

    .sumline strong {
      color: rgba(255, 255, 255, .92);
    }

    .total {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 0 6px;
      font-size: 16px;
      font-weight: 950;
    }

    .cta {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .helper {
      margin-top: 10px;
      color: rgba(255, 255, 255, .62);
      font-size: 12px;
      line-height: 1.35;
    }

    .foot {
      margin-top: 20px;
      text-align: center;
      color: rgba(255, 255, 255, .6);
      font-size: 13px;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }

      .summary {
        position: static;
      }

      .item {
        grid-template-columns: 74px 1fr;
        grid-template-rows: auto auto;
        align-items: start;
      }

      .actions {
        grid-column: 1 / -1;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }
    }
  </style>
</head>

<body>
  <site-loader text="Loading..."></site-loader>
  <site-navbar cart-href="/cart" signin-href="https://unlim8ted.com/sign-in"
    profile-href="https://unlim8ted.com/profile"></site-navbar>

  <div class="wrap">
    <div class="topbar">
      <div>
        <h1 id="pageTitle">Your Cart</h1>
        <p id="pageSub" class="sub">Everything in one list. Adjust quantities, then checkout.</p>
      </div>
    </div>

    <div id="notice" class="notice" style="display:none;"></div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card list">
        <div id="cartList"></div>
        <div id="cartEmpty" class="empty" style="display:none;">Your cart is empty.</div>
      </div>

      <!-- RIGHT -->
      <div class="card summary">
        <div class="sum-title">Order summary</div>

        <div class="sumline">
          <span>Items</span>
          <strong><span id="itemsCount">0</span></strong>
        </div>

        <div class="sumline">
          <span>Subtotal</span>
          <strong>$<span id="subtotal">0.00</span></strong>
        </div>

        <div class="total">
          <span>Total</span>
          <span>$<span id="total">0.00</span></span>
        </div>

        <div class="helper">Taxes and shipping (if any) are calculated in Square checkout.</div>

        <div class="cta">
          <button id="checkoutBtn" class="btn btn-primary" type="button">Checkout</button>
          <button id="clearBtn" class="btn btn-ghost" type="button">Clear cart</button>
          <a id="continueBtn" class="btn btn-ghost" href="/products">Continue shopping</a>
        </div>

        <div class="helper" style="margin-top:12px;">
          Free items show as <strong>FREE</strong>. If Square requires a paid checkout, only paid items will be charged.
        </div>
      </div>
    </div>

    <div class="foot">
      <span id="footer-text"></span>
    </div>
  </div>

  <script type="module">
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import {
      collection, onSnapshot, doc, deleteDoc, updateDoc, serverTimestamp, getDocs
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    import { getFirebase } from "/components/firebase-init.js";
    const { auth, db } = getFirebase();

    /* =============================
       URL mode: single-item checkout
       /cart?source=buy&product=theglitch
    ============================= */
    const QS = new URLSearchParams(location.search);
    const BUY_MODE = (QS.get("source") || "").toLowerCase() === "buy";
    const BUY_PRODUCT = String(QS.get("product") || "").trim();

    /* =============================
       products.json cache/index
    ============================= */
    let _productsLoaded = false;
    let _productsLoading = null;
    let _productById = new Map();
    let _variantByKey = new Map(); // `${productId}::${variantId}` -> variant
    let _productsArray = [];

    function safeUrl(u) {
      const s = String(u || "").trim();
      if (!s) return "";
      if (s.startsWith("https://") || s.startsWith("http://") || s.startsWith("/")) return s;
      return "";
    }

    async function loadProducts() {
      if (_productsLoaded) return;
      if (_productsLoading) return _productsLoading;

      _productsLoading = (async () => {
        try {
          const r = await fetch("https://unlim8ted.com/tools/data/products.json", { cache: "no-store" });
          if (!r.ok) throw new Error("Failed to load products.json");
          const data = await r.json();
          const products = Array.isArray(data) ? data : (data?.products || []);
          _productsArray = Array.isArray(products) ? products : [];
          indexProducts(_productsArray);
          _productsLoaded = true;
        } catch (e) {
          console.warn("products.json load failed:", e);
        } finally {
          _productsLoading = null;
        }
      })();

      return _productsLoading;
    }

    function indexProducts(products) {
      _productById = new Map();
      _variantByKey = new Map();

      for (const p of (products || [])) {
        const pid = String(p.id ?? p.productId ?? "").trim();
        if (!pid) continue;
        _productById.set(pid, p);

        const vars = Array.isArray(p.varients) ? p.varients : (Array.isArray(p.variants) ? p.variants : []);
        for (const v of vars) {
          const vid = String(v.id ?? v.variantId ?? "").trim();
          if (!vid) continue;
          _variantByKey.set(`${pid}::${vid}`, v);
        }
      }
    }

    function parsePrice(val) {
      if (val == null) return null;
      if (typeof val === "number") return Number.isFinite(val) ? val : null;
      const s = String(val).trim();
      if (!s) return null;
      const cleaned = s.replace(/[^0-9.\-]/g, "");
      if (!cleaned) return null;
      const n = Number(cleaned);
      return Number.isFinite(n) ? n : null;
    }

    function normalizePriceNumber(n) {
      if (!Number.isFinite(n)) return null;
      if (n >= 1000 && Math.abs(n - Math.round(n)) < 1e-9) return n / 100;
      return n;
    }

    const money = (n) => (normalizePriceNumber(Number(n)) ?? 0).toFixed(2);

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, (c) => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
      }[c]));
    }

    function setNotice(kind, msgHtml) {
      const el = document.getElementById("notice");
      el.style.display = "block";
      el.className = "notice " + (kind || "");
      el.innerHTML = msgHtml;
    }

    function clearNotice() {
      const el = document.getElementById("notice");
      el.style.display = "none";
      el.className = "notice";
      el.innerHTML = "";
    }

    function resolveProductImage(productId, variantId) {
      const pid = String(productId || "").trim();
      if (!pid) return "";
      const p = _productById.get(pid) || null;
      if (!p) return "";

      const vid = String(variantId || "").trim();
      if (vid) {
        const v = _variantByKey.get(`${pid}::${vid}`) || null;
        const vImg =
          (v && Array.isArray(v.images) && v.images.length && safeUrl(v.images[0])) ||
          safeUrl(v?.image) ||
          safeUrl(v?.imageUrl) ||
          safeUrl(v?.thumbnail) ||
          "";
        if (vImg) return vImg;
      }

      const pImg =
        safeUrl(p.image) ||
        safeUrl(p.imageUrl) ||
        safeUrl(p.thumbnail) ||
        safeUrl(p.thumb) ||
        "";
      if (pImg) return pImg;

      if (Array.isArray(p.images) && p.images.length) {
        const first = p.images[0];
        if (typeof first === "string") return safeUrl(first);
        if (first && typeof first === "object") return safeUrl(first.url || first.src || first.imageUrl || first.image);
      }
      return "";
    }

    function resolveFromCatalog(item) {
      const it = { ...(item || {}) };
      const productId = String(it.productId || "").trim();
      const variantId = String(it.variantId || "").trim();

      const p = productId ? (_productById.get(productId) || null) : null;
      const v = (productId && variantId) ? (_variantByKey.get(`${productId}::${variantId}`) || null) : null;

      if (!String(it.title || it.name || "").trim()) {
        it.title = String(p?.name || p?.title || productId || it.id || "Item").trim();
      }

      if (!String(it.variantLabel || "").trim()) {
        it.variantLabel = String(v?.name || "").trim();
      }

      const hasPrice =
        it.price !== null &&
        it.price !== undefined &&
        Number.isFinite(Number(it.price));

      if (!hasPrice) {
        const catalogPrice =
          (v && Number.isFinite(Number(v.price)) ? Number(v.price) : null) ??
          (p && Number.isFinite(Number(p.price)) ? Number(p.price) : null) ??
          null;
        if (catalogPrice !== null) it.price = catalogPrice;
      }

      const hasImage = !!safeUrl(it.image || it.imageUrl || "");
      if (!hasImage) {
        const img = resolveProductImage(productId, variantId);
        if (img) it.image = img;
      }

      return it;
    }

    function getProductByQueryKey(keyRaw) {
      const key = String(keyRaw || "").trim().toLowerCase();
      if (!key) return null;

      // Try exact id match first
      for (const [pid, p] of _productById.entries()) {
        if (String(pid).toLowerCase() === key) return p;
      }

      // Try common fields
      for (const p of (_productsArray || [])) {
        const candidates = [
          p.id, p.productId, p.slug, p.handle, p.key, p.shortId,
          p?.meta?.slug, p?.meta?.handle
        ].filter(Boolean).map(x => String(x).trim().toLowerCase());
        if (candidates.includes(key)) return p;
      }

      // Try loose "contains"
      for (const p of (_productsArray || [])) {
        const name = String(p.name || p.title || "").trim().toLowerCase();
        if (name && name.replace(/\s+/g, "") === key.replace(/\s+/g, "")) return p;
      }

      return null;
    }

    function pickDefaultVariant(product) {
      const vars = Array.isArray(product?.varients) ? product.varients : (Array.isArray(product?.variants) ? product.variants : []);
      if (!vars.length) return null;
      // Prefer first that has an id
      for (const v of vars) {
        const vid = String(v?.id ?? v?.variantId ?? "").trim();
        if (vid) return v;
      }
      return vars[0] || null;
    }

    /* =============================
       Local cart helpers (signed-out)
    ============================= */
    function getLocalCart() {
      try {
        const raw = localStorage.getItem("unlim8ted-cart");
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch { return []; }
    }

    function setLocalCart(items) {
      try {
        localStorage.setItem("unlim8ted-cart", JSON.stringify(items || []));
        window.dispatchEvent(new CustomEvent("cart-changed"));
      } catch { }
    }

    /* =============================
       Cart state + listeners
    ============================= */
    let currentUser = null;
    let cartItems = [];
    let unsubCart = null;

    async function emitCart(items) {
      await loadProducts();
      cartItems = (items || []).map(x => resolveFromCatalog(x));
      renderCart();
    }

    // Only attach once (your previous version attached inside onAuthStateChanged)
    window.addEventListener("cart-changed", () => {
      if (BUY_MODE) return;
      if (!currentUser) emitCart(getLocalCart());
    });

    function startCartData() {
      onAuthStateChanged(auth, (user) => {
        currentUser = user || null;

        if (unsubCart) { unsubCart(); unsubCart = null; }

        if (BUY_MODE) return; // buy-mode ignores Firestore/local cart

        if (!user) {
          emitCart(getLocalCart());
          return;
        }

        const cartRef = collection(db, "users", user.uid, "cartItems");
        unsubCart = onSnapshot(cartRef, (snap) => {
          const raw = [];
          snap.forEach(d => {
            const data = d.data() || {};
            raw.push({
              id: d.id,
              productId: data.productId ?? null,
              variantId: data.variantId ?? null,
              variantLabel: data.variantLabel ?? "",
              title: data.title || data.name || data.productName || "",
              price: (data.price ?? data.priceNum ?? null),
              qty: Number.isFinite(data.qty) ? Number(data.qty) : 1,
              image: data.image ?? data.imageUrl ?? null,
              accessUrl: data.accessUrl ?? data.downloadUrl ?? data.url ?? data.link ?? null,
            });
          });
          emitCart(raw);
        });
      });
    }

    /* =============================
       Cart mutations
    ============================= */
    async function setQty(id, qty) {
      qty = Math.max(1, qty | 0);
      if (BUY_MODE) {
        // Single-item buy mode: just update in-memory
        const idx = cartItems.findIndex(x => String(x.id) === String(id));
        if (idx >= 0) {
          cartItems[idx].qty = qty;
          renderCart();
        }
        return;
      }

      if (!currentUser?.uid) {
        const arr = getLocalCart();
        const idx = arr.findIndex(x => String(x.id) === String(id));
        if (idx >= 0) {
          arr[idx].qty = qty;
          setLocalCart(arr);
        }
        return;
      }

      await updateDoc(doc(db, "users", currentUser.uid, "cartItems", id), {
        qty,
        updatedAt: serverTimestamp(),
      });
    }

    async function removeItem(id) {
      if (BUY_MODE) {
        cartItems = cartItems.filter(x => String(x.id) !== String(id));
        renderCart();
        return;
      }

      if (!currentUser?.uid) {
        setLocalCart(getLocalCart().filter(x => String(x.id) !== String(id)));
        return;
      }
      await deleteDoc(doc(db, "users", currentUser.uid, "cartItems", id));
    }

    async function clearCart() {
      if (BUY_MODE) {
        cartItems = [];
        renderCart();
        return;
      }

      if (!currentUser?.uid) {
        setLocalCart([]);
        return;
      }
      const snap = await getDocs(collection(db, "users", currentUser.uid, "cartItems"));
      await Promise.all(snap.docs.map(d => deleteDoc(d.ref)));
    }

    /* =============================
       Square checkout (popup)
    ============================= */
    const WORKER_BASE = "https://checkout.unlim8ted.workers.dev";
    const POPUP_FEATURES = "width=520,height=760,noopener,noreferrer";

    function waitForPopupClose(popup) {
      return new Promise(resolve => {
        const t = setInterval(() => {
          if (!popup || popup.closed) { clearInterval(t); resolve(); }
        }, 400);
      });
    }

    function buildWorkerItemsFromCart(allItems) {
      // Only paid items with a Square variationId (variantId)
      return (allItems || [])
        .map(it => ({
          variationId: String(it.variantId || "").trim(),
          quantity: Math.max(1, Number(it.qty) || 1),
          price: normalizePriceNumber(parsePrice(it.price)) || 0
        }))
        .filter(x => x.variationId && (x.price > 0));
    }

    async function workerCreateCheckout(payload) {
      const res = await fetch(`${WORKER_BASE}/create-checkout`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const j = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(j?.error ? `${j.error}: ${JSON.stringify(j.details || j)}` : `HTTP ${res.status}`);
      if (!j.checkoutUrl) throw new Error("Worker did not return checkoutUrl");
      return j;
    }

    async function beginCheckout() {
      clearNotice();

      if (!cartItems.length) {
        setNotice("warn", `<strong>Your cart is empty.</strong> Add something first.`);
        return;
      }

      const items = buildWorkerItemsFromCart(cartItems);

      if (!items.length) {
        setNotice("ok", `<strong>No paid items.</strong> Nothing to pay for. Your free items are ready.`);
        return;
      }

      const checkoutBtn = document.getElementById("checkoutBtn");
      checkoutBtn.disabled = true;
      setNotice("warn", `<strong>Opening checkout…</strong> Complete payment in the popup.`);

      try {
        const payload = {
          cartId: (BUY_MODE && BUY_PRODUCT)
            ? `buy-${BUY_PRODUCT}-${Date.now()}-${Math.random().toString(16).slice(2)}`
            : `cart-${Date.now()}-${Math.random().toString(16).slice(2)}`,
          currency: "USD",
          items: items.map(x => ({ variationId: x.variationId, quantity: x.quantity })),
          context: {
            uid: currentUser?.uid || null,
            mode: BUY_MODE ? "buy" : "cart",
            product: BUY_MODE ? BUY_PRODUCT : null
          }
        };

        const { checkoutUrl } = await workerCreateCheckout(payload);

        const popup = window.open(checkoutUrl, "squareCheckout", POPUP_FEATURES);
        if (!popup) {
          setNotice("warn", `<strong>Popup blocked.</strong> Allow popups and try again.`);
          checkoutBtn.disabled = false;
          return;
        }

        await waitForPopupClose(popup);

        setNotice("ok",
          `<div style="display:flex;gap:10px;align-items:flex-start">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" style="width:18px;height:18px;margin-top:2px;">
              <path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <div><strong>Checkout closed.</strong><br/>If payment completed, your order will be processed by Square.</div>
          </div>`
        );

      } catch (err) {
        console.error(err);
        setNotice("warn", `<strong>Checkout error:</strong> ${escapeHtml(err?.message || String(err))}`);
      } finally {
        document.getElementById("checkoutBtn").disabled = false;
      }
    }

    /* =============================
       Render
    ============================= */
    function itemHTML(it) {
      const qty = Math.max(1, Number(it.qty) || 1);
      const price = normalizePriceNumber(parsePrice(it.price)) || 0;

      const title = escapeHtml(it.title || it.name || "Item");
      const variantLabel = String(it.variantLabel || "").trim();
      const variantLine = variantLabel
        ? `<div class="mini">Variant: <strong>${escapeHtml(variantLabel)}</strong></div>`
        : ``;

      const imgUrl = safeUrl(it.image || it.imageUrl || "");
      const img = imgUrl ? `<img src="${escapeHtml(imgUrl)}" alt="">` : "No image";

      const priceHtml = price > 0
        ? `$${money(price)}`
        : `<span class="free">FREE</span>`;

      return `
        <div class="item">
          <div class="thumb">${img}</div>

          <div class="meta">
            <div class="title">${title}</div>
            ${variantLine}

            <div class="row2">
              <div class="price">${priceHtml}</div>

              <div class="qty" aria-label="Quantity">
                <button type="button" data-dec="${escapeHtml(it.id)}" aria-label="Decrease quantity">−</button>
                <input type="text" inputmode="numeric" value="${qty}" data-qty="${escapeHtml(it.id)}" aria-label="Quantity value">
                <button type="button" data-inc="${escapeHtml(it.id)}" aria-label="Increase quantity">+</button>
              </div>
            </div>

            ${
              safeUrl(it.accessUrl) && price <= 0
                ? `<div class="mini">Free access: <a href="${escapeHtml(it.accessUrl)}" target="_blank" rel="noopener" style="color:rgba(99,214,255,.95);text-decoration:none;font-weight:900;">Open link</a></div>`
                : ``
            }
          </div>

          <div class="actions">
            <button class="iconbtn" type="button" data-remove="${escapeHtml(it.id)}" title="Remove" aria-label="Remove">
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" style="width:18px;height:18px;">
                <path d="M4 7h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                <path d="M10 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                <path d="M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                <path d="M6 7l1 14h10l1-14" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                <path d="M9 7V4h6v3" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              </svg>
            </button>
          </div>
        </div>
      `;
    }

    function renderCart() {
      const list = document.getElementById("cartList");
      const empty = document.getElementById("cartEmpty");

      list.innerHTML = "";
      if (!cartItems.length) {
        empty.style.display = "block";
      } else {
        empty.style.display = "none";
        for (const it of cartItems) {
          const d = document.createElement("div");
          d.innerHTML = itemHTML(it);
          list.appendChild(d.firstElementChild);
        }
      }

      const itemsCount = cartItems.reduce((s, it) => s + (Number(it.qty) || 1), 0);
      const subtotal = cartItems.reduce((s, it) => {
        const price = normalizePriceNumber(parsePrice(it.price)) || 0;
        return s + price * (Number(it.qty) || 1);
      }, 0);

      document.getElementById("itemsCount").textContent = String(itemsCount);
      document.getElementById("subtotal").textContent = money(subtotal);
      document.getElementById("total").textContent = money(subtotal);

      document.getElementById("checkoutBtn").disabled = cartItems.length === 0;

      const clearBtn = document.getElementById("clearBtn");
      clearBtn.disabled = cartItems.length === 0 || BUY_MODE;
      clearBtn.style.display = BUY_MODE ? "none" : "inline-flex";
    }

    /* =============================
       UI events
    ============================= */
    document.addEventListener("click", async (e) => {
      const rm = e.target.closest("[data-remove]");
      if (rm) {
        const id = rm.getAttribute("data-remove");
        try { await removeItem(id); } catch (err) { console.error(err); }
        return;
      }

      const inc = e.target.closest("[data-inc]");
      if (inc) {
        const id = inc.getAttribute("data-inc");
        const input = document.querySelector(`[data-qty="${CSS.escape(id)}"]`);
        const current = Math.max(1, parseInt(input?.value || "1", 10) || 1);
        input.value = String(current + 1);
        try { await setQty(id, current + 1); } catch (err) { console.error(err); }
        return;
      }

      const dec = e.target.closest("[data-dec]");
      if (dec) {
        const id = dec.getAttribute("data-dec");
        const input = document.querySelector(`[data-qty="${CSS.escape(id)}"]`);
        const current = Math.max(1, parseInt(input?.value || "1", 10) || 1);
        const next = Math.max(1, current - 1);
        input.value = String(next);
        try { await setQty(id, next); } catch (err) { console.error(err); }
        return;
      }

      if (e.target.closest("#checkoutBtn")) {
        beginCheckout();
        return;
      }

      if (e.target.closest("#clearBtn")) {
        if (BUY_MODE) return;
        clearNotice();
        if (!cartItems.length) return;
        if (!confirm("Clear your cart?")) return;
        try { await clearCart(); } catch (err) { console.error(err); }
        return;
      }
    });

    let t = null;
    document.addEventListener("input", (e) => {
      const inp = e.target.closest("[data-qty]");
      if (!inp) return;

      const id = inp.getAttribute("data-qty");
      let qty = parseInt(inp.value, 10);
      if (!Number.isFinite(qty) || qty < 1) qty = 1;

      clearTimeout(t);
      t = setTimeout(async () => {
        try { await setQty(id, qty); } catch (err) { console.error(err); }
      }, 300);
    });

    /* =============================
       BUY MODE bootstrap
    ============================= */
    async function startBuyMode(productKey) {
      await loadProducts();

      const p = getProductByQueryKey(productKey);
      if (!p) {
        cartItems = [];
        renderCart();
        setNotice("warn",
          `<strong>Product not found:</strong> ${escapeHtml(productKey)}<br/>
           <a href="/products" style="color:rgba(99,214,255,.95);text-decoration:none;font-weight:900;">Go to products</a>`
        );
        return;
      }

      const pid = String(p.id ?? p.productId ?? "").trim();
      const v = pickDefaultVariant(p);
      const vid = String(v?.id ?? v?.variantId ?? "").trim();

      // IMPORTANT: paid checkout requires a Square variation id
      if (!vid) {
        cartItems = [];
        renderCart();
        setNotice("warn",
          `<strong>This product can't be purchased yet.</strong><br/>
           Missing Square variant (variationId) in products.json for <strong>${escapeHtml(pid || productKey)}</strong>.`
        );
        return;
      }

      const price = normalizePriceNumber(parsePrice(v?.price ?? p?.price)) || 0;
      const image = resolveProductImage(pid, vid) || safeUrl(p.image || p.imageUrl || "");
      const title = String(p.name || p.title || pid || productKey || "Item").trim();
      const variantLabel = String(v?.name || "").trim();

      cartItems = [
        resolveFromCatalog({
          id: `buy-${pid}-${vid}`,
          productId: pid,
          variantId: vid,
          title,
          variantLabel,
          price,
          qty: 1,
          image: image || null,
          accessUrl: p.accessUrl ?? p.downloadUrl ?? p.url ?? p.link ?? null,
        })
      ];

      renderCart();
      clearNotice();
    }

    /* =============================
       Start
    ============================= */
    // Footer year
    const y = new Date().getFullYear();
    document.getElementById("footer-text").innerHTML =
      `&copy; 2019-${y} Unlim8ted Studio Productions. All rights reserved.`;

    // Buy mode UI tweaks
    if (BUY_MODE) {
      document.getElementById("pageTitle").textContent = "Checkout";
      document.getElementById("pageSub").textContent = "One item. Adjust quantity, then checkout.";
      document.getElementById("continueBtn").textContent = "Back to products";
      document.getElementById("continueBtn").setAttribute("href", "/products");
      document.title = "Unlim8ted - Checkout";
    }

    // Load products early
    loadProducts().catch(() => { });

    // Always watch auth (needed for context.uid) but cart listeners are disabled in BUY_MODE
    startCartData();

    // Init data
    if (BUY_MODE) {
      if (!BUY_PRODUCT) {
        setNotice("warn",
          `<strong>Missing product.</strong> Use <code>?source=buy&amp;product=theglitch</code><br/>
           <a href="/products" style="color:rgba(99,214,255,.95);text-decoration:none;font-weight:900;">Go to products</a>`
        );
      } else {
        startBuyMode(BUY_PRODUCT).catch(err => {
          console.error(err);
          setNotice("warn", `<strong>Error:</strong> ${escapeHtml(err?.message || String(err))}`);
        });
      }
    } else {
      // regular cart will be rendered via snapshot/local emit
      renderCart();
    }
  </script>
</body>

</html>
