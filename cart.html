<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Unlim8ted - Cart</title>
  <meta name="description" content="View your Unlim8ted cart, powered by Unlim8ted Studio Productions" />
  <link rel="icon" href="https://unlim8ted.com/favicon.ico" type="image/x-icon">

  <!-- Components -->
  <script type="module" src="/components/site-navbar.js"></script>
  <script type="module" src="/components/site-loader.js"></script>

  <style>
    :root {
      --bg: #0e0b16;
      --panel: rgba(20, 18, 30, .88);
      --panel2: rgba(28, 26, 42, .92);
      --text: rgba(255, 255, 255, .92);
      --muted: rgba(255, 255, 255, .65);
      --stroke: rgba(255, 255, 255, .10);
      --accent: #00ff99;
      --danger: #ff4d4d;
      --warn: #ffd166;
      --shadow: 0 12px 30px rgba(0, 0, 0, .35);
      --r: 18px;
    }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(circle at 20% 20%, rgba(0, 255, 153, .12), transparent 40%),
        radial-gradient(circle at 80% 30%, rgba(255, 0, 119, .10), transparent 45%),
        radial-gradient(circle at 50% 90%, rgba(52, 152, 219, .10), transparent 45%),
        #07060b;
      padding-top: 56px;
      min-height: 100vh;
    }

    .wrap {
      max-width: 1080px;
      margin: 0 auto;
      padding: 28px 16px 70px;
    }

    .topbar {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 14px;
    }

    h1 {
      margin: 0;
      font-size: 28px;
      letter-spacing: .2px;
    }

    .sub {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 14px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1.6fr .9fr;
      gap: 16px;
      align-items: start;
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .list {
      padding: 14px;
    }

    .empty {
      padding: 18px;
      color: var(--muted);
    }

    .signedout {
      padding: 14px 16px;
      margin-bottom: 12px;
      background: rgba(255, 255, 255, .06);
      border: 1px solid var(--stroke);
      border-radius: 14px;
      color: var(--muted);
    }

    .signedout a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 700;
    }

    .notice {
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, .10);
      background: rgba(255, 255, 255, .06);
      color: var(--muted);
      margin-bottom: 12px;
      font-size: 13px;
      line-height: 1.35;
    }

    .notice strong {
      color: rgba(255, 255, 255, .92);
    }

    .notice.ok {
      border-color: rgba(0, 255, 153, .28);
      background: rgba(0, 255, 153, .08);
      color: rgba(255, 255, 255, .80);
    }

    .notice.warn {
      border-color: rgba(255, 209, 102, .22);
      background: rgba(255, 209, 102, .08);
      color: rgba(255, 255, 255, .78);
    }

    /* Dark selects */
    select {
      background: rgba(10, 10, 16, .92) !important;
      color: rgba(255, 255, 255, .92) !important;
      border: 1px solid rgba(255, 255, 255, .14);
    }

    select option {
      background: #0b0a12 !important;
      color: rgba(255, 255, 255, .92) !important;
    }

    select:focus {
      outline: none;
      border-color: rgba(0, 255, 153, .45);
      box-shadow: 0 0 0 3px rgba(0, 255, 153, .12);
    }

    .section {
      margin-bottom: 14px;
    }

    .sectionhead {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin: 6px 2px 10px;
    }

    .sectiontitle {
      font-weight: 900;
      letter-spacing: .2px;
      font-size: 14px;
      color: rgba(255, 255, 255, .92);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .icon {
      width: 18px;
      height: 18px;
      display: inline-block;
      color: rgba(255, 255, 255, .88);
    }

    .icon-2x {
      width: 40px;
      height: 40px;
      display: inline-block;
      color: rgba(211, 27, 27, 0.88);
    }

    .pill {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, .10);
      background: rgba(255, 255, 255, .06);
      color: rgba(255, 255, 255, .75);
      font-weight: 800;
    }

    /* Progress / stepper */
    .stepper {
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, .10);
      background: rgba(255, 255, 255, .05);
      margin-bottom: 12px;
    }

    .step {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
      min-width: 0;
      opacity: .72;
    }

    .step.active {
      opacity: 1;
    }

    .dot {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 12px;
      border: 1px solid rgba(255, 255, 255, .14);
      background: rgba(255, 255, 255, .06);
      color: rgba(255, 255, 255, .85);
      flex: 0 0 auto;
    }

    .step.active .dot {
      border-color: rgba(0, 255, 153, .32);
      background: rgba(0, 255, 153, .10);
      color: rgba(255, 255, 255, .92);
    }

    .stepname {
      font-size: 13px;
      font-weight: 900;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .stepdesc {
      font-size: 12px;
      color: rgba(255, 255, 255, .65);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .steptext {
      min-width: 0;
    }

    .divider {
      height: 1px;
      background: rgba(255, 255, 255, .10);
      flex: 0 0 18px;
      opacity: .4;
    }

    /* Item row */
    .item {
      display: flex;
      gap: 14px;
      padding: 12px;
      border-radius: 16px;
      background: rgba(255, 255, 255, .04);
      border: 1px solid rgba(255, 255, 255, .06);
      margin-bottom: 10px;
    }

    .thumb {
      width: 90px;
      height: 90px;
      border-radius: 16px;
      overflow: hidden;
      flex: 0 0 auto;
      background: rgba(255, 255, 255, .07);
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255, 255, 255, .55);
      font-size: 12px;
      border: 1px solid rgba(255, 255, 255, .08);
    }

    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .meta {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .title {
      font-size: 15px;
      font-weight: 800;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      letter-spacing: .2px;
    }

    .row2 {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      color: var(--muted);
      font-size: 13px;
    }

    .price {
      color: rgba(255, 255, 255, .85);
      font-weight: 700;
    }

    .mini {
      font-size: 12px;
      color: rgba(255, 255, 255, .62);
    }

    /* Qty stepper */
    .qty {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, .06);
      border: 1px solid rgba(255, 255, 255, .10);
      border-radius: 999px;
      padding: 6px 10px;
    }

    .qty button {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: rgba(255, 255, 255, .08);
      color: var(--text);
      font-size: 18px;
      line-height: 0;
    }

    .qty button:hover {
      background: rgba(0, 255, 153, .16);
      color: var(--accent);
    }

    .qty input {
      width: 42px;
      border: none;
      background: transparent;
      color: var(--text);
      text-align: center;
      outline: none;
      font-weight: 800;
      font-size: 14px;
    }

    .actions {
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .iconbtn {
      width: 40px;
      height: 40px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, .10);
      background: rgba(255, 255, 255, .05);
      color: rgba(255, 255, 255, .85);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .iconbtn:hover {
      border-color: rgba(255, 77, 77, .35);
      background: rgba(255, 77, 77, .12);
      color: var(--danger);
    }

    .btn {
      border: none;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 900;
      cursor: pointer;
      text-decoration: none;
      text-align: center;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      user-select: none;
    }

    .btn:disabled {
      opacity: .55;
      cursor: not-allowed;
      filter: grayscale(.2);
    }

    .btn-primary {
      background: var(--accent);
      color: #0b1020;
      box-shadow: 0 10px 22px rgba(0, 255, 153, .18);
    }

    .btn-primary:hover {
      filter: brightness(.95);
    }

    .btn-ghost {
      background: rgba(255, 255, 255, .05);
      color: var(--text);
      border: 1px solid rgba(255, 255, 255, .10);
    }

    .btn-ghost:hover {
      background: rgba(255, 255, 255, .08);
    }

    .btn-small {
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
    }

    /* Summary */
    .summary {
      padding: 16px;
      position: sticky;
      top: 76px;
    }

    .sum-title {
      font-weight: 900;
      letter-spacing: .2px;
      margin-bottom: 10px;
    }

    .sumline {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 0;
      color: var(--muted);
      border-bottom: 1px solid rgba(255, 255, 255, .08);
      font-size: 14px;
    }

    .sumline strong {
      color: rgba(255, 255, 255, .92);
    }

    .total {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 0 6px;
      font-size: 16px;
      font-weight: 900;
    }

    .cta {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .donationBox {
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid rgba(255, 255, 255, .08);
    }

    .formrow {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    select,
    input[type="text"] {
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(255, 255, 255, .06);
      color: rgba(255, 255, 255, .92);
      padding: 10px 12px;
      outline: none;
      font-weight: 800;
    }

    select {
      cursor: pointer;
    }

    input::placeholder {
      color: rgba(255, 255, 255, .45);
    }

    .helper {
      margin-top: 10px;
      color: rgba(255, 255, 255, .62);
      font-size: 12px;
      line-height: 1.35;
    }

    .foot {
      margin-top: 20px;
      text-align: center;
      color: rgba(255, 255, 255, .6);
      font-size: 13px;
    }

    /* “Checkout sections” */
    .checkoutPane {
      display: none;
      animation: fadeIn .18s ease-out;
    }

    .checkoutPane.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(6px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .successCard {
      padding: 14px;
    }

    .successGrid {
      display: grid;
      gap: 10px;
    }

    .successRow {
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, .10);
      background: rgba(255, 255, 255, .05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .tag {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0, 255, 153, .28);
      background: rgba(0, 255, 153, .10);
      color: rgba(255, 255, 255, .85);
      font-weight: 900;
      white-space: nowrap;
    }

    .tag.dim {
      border-color: rgba(255, 255, 255, .12);
      background: rgba(255, 255, 255, .06);
      color: rgba(255, 255, 255, .72);
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }

      .summary {
        position: static;
      }

      .stepdesc {
        display: none;
      }
    }
  </style>
</head>

<body>
  <site-loader text="Loading..."></site-loader>
  <site-navbar cart-href="/cart" signin-href="https://unlim8ted.com/sign-in"
    profile-href="https://unlim8ted.com/profile"></site-navbar>

  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>Checkout</h1>
        <p class="sub">
          Paid items (digital or physical) are purchased individually via Square. Free digital items can include access links.
        </p>
      </div>
    </div>

    <div id="flowNotice" class="notice" style="display:none;"></div>

    <div id="signedOut" class="signedout" style="display:none;">
      You’re not signed in. <a href="https://unlim8ted.com/sign-in">Sign in</a> to sync your cart and purchase history
      across devices.
    </div>

    <!-- Stepper -->
    <div class="stepper" role="navigation" aria-label="Checkout steps">
      <div class="step" id="step-1">
        <div class="dot">1</div>
        <div class="steptext">
          <div class="stepname">Review</div>
          <div class="stepdesc">Check items & variants</div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="step" id="step-2">
        <div class="dot">2</div>
        <div class="steptext">
          <div class="stepname">Support</div>
          <div class="stepdesc">Optional donation</div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="step" id="step-3">
        <div class="dot">3</div>
        <div class="steptext">
          <div class="stepname">Pay</div>
          <div class="stepdesc">Square per item</div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="step" id="step-4">
        <div class="dot">4</div>
        <div class="steptext">
          <div class="stepname">Success</div>
          <div class="stepdesc">Open links / history</div>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: panes -->
      <div class="card list">
        <!-- PANE 1: REVIEW -->
        <div class="checkoutPane active" id="pane-review">

          <div class="section">
            <div class="sectionhead">
              <div class="sectiontitle">
                <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path
                    d="M7 21h10a2 2 0 0 0 2-2V7.5a2 2 0 0 0-.59-1.41l-3.5-3.5A2 2 0 0 0 13.5 2H7a2 2 0 0 0-2 2v15a2 2 0 0 0 2 2Z"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  <path d="M14 2v5a2 2 0 0 0 2 2h5" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                </svg>
                Free Digital <span class="pill" id="freeCountPill">0</span>
              </div>
            </div>
            <div id="freeList"></div>
            <div id="freeEmpty" class="empty" style="display:none;">No free items in your cart.</div>
          </div>

          <div class="section">
            <div class="sectionhead">
              <div class="sectiontitle">
                <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M3 7h18v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7Z" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" />
                  <path d="M3 10h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  <path d="M7 15h4" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                </svg>
                Paid Items <span class="pill" id="paidCountPill">0</span>
              </div>
            </div>
            <div id="paidList"></div>
            <div id="paidEmpty" class="empty" style="display:none;">No paid items in your cart.</div>
          </div>

          <div id="allEmpty" class="empty" style="display:none;">Your cart is empty.</div>
        </div>

        <!-- PANE 2: SUPPORT -->
        <div class="checkoutPane" id="pane-support">
          <div class="section">
            <div class="sectionhead">
              <div class="sectiontitle">
                <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M12 21s-7-4.35-9.33-9A5.5 5.5 0 0 1 12 6a5.5 5.5 0 0 1 9.33 6c-2.33 4.65-9.33 9-9.33 9Z"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                Support Unlim8ted <span class="pill">Optional</span>
              </div>
              <div class="mini">Donations use Square Payment Links.</div>
            </div>

            <div class="notice" style="margin-bottom:10px;">
              After donating, you’ll return to this page automatically so you can continue checkout.
            </div>

            <div class="formrow">
              <label class="mini" style="min-width:78px;">Frequency</label>
              <select id="donationFreq" aria-label="Donation frequency">
                <option value="one_time" selected>One-time</option>
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
                <option value="annual">Annual</option>
              </select>
            </div>

            <div class="formrow">
              <label class="mini" style="min-width:78px;">Amount</label>
              <select id="donationAmountPreset" aria-label="Donation amount">
                <option value="1" data-one-time="1">$1</option>
                <option value="5" data-one-time="1">$5</option>
                <option value="10" data-one-time="1">$10</option>
                <option value="custom" selected>Custom</option>
              </select>
            </div>

            <div class="formrow" style="margin-top:12px;">
              <button id="donateBtn" class="btn btn-primary btn-small" type="button">Donate via Square</button>
              <button id="clearDonationBtn" class="btn btn-ghost btn-small" type="button">Reset</button>
            </div>

            <div id="donationHint" class="helper" style="margin-top:10px;"></div>
            <div class="helper">
              You can skip this step at any time. Donation is never required.
            </div>
          </div>
        </div>

        <!-- PANE 3: PAY -->
        <div class="checkoutPane" id="pane-pay">
          <div class="section">
            <div class="sectionhead">
              <div class="sectiontitle">
                <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M3 7h18v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7Z" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" />
                  <path d="M3 10h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  <path d="M7 15h4" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                </svg>
                Purchase Paid Items <span class="pill">Square</span>
              </div>
              <div class="mini">You’ll return here after each purchase and we’ll clear that item from your cart.</div>
            </div>

            <div class="notice warn" style="margin-bottom:10px;">
              Make sure each Square Payment Link is configured to redirect back to the cart page after payment.
            </div>

            <div id="paidListPay"></div>
            <div id="paidEmptyPay" class="empty" style="display:none;">No paid items to purchase.</div>

            <div class="helper" style="margin-top:12px;">
              When you’re done purchasing, continue to Success to open available links and view your purchase history.
            </div>
          </div>
        </div>

        <!-- PANE 4: SUCCESS -->
        <div class="checkoutPane" id="pane-success">
          <div class="successCard">
            <div class="sectionhead">
              <div class="sectiontitle">
                <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round" />
                </svg>
                Success
              </div>
              <div class="mini">Your links appear here (and in your account if signed in).</div>
            </div>

            <div class="notice ok" style="margin-bottom:10px;">
              Purchased items (and any free items with access links) are listed below.
            </div>

            <div class="successGrid" id="successGrid"></div>
            <div id="successEmpty" class="empty" style="display:none;">
              Nothing to show yet. Complete a purchase return or keep shopping.
            </div>

            <div class="helper" style="margin-top:12px;">
              If you’re signed out, purchase history is stored locally in this browser. Sign in to sync it to your
              account.
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT: summary + nav -->
      <div class="card summary">
        <div class="sum-title">Summary</div>

        <div class="sumline">
          <span>Free digital (qty)</span>
          <strong><span id="freeQty">0</span></strong>
        </div>

        <div class="sumline">
          <span>Paid items (qty)</span>
          <strong><span id="paidQty">0</span></strong>
        </div>

        <div class="sumline">
          <span>Paid subtotal</span>
          <strong>$<span id="paidSubtotal">0.00</span></strong>
        </div>

        <div class="total">
          <span>Due now</span>
          <span>$<span id="dueNow">0.00</span></span>
        </div>
          <div class="mini">Estimate--Taxes and shipping fees not included.</div>

        <div class="cta">
          <button id="backBtn" class="btn btn-ghost" type="button" disabled>Back</button>
          <button id="nextBtn" class="btn btn-primary" type="button">Continue</button>
          <a class="btn btn-ghost" href="/products">Continue shopping</a>
        </div>

        <div class="donationBox">
          <div class="sum-title" style="margin:0;">How checkout works</div>
          <div class="helper" style="margin-top:10px;">
            <strong>1)</strong> Review items + variants.<br />
            <strong>2)</strong> Optional donation (Square).<br />
            <strong>3)</strong> Buy paid items one by one (Square).<br />
            <strong>4)</strong> Success: view purchase history and open links.
          </div>
        </div>
      </div>
    </div>

    <div class="foot">
      <span id="footer-text"></span>
    </div>
  </div>


<script type="module">
  // /js/cart-data.js
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import {
    collection, onSnapshot, doc, deleteDoc, updateDoc, serverTimestamp,
    addDoc, query, orderBy, getDocs
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  import { getFirebase } from "/components/firebase-init.js";
  const { auth, db } = getFirebase();

  /**
   * Tiny event bus so UI can subscribe without tight coupling.
   * Events:
   * - "auth": { user }
   * - "cart": { user, items }   // items include resolved price/title/variant/image when possible
   * - "purchases": { user, rows }
   */
  const listeners = new Map(); // event -> Set(fn)
  function emit(event, payload) {
    const set = listeners.get(event);
    if (!set) return;
    for (const fn of set) {
      try { fn(payload); } catch (e) { console.error(e); }
    }
  }
  export function on(event, fn) {
    if (!listeners.has(event)) listeners.set(event, new Set());
    listeners.get(event).add(fn);
    return () => listeners.get(event)?.delete(fn);
  }

  // ---------- Local storage helpers (signed-out cart + purchases) ----------
  export function getLocalCart() {
    try {
      const raw = localStorage.getItem("unlim8ted-cart");
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    } catch { return []; }
  }

  export function setLocalCart(items) {
    try {
      localStorage.setItem("unlim8ted-cart", JSON.stringify(items || []));
      window.dispatchEvent(new CustomEvent("cart-changed"));
    } catch { }
  }

  export function getLocalPurchases() {
    try {
      const raw = localStorage.getItem("unlim8ted-purchases");
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    } catch { return []; }
  }

  export function addLocalPurchase(row) {
    try {
      const arr = getLocalPurchases();
      arr.unshift(row);
      localStorage.setItem("unlim8ted-purchases", JSON.stringify(arr.slice(0, 200)));
    } catch { }
  }

  // ---------- products.json cache/index (matches navbar logic) ----------
  let _productsLoaded = false;
  let _productsLoading = null;
  let _productById = new Map();
  let _variantByKey = new Map(); // `${productId}::${variantId}` -> variant

  function safeUrl(u) {
    const s = String(u || "").trim();
    if (!s) return "";
    if (s.startsWith("https://") || s.startsWith("http://") || s.startsWith("/")) return s;
    return "";
  }

  async function loadProducts() {
    if (_productsLoaded) return;
    if (_productsLoading) return _productsLoading;

    _productsLoading = (async () => {
      try {
        const r = await fetch("https://unlim8ted.com/tools/data/products.json", { cache: "no-store" });
        if (!r.ok) throw new Error("Failed to load products.json");
        const data = await r.json();
        const products = Array.isArray(data) ? data : (data?.products || []);
        indexProducts(products);
        _productsLoaded = true;
      } catch (e) {
        console.warn("cart-data products.json load failed:", e);
      } finally {
        _productsLoading = null;
      }
    })();

    return _productsLoading;
  }

  function indexProducts(products) {
    _productById = new Map();
    _variantByKey = new Map();

    for (const p of (products || [])) {
      const pid = String(p.id ?? p.productId ?? "").trim();
      if (!pid) continue;

      _productById.set(pid, p);

      // your json uses "varients" (typo); support both
      const vars = Array.isArray(p.varients) ? p.varients : (Array.isArray(p.variants) ? p.variants : []);
      for (const v of vars) {
        const vid = String(v.id ?? v.variantId ?? "").trim();
        if (!vid) continue;
        _variantByKey.set(`${pid}::${vid}`, v);
      }
    }
  }

  function resolveFromCatalog(item) {
    const it = { ...(item || {}) };
    const productId = String(it.productId || "").trim();
    const variantId = String(it.variantId || "").trim();

    const p = productId ? (_productById.get(productId) || null) : null;
    const v = (productId && variantId) ? (_variantByKey.get(`${productId}::${variantId}`) || null) : null;

    // Title
    if (!String(it.title || it.name || "").trim()) {
      it.title = String(p?.name || p?.title || productId || it.id || "Item").trim();
    }

    // Variant label
    if (!String(it.variantLabel || "").trim()) {
      it.variantLabel = String(v?.name || "").trim();
    }

    // Price: IMPORTANT — only fill when missing/invalid, NOT when explicitly 0 (free items).
    const hasPrice =
      it.price !== null &&
      it.price !== undefined &&
      Number.isFinite(Number(it.price));

    if (!hasPrice) {
      const catalogPrice =
        (v && Number.isFinite(Number(v.price)) ? Number(v.price) : null) ??
        (p && Number.isFinite(Number(p.price)) ? Number(p.price) : null) ??
        null;

      if (catalogPrice !== null) it.price = catalogPrice;
    }

    // Image (optional but useful)
    const hasImage = !!safeUrl(it.image || it.imageUrl || "");
    if (!hasImage) {
      let img = "";
      if (Array.isArray(v?.images) && v.images.length) img = safeUrl(v.images[0]);
      if (!img) img = safeUrl(p?.image || "");
      if (img) it.image = img;
    }

    return it;
  }

  // ---------- Normalization (data-layer only; no DOM) ----------
  function normalizeCartItem(raw) {
    const it = { ...(raw || {}) };

    const pidRaw = String(it.productId ?? it.pid ?? it.product ?? "").trim();
    const vidRaw = String(it.variantId ?? it.vid ?? it.variant ?? "").trim();

    // If productId is like "pid__variant" and no variantId
    if (pidRaw.includes("__") && !vidRaw) {
      const [basePid, ...rest] = pidRaw.split("__");
      const base = String(basePid || "").trim();
      const v = rest.join("__").trim();
      if (base && v) {
        it.productId = base;
        it.variantId = v;
      }
    }

    // If missing productId but id is like "pid__variant"
    const idStr = String(it.id ?? "").trim();
    if ((!it.productId || !String(it.productId).trim()) && idStr.includes("__")) {
      const [basePid, ...rest] = idStr.split("__");
      const base = String(basePid || "").trim();
      const v = rest.join("__").trim();
      if (base) it.productId = base;
      if (v && !it.variantId) it.variantId = v;
    }

    if (it.productId != null) it.productId = String(it.productId).trim();
    if (it.variantId != null) it.variantId = String(it.variantId).trim();

    return it;
  }

  // ---------- Public API: cart mutations ----------
  export async function setQty(user, id, qty) {
    qty = Math.max(1, qty | 0);
    const uid = user?.uid || null;

    if (!uid) {
      const arr = getLocalCart();
      const idx = arr.findIndex(x => String(x.id) === String(id));
      if (idx >= 0) {
        arr[idx].qty = qty;
        setLocalCart(arr);
      }
      return;
    }

    await updateDoc(doc(db, "users", uid, "cartItems", id), {
      qty,
      updatedAt: serverTimestamp(),
    });
    window.dispatchEvent(new CustomEvent("cart-changed"));
  }

  export async function removeItem(user, id) {
    const uid = user?.uid || null;

    if (!uid) {
      const arr = getLocalCart().filter(x => String(x.id) !== String(id));
      setLocalCart(arr);
      return;
    }

    await deleteDoc(doc(db, "users", uid, "cartItems", id));
    window.dispatchEvent(new CustomEvent("cart-changed"));
  }

  export async function clearEntireCart(user) {
    const uid = user?.uid || null;

    if (!uid) {
      setLocalCart([]);
      return;
    }

    const snap = await getDocs(collection(db, "users", uid, "cartItems"));
    await Promise.all(snap.docs.map(d => deleteDoc(d.ref)));
    window.dispatchEvent(new CustomEvent("cart-changed"));
  }

  export async function writePurchase(user, payload) {
    const uid = user?.uid || null;
    if (!uid) return;

    try {
      await addDoc(collection(db, "users", uid, "purchases"), {
        ...payload,
        createdAt: serverTimestamp(),
      });
    } catch (err) {
      console.error("writePurchase failed", err);
    }
  }

  // ---------- Emission helper (ensures products loaded, resolves prices) ----------
  async function emitResolvedCart(user, rawItems) {
    // Try to load products.json; if it fails, we still emit normalized items.
    await loadProducts();

    const items = (rawItems || []).map(x => {
      const n = normalizeCartItem(x);
      return _productsLoaded ? resolveFromCatalog(n) : n;
    });

    emit("cart", { user: user || null, items });
  }

  // ---------- Start listeners (auth -> cart + purchases) ----------
  let unsubCart = null;
  let unsubPurchases = null;

  export function startCartData() {
    onAuthStateChanged(auth, (user) => {
      emit("auth", { user: user || null });

      if (unsubCart) { unsubCart(); unsubCart = null; }
      if (unsubPurchases) { unsubPurchases(); unsubPurchases = null; }

      if (!user) {
        // Signed out: build normalized items from local cart
        const localRaw = getLocalCart();
        const local = localRaw.map((rawItem, i) => {
          const id = rawItem.id || `local-${Date.now()}-${i}-${Math.random().toString(16).slice(2)}`;
          return normalizeCartItem({
            id,
            productId: rawItem.productId || rawItem.pid || null,
            variantId: rawItem.variantId || rawItem.vid || null,
            variantLabel: rawItem.variantLabel || "",
            title: rawItem.title || rawItem.name || rawItem.productName || "",
            // IMPORTANT: do NOT force 0; leave null if missing so resolver can fill
            price: (rawItem.price ?? rawItem.priceNum ?? null),
            qty: rawItem.qty || 1,
            image: rawItem.image || rawItem.imageUrl || null,
            buyLink: rawItem.buyLink || null,
            squareUrl: rawItem.squareUrl || rawItem.squareLink || null,
            downloadUrl: rawItem.downloadUrl || rawItem.accessUrl || rawItem.url || rawItem.link || null,
            accessUrl: rawItem.accessUrl || null,
          });
        });

        // Persist ids if we added any (store what we have; resolver is for display)
        setLocalCart(local.map(x => ({
          id: x.id,
          productId: x.productId,
          variantId: x.variantId,
          variantLabel: x.variantLabel,
          title: x.title,
          price: x.price,
          qty: x.qty,
          image: x.image,
          buyLink: x.buyLink,
          squareUrl: x.squareUrl,
          downloadUrl: x.downloadUrl,
          accessUrl: x.accessUrl,
        })));

        // Emit with resolved catalog fields (price/title/image)
        emitResolvedCart(null, local);
        emit("purchases", { user: null, rows: getLocalPurchases() });
        return;
      }

      // Signed in: Firestore cart listener
      const cartRef = collection(db, "users", user.uid, "cartItems");
      unsubCart = onSnapshot(cartRef, (snap) => {
        const raw = [];
        snap.forEach(d => {
          const data = d.data() || {};
          raw.push({
            id: d.id,
            productId: data.productId ?? null,
            variantId: data.variantId ?? null,
            variantLabel: data.variantLabel ?? "",
            buyLink: data.buyLink ?? null,
            title: data.title || data.name || data.productName || "",
            // IMPORTANT: do NOT default to 0 — treat missing as null so resolver can fill
            price: (data.price ?? data.priceNum ?? null),
            priceNum: data.priceNum ?? null,
            qty: Number.isFinite(data.qty) ? Number(data.qty) : 1,
            image: data.image ?? data.imageUrl ?? null,
            squareUrl: data.squareUrl ?? data.squareLink ?? null,
            downloadUrl: data.downloadUrl ?? data.accessUrl ?? data.url ?? data.link ?? null,
            accessUrl: data.accessUrl ?? null,
          });
        });

        // Emit with resolved catalog fields (price/title/image)
        emitResolvedCart(user, raw);
      });

      // Signed in: purchases listener
      const purchasesRef = query(
        collection(db, "users", user.uid, "purchases"),
        orderBy("createdAt", "desc")
      );

      unsubPurchases = onSnapshot(purchasesRef, (snap) => {
        const rows = [];
        snap.forEach(d => {
          const x = d.data() || {};
          rows.push({
            type: x.type || "purchase",
            itemId: String(x.itemId || ""),
            title: x.title || x.itemId || "Purchase",
            accessUrl: x.accessUrl || x.downloadUrl || null,
            createdAt: x.createdAt || null,
          });
        });
        emit("purchases", { user, rows });
      });
    });

    // If cart changes while signed out
    window.addEventListener("cart-changed", () => {
      // Re-emit signed-out cart (resolved)
      const localRaw = getLocalCart();
      emitResolvedCart(null, localRaw);
    });
  }
</script>



<script>// /js/cart-ui.js
import {
  startCartData, on,
  setQty, removeItem, clearEntireCart, writePurchase,
  getLocalPurchases, addLocalPurchase
} from "/js/cart-data.js";

/* =============================
   Square donation payment links
============================= */
const SQUARE_DONATION = {
  one_time: {
    custom: "https://square.link/u/h4bY1vEF",
    "1": "https://square.link/u/bWytGN4p",
    "5": "https://square.link/u/4XBSzfLg",
    "10": "https://square.link/u/AvF6x51S",
  },
  weekly: { custom: "https://square.link/u/FkJZDx1R" },
  monthly: { custom: "https://square.link/u/ZK2wPwwU" },
  annual: { custom: "https://square.link/u/RSb94DzN" },
};

/* =============================
   DOM refs (same ids you have)
============================= */
const signedOut = document.getElementById("signedOut");
const flowNotice = document.getElementById("flowNotice");

const paidList = document.getElementById("paidList");
const freeList = document.getElementById("freeList");
const paidListPay = document.getElementById("paidListPay");

const paidEmpty = document.getElementById("paidEmpty");
const freeEmpty = document.getElementById("freeEmpty");
const allEmpty = document.getElementById("allEmpty");
const paidEmptyPay = document.getElementById("paidEmptyPay");

const paidCountPill = document.getElementById("paidCountPill");
const freeCountPill = document.getElementById("freeCountPill");

const paidQtyEl = document.getElementById("paidQty");
const freeQtyEl = document.getElementById("freeQty");
const paidSubtotalEl = document.getElementById("paidSubtotal");
const dueNowEl = document.getElementById("dueNow");

// panes / nav
const panes = [
  document.getElementById("pane-review"),
  document.getElementById("pane-support"),
  document.getElementById("pane-pay"),
  document.getElementById("pane-success"),
];
const stepEls = [
  document.getElementById("step-1"),
  document.getElementById("step-2"),
  document.getElementById("step-3"),
  document.getElementById("step-4"),
];
const backBtn = document.getElementById("backBtn");
const nextBtn = document.getElementById("nextBtn");

const successGrid = document.getElementById("successGrid");
const successEmpty = document.getElementById("successEmpty");

// Donation controls
const donationFreq = document.getElementById("donationFreq");
const donationAmountPreset = document.getElementById("donationAmountPreset");
const oneTimeOptions = [...donationAmountPreset.querySelectorAll('option[data-one-time="1"]')];
const donateBtn = document.getElementById("donateBtn");
const clearDonationBtn = document.getElementById("clearDonationBtn");
const donationHint = document.getElementById("donationHint");

/* =============================
   State
============================= */
let currentUser = null;
let lastRendered = { paid: [], free: [] };
let purchaseRows = [];
let stepIndex = 0;

// BUY FLOW state (single item)
let buyMode = false;
let buyItem = null;

/* =============================
   Money + safety helpers
============================= */
function parsePrice(val) {
  if (val == null) return null;
  if (typeof val === "number") return Number.isFinite(val) ? val : null;
  const s = String(val).trim();
  if (!s) return null;
  const cleaned = s.replace(/[^0-9.\-]/g, "");
  if (!cleaned) return null;
  const n = Number(cleaned);
  return Number.isFinite(n) ? n : null;
}
function normalizePriceNumber(n) {
  if (!Number.isFinite(n)) return null;
  if (n >= 1000 && Math.abs(n - Math.round(n)) < 1e-9) return n / 100;
  return n;
}
const money = (n) => (normalizePriceNumber(Number(n)) ?? 0).toFixed(2);

function safeUrl(u) {
  const s = String(u || "").trim();
  if (!s) return "";
  if (s.startsWith("https://") || s.startsWith("http://") || s.startsWith("/")) return s;
  return "";
}
function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, (c) => ({
    "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
  }[c]));
}
function buildSquareRedirectUrl(baseUrl, redirectTo) {
  const u = String(baseUrl);
  const join = u.includes("?") ? "&" : "?";
  return u + join + "redirect_url=" + encodeURIComponent(redirectTo);
}
function setFlowNotice(kind, msg) {
  flowNotice.style.display = "block";
  flowNotice.className = "notice " + (kind || "");
  flowNotice.innerHTML = msg;
}
function clearFlowNotice() {
  flowNotice.style.display = "none";
  flowNotice.innerHTML = "";
  flowNotice.className = "notice";
}

/* =============================
   Products cache / resolution
============================= */
let PRODUCTS_CACHE = null;
let PRODUCT_BY_ID = new Map();
let VARIANT_BY_KEY = new Map(); // `${productId}::${variantId}`

function readPrice(obj) {
  if (!obj) return null;
  return (
    parsePrice(obj.price) ??
    parsePrice(obj.priceNum) ??
    parsePrice(obj.amount) ??
    parsePrice(obj.value) ??
    null
  );
}

async function loadProducts() {
  if (PRODUCTS_CACHE) return PRODUCTS_CACHE;
  const r = await fetch("https://unlim8ted.com/tools/data/products.json", { cache: "no-store" });
  if (!r.ok) throw new Error("Failed to load products.json");
  const data = await r.json();
  PRODUCTS_CACHE = Array.isArray(data) ? data : (data?.products || []);
  indexProducts(PRODUCTS_CACHE);
  return PRODUCTS_CACHE;
}

function indexProducts(products) {
  PRODUCT_BY_ID = new Map();
  VARIANT_BY_KEY = new Map();

  for (const p of (products || [])) {
    const pid = String(p.id ?? p.productId ?? "").trim();
    if (pid) PRODUCT_BY_ID.set(pid, p);

    const vars = Array.isArray(p.varients) ? p.varients : (Array.isArray(p.variants) ? p.variants : []);
    for (const v of vars) {
      const vid = String(v.id ?? v.variantId ?? "").trim();
      if (!pid || !vid) continue;
      VARIANT_BY_KEY.set(`${pid}::${vid}`, v);
    }
  }
}

function resolveProductImage(productId, variantId) {
  const pid = String(productId || "").trim();
  if (!pid) return "";
  const p = PRODUCT_BY_ID.get(pid) || null;
  if (!p) return "";

  const vid = String(variantId || "").trim();
  if (vid) {
    const v = VARIANT_BY_KEY.get(`${pid}::${vid}`) || null;
    const vImg = v ? (safeUrl(v.image) || safeUrl(v.imageUrl) || safeUrl(v.thumbnail) || "") : "";
    if (vImg) return vImg;
  }

  const pImg =
    safeUrl(p.image) ||
    safeUrl(p.imageUrl) ||
    safeUrl(p.thumbnail) ||
    safeUrl(p.thumb) ||
    "";
  if (pImg) return pImg;

  if (Array.isArray(p.images) && p.images.length) {
    const first = p.images[0];
    if (typeof first === "string") return safeUrl(first);
    if (first && typeof first === "object") return safeUrl(first.url || first.src || first.imageUrl || first.image);
  }
  return "";
}

async function resolveItemData(raw) {
  const productId = String(raw?.productId ?? raw?.pid ?? raw?.product ?? "").trim();
  const variantId = String(raw?.variantId ?? raw?.vid ?? raw?.variant ?? "").trim();

  if (productId) {
    try { await loadProducts(); } catch { /* ignore */ }
  }

  const p = productId ? (PRODUCT_BY_ID.get(productId) || null) : null;
  const v = (productId && variantId) ? (VARIANT_BY_KEY.get(`${productId}::${variantId}`) || null) : null;

  const title =
    String(raw?.title || raw?.name || raw?.productName || "").trim() ||
    String(p?.name || p?.title || productId || "Item").trim();

  const price = normalizePriceNumber(readPrice(raw) ?? readPrice(v) ?? readPrice(p) ?? 0) || 0;

  const variantLabel =
    String(raw?.variantLabel || "").trim() ||
    String(v?.name || "").trim();

  const squareUrl =
    safeUrl(raw?.buyLink) ||
    safeUrl(raw?.squareUrl) ||
    safeUrl(raw?.squareLink) ||
    safeUrl(raw?.square) ||
    safeUrl(v?.buy_link) ||
    safeUrl(v?.buyLink) ||
    safeUrl(p?.buy_link) ||
    safeUrl(p?.buyLink) ||
    "";

  let imageUrl =
    safeUrl(raw?.image) || safeUrl(raw?.imageUrl) || "";

  if (!imageUrl) {
    const vImg =
      safeUrl(v?.image) ||
      safeUrl(v?.imageUrl) ||
      (Array.isArray(v?.images) && v.images.length
        ? (typeof v.images[0] === "string" ? safeUrl(v.images[0]) : safeUrl(v.images[0]?.url || v.images[0]?.src))
        : "");
    imageUrl = vImg || safeUrl(p?.image) || safeUrl(p?.imageUrl) || "";
    if (!imageUrl) imageUrl = resolveProductImage(productId, variantId);
  }

  const accessUrl =
    safeUrl(raw?.downloadUrl) ||
    safeUrl(raw?.accessUrl) ||
    safeUrl(raw?.url) ||
    safeUrl(raw?.link) ||
    safeUrl(v?.accessUrl) ||
    safeUrl(p?.accessUrl) ||
    "";

  return { ...raw, title, price, variantLabel, squareUrl, imageUrl, accessUrl };
}

/* =============================
   Stepper
============================= */
function setStep(idx) {
  stepIndex = Math.max(0, Math.min(3, idx));
  panes.forEach((p, i) => p.classList.toggle("active", i === stepIndex));
  stepEls.forEach((s, i) => s.classList.toggle("active", i === stepIndex));

  backBtn.disabled = (stepIndex === 0);
  nextBtn.textContent = (stepIndex === 3) ? "Done" : "Continue";

  if (stepIndex === 3) renderSuccess();
  if (stepIndex === 2) renderPaidPayPane();

  try { document.querySelector(".card.list")?.scrollIntoView({ behavior: "smooth", block: "start" }); } catch { }
}

backBtn.addEventListener("click", () => setStep(stepIndex - 1));

nextBtn.addEventListener("click", async () => {
  if (stepIndex < 3) { setStep(stepIndex + 1); return; }

  // Done on Success
  if (buyMode) {
    buyMode = false;
    buyItem = null;
    clearFlowNotice();
    setStep(0);
    return;
  }

  await clearEntireCart(currentUser);
  clearFlowNotice();
  setStep(0);

  setFlowNotice(
    "ok",
    `<div style="display:flex;gap:10px;align-items:flex-start">
      <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="margin-top:2px;">
        <path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <div>
        <strong>Checkout complete.</strong><br/>
        Your cart has been cleared.
      </div>
    </div>`
  );
});

/* =============================
   Render helpers
============================= */
function splitItems(items) {
  const paid = [];
  const free = [];
  for (const it of items) {
    const price = normalizePriceNumber(parsePrice(it.price)) || 0;
    if (price > 0) paid.push({ ...it, price });
    else free.push({ ...it, price: 0 });
  }
  return { paid, free };
}

function recomputeSummary(paid, free) {
  const paidQty = paid.reduce((s, it) => s + (Number(it.qty) || 1), 0);
  const freeQty = free.reduce((s, it) => s + (Number(it.qty) || 1), 0);

  const paidSubtotal = paid.reduce((s, it) => {
    const price = normalizePriceNumber(parsePrice(it.price)) || 0;
    const qty = Number(it.qty) || 1;
    return s + price * qty;
  }, 0);

  paidQtyEl.textContent = String(paidQty);
  freeQtyEl.textContent = String(freeQty);
  paidSubtotalEl.textContent = money(paidSubtotal);
  dueNowEl.textContent = money(paidSubtotal);

  paidCountPill.textContent = String(paid.length);
  freeCountPill.textContent = String(free.length);

  paidEmpty.style.display = paid.length ? "none" : "block";
  freeEmpty.style.display = free.length ? "none" : "block";
  allEmpty.style.display = (paid.length === 0 && free.length === 0) ? "block" : "none";
  paidEmptyPay.style.display = paid.length ? "none" : "block";

  nextBtn.disabled = (paid.length === 0 && free.length === 0);
  nextBtn.textContent = nextBtn.disabled ? "Add items first" : (stepIndex === 3 ? "Done" : "Continue");
}

function itemCardHTML(it, kind, view = "review") {
  const qty = Math.max(1, Number(it.qty) || 1);
  const price = normalizePriceNumber(parsePrice(it.price)) || 0;

  const title = escapeHtml(it.title || it.name || "Item");

  const imgUrl = safeUrl(it.image || it.imageUrl || "");
  const img = imgUrl ? `<img src="${escapeHtml(imgUrl)}" alt="">` : "No image";

  const accessUrl = safeUrl(it.accessUrl || it.downloadUrl || it.url || it.link);
  const squareUrl = safeUrl(it.squareUrl);

  const variantLabel = String(it.variantLabel || "").trim();
  const variantLine = variantLabel
    ? `<div class="mini" style="margin-top:2px;">Variant: <strong>${escapeHtml(variantLabel)}</strong></div>`
    : ``;

  const purchaseReturn = `https://unlim8ted.com/cart?source=purchase&itemId=${encodeURIComponent(it.id)}`;
  const squareWithRedirect = squareUrl ? buildSquareRedirectUrl(squareUrl, purchaseReturn) : "";

  const priceLabel = (kind === "free")
    ? `<div class="price">FREE</div>`
    : `<div class="price">$${money(price)}</div>`;

  const hint = (kind === "paid")
    ? `<div class="mini">Purchased individually via Square. Returning here will clear it from your cart.</div>`
    : `<div class="mini">This item is completely free!</div>`;

  const primaryAction = (kind === "free")
    ? (accessUrl
      ? `<a class="btn btn-primary btn-small" href="${escapeHtml(accessUrl)}" target="_blank" rel="noopener">Open</a>`
      : ``
    )
    : (squareUrl
      ? `<a class="btn btn-primary btn-small" href="${escapeHtml(squareWithRedirect)}" target="_blank" rel="noopener">Buy on Square</a>`
      : `<button class="btn btn-ghost btn-small" type="button" data-missinglink="${escapeHtml(it.id)}">Square link needed</button>`
    );

  const qtyControls = `
    <div class="qty" aria-label="Quantity">
      <button type="button" data-dec="${escapeHtml(it.id)}" aria-label="Decrease quantity">−</button>
      <input type="text" inputmode="numeric" value="${qty}" data-qty="${escapeHtml(it.id)}" aria-label="Quantity value">
      <button type="button" data-inc="${escapeHtml(it.id)}" aria-label="Increase quantity">+</button>
    </div>
  `;

  // Hide action buttons ONLY on Review
  const showActions = (view !== "review");

  const actionRow = showActions ? `
    <div class="row2" style="justify-content:flex-end; margin-top:2px;">
      ${primaryAction}
      ${accessUrl && kind === "paid" ? `
        <a class="btn btn-ghost btn-small" href="${escapeHtml(accessUrl)}" target="_blank" rel="noopener">View details</a>
      ` : ``}
    </div>
  ` : ``;

  return `
    <div class="item">
      <div class="thumb">${img}</div>

      <div class="meta">
        <div class="title">${title}</div>
        ${variantLine}

        <div class="row2">
          <div>
            ${priceLabel}
            ${hint}
          </div>
          ${qtyControls}
        </div>

        ${actionRow}
      </div>

      <div class="actions">
        <button class="iconbtn" type="button" data-remove="${escapeHtml(it.id)}" title="Remove" aria-label="Remove">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M4 7h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            <path d="M10 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            <path d="M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            <path d="M6 7l1 14h10l1-14" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            <path d="M9 7V4h6v3" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
          </svg>
        </button>
      </div>
    </div>
  `;
}

async function render(items) {
  // BUY MODE: show ONLY the buy item (do not touch cart)
  if (buyMode && buyItem) items = [buyItem];

  const enriched = await Promise.all((items || []).map(async (raw) => {
    const r = await resolveItemData(raw);
    const price = normalizePriceNumber(parsePrice(r.price)) || 0;
    return {
      ...r,
      id: raw.id || r.id,
      qty: Number(raw.qty ?? r.qty ?? 1) || 1,
      squareUrl: r.squareUrl || safeUrl(raw.squareUrl) || safeUrl(raw.buyLink) || "",
      accessUrl: r.accessUrl || safeUrl(raw.accessUrl) || safeUrl(raw.downloadUrl) || "",
      image: r.imageUrl || safeUrl(raw.image) || safeUrl(raw.imageUrl) || "",
      price,
      title: r.title || raw.title || raw.name || "Item",
      variantLabel: r.variantLabel || raw.variantLabel || "",
    };
  }));

  const { paid, free } = splitItems(enriched);
  lastRendered = { paid, free };

  paidList.innerHTML = "";
  freeList.innerHTML = "";

  for (const it of free) {
    const wrap = document.createElement("div");
    wrap.innerHTML = itemCardHTML(it, "free", "review");
    freeList.appendChild(wrap.firstElementChild);
  }
  for (const it of paid) {
    const wrap = document.createElement("div");
    wrap.innerHTML = itemCardHTML(it, "paid", "review");
    paidList.appendChild(wrap.firstElementChild);
  }

  renderPaidPayPane();
  recomputeSummary(paid, free);
  if (stepIndex === 3) renderSuccess();
}

function renderPaidPayPane() {
  const paid = lastRendered.paid || [];
  paidListPay.innerHTML = "";
  for (const it of paid) {
    const wrap = document.createElement("div");
    wrap.innerHTML = itemCardHTML(it, "paid", "pay");
    paidListPay.appendChild(wrap.firstElementChild);
  }
  paidEmptyPay.style.display = paid.length ? "none" : "block";
}

function findItemById(id) {
  const all = [...(lastRendered.paid || []), ...(lastRendered.free || [])];
  return all.find(x => String(x.id) === String(id)) || null;
}

/* =============================
   UI events (qty/remove/missing)
============================= */
let wired = false;
function wireEvents() {
  if (wired) return;
  wired = true;

  document.addEventListener("click", async (e) => {
    const rm = e.target.closest("[data-remove]");
    if (rm) {
      if (buyMode) { setFlowNotice("warn", `<strong>Buy Now mode:</strong> this item isn’t in your cart.`); return; }
      const id = rm.getAttribute("data-remove");
      try { await removeItem(currentUser, id); } catch (err) { console.error(err); }
      return;
    }

    const inc = e.target.closest("[data-inc]");
    if (inc) {
      const id = inc.getAttribute("data-inc");
      const input = document.querySelector(`[data-qty="${CSS.escape(id)}"]`);
      const current = Math.max(1, parseInt(input?.value || "1", 10) || 1);
      input.value = String(current + 1);
      try { await setQty(currentUser, id, current + 1); } catch (err) { console.error(err); }
      return;
    }

    const dec = e.target.closest("[data-dec]");
    if (dec) {
      const id = dec.getAttribute("data-dec");
      const input = document.querySelector(`[data-qty="${CSS.escape(id)}"]`);
      const current = Math.max(1, parseInt(input?.value || "1", 10) || 1);
      const next = Math.max(1, current - 1);
      input.value = String(next);
      try { await setQty(currentUser, id, next); } catch (err) { console.error(err); }
      return;
    }

    const missing = e.target.closest("[data-missinglink]");
    if (missing) {
      setFlowNotice(
        "warn",
        `<strong>Square link missing.</strong> This item needs a variant link in <code>products.json</code> or a <code>buyLink</code> saved in cart.`
      );
      return;
    }
  });

  let t = null;
  document.addEventListener("input", (e) => {
    const inp = e.target.closest("[data-qty]");
    if (!inp) return;

    const id = inp.getAttribute("data-qty");
    let qty = parseInt(inp.value, 10);
    if (!Number.isFinite(qty) || qty < 1) qty = 1;

    clearTimeout(t);
    t = setTimeout(async () => {
      try { await setQty(currentUser, id, qty); } catch (err) { console.error(err); }
    }, 300);
  });
}

/* =============================
   Donation UI logic
============================= */
function syncDonationUI() {
  const freq = donationFreq.value;
  const preset = donationAmountPreset.value;
  const isOneTime = (freq === "one_time");

  for (const opt of oneTimeOptions) opt.hidden = !isOneTime;
  if (!isOneTime && donationAmountPreset.value !== "custom") donationAmountPreset.value = "custom";

  if (!isOneTime) {
    donationHint.innerHTML = `Recurring donations are currently supported as <strong>Custom</strong> only.`;
  } else if (preset !== "custom") {
    donationHint.innerHTML = `You’ll be sent to Square for a <strong>one-time $${escapeHtml(preset)}</strong> donation.`;
  } else {
    donationHint.innerHTML = `You’ll be sent to Square for a <strong>${escapeHtml(freq.replace("_", " "))}</strong> custom donation.`;
  }
}

function getDonationLink() {
  const freq = donationFreq.value;
  const preset = donationAmountPreset.value;

  if (freq === "one_time") {
    if (preset === "1" || preset === "5" || preset === "10") return SQUARE_DONATION.one_time[preset];
    return SQUARE_DONATION.one_time.custom;
  }
  return (SQUARE_DONATION[freq] && SQUARE_DONATION[freq].custom) ? SQUARE_DONATION[freq].custom : "";
}

donateBtn.addEventListener("click", () => {
  const link = getDonationLink();
  if (!link) {
    setFlowNotice("warn", `<strong>Donation link unavailable.</strong> Please try again later.`);
    return;
  }
  const redirectBack = "https://unlim8ted.com/cart?source=donation";
  window.location.href = buildSquareRedirectUrl(link, redirectBack);
});

clearDonationBtn.addEventListener("click", () => {
  donationFreq.value = "one_time";
  donationAmountPreset.value = "custom";
  clearFlowNotice();
  syncDonationUI();
});

donationFreq.addEventListener("change", () => {
  if (donationFreq.value !== "one_time") donationAmountPreset.value = "custom";
  syncDonationUI();
});
donationAmountPreset.addEventListener("change", syncDonationUI);
syncDonationUI();

/* =============================
   Success pane rendering
============================= */
function renderSuccess() {
  const rows = currentUser?.uid ? purchaseRows : getLocalPurchases();
  successGrid.innerHTML = "";

  const header = document.createElement("div");
  header.className = "successRow";
  header.innerHTML = `
    <div style="display:flex;gap:12px;align-items:flex-start;min-width:0;">
      <div style="min-width:0;">
        <div style="font-weight:900;letter-spacing:.2px;">Success</div>
        <div class="mini">Your purchases and donations are recorded below.</div>
      </div>
    </div>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end;">
      <span class="tag">Recorded</span>
    </div>
  `;
  successGrid.appendChild(header);

  let count = 0;

  for (const r of rows) {
    const title = escapeHtml(r.title || r.itemId || "Purchase");
    const accessUrl = safeUrl(r.accessUrl || "");
    const type = escapeHtml(r.type || "purchase");

    const tag = accessUrl ? `<span class="tag">Link ready</span>` : `<span class="tag dim">${type}</span>`;
    const btn = accessUrl
      ? `<a class="btn btn-primary btn-small" href="${escapeHtml(accessUrl)}" target="_blank" rel="noopener">Open</a>`
      : `<button class="btn btn-ghost btn-small" type="button" disabled>No link</button>`;

    const row = document.createElement("div");
    row.className = "successRow";
    row.innerHTML = `
      <div style="min-width:0;">
        <div style="font-weight:900; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${title}</div>
        <div class="mini">Item ID: ${escapeHtml(r.itemId || "")}</div>
      </div>
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
        ${tag}
        ${btn}
      </div>
    `;
    successGrid.appendChild(row);
    count++;
  }

  // Free items with links (current cart view)
  const freeWithLinks = (lastRendered.free || [])
    .filter(it => safeUrl(it.accessUrl || it.downloadUrl || it.url || it.link));

  for (const it of freeWithLinks) {
    const title = escapeHtml(it.title || it.name || it.id);
    const accessUrl = safeUrl(it.accessUrl || it.downloadUrl || it.url || it.link);

    const row = document.createElement("div");
    row.className = "successRow";
    row.innerHTML = `
      <div style="min-width:0;">
        <div style="font-weight:900; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${title}</div>
        <div class="mini">Free item link</div>
      </div>
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
        <span class="tag">Link ready</span>
        <a class="btn btn-primary btn-small" href="${escapeHtml(accessUrl)}" target="_blank" rel="noopener">Open</a>
      </div>
    `;
    successGrid.appendChild(row);
    count++;
  }

  successEmpty.style.display = (count === 0) ? "block" : "none";
}

/* =============================
   Return flow handling (donation/purchase/buy)
============================= */
async function handleReturnFlow(user) {
  const p = new URLSearchParams(window.location.search);
  const source = p.get("source");
  const itemId = p.get("itemId");
  const productParam = p.get("product");
  const orderId = p.get("orderId");
  const transactionId = p.get("transactionId");
  if (!source) return;

  if (source === "donation") {
    const row = {
      type: "donation",
      itemId: "donation",
      title: "Donation",
      accessUrl: null,
      orderId: orderId || null,
      transactionId: transactionId || null
    };

    if (user?.uid) await writePurchase(user, row);
    else addLocalPurchase({ ...row, createdAt: Date.now() });

    setFlowNotice(
      "ok",
      `<div style="display:flex;gap:10px;align-items:flex-start">
        <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="margin-top:2px;">
          <path d="M12 21s-7-4.35-9.33-9A5.5 5.5 0 0 1 12 6a5.5 5.5 0 0 1 9.33 6c-2.33 4.65-9.33 9-9.33 9Z"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
        <div>
          <strong>Donation received.</strong><br/>
          Thank you for supporting Unlim8ted.
        </div>
      </div>`
    );

    setStep(2);
  }

  if (source === "purchase") {
    if (!itemId) {
      setFlowNotice("warn", `<strong>Purchase return received</strong> but no item was identified.`);
    } else {
      const item = findItemById(itemId);

      const purchaseRow = {
        type: "paid_item",
        itemId: String(itemId),
        title: item?.title || item?.name || String(itemId),
        accessUrl: safeUrl(item?.accessUrl || item?.downloadUrl || item?.url || item?.link || ""),
        qty: item?.qty ? Number(item.qty) : 1,
        price: item?.price != null ? (normalizePriceNumber(parsePrice(item.price)) ?? null) : null,
        orderId: orderId || null,
        transactionId: transactionId || null
      };

      if (user?.uid) await writePurchase(user, purchaseRow);
      else addLocalPurchase({ ...purchaseRow, createdAt: Date.now() });

      // Clear from cart
      try { await removeItem(user, itemId); } catch (err) { console.error(err); }

      setFlowNotice(
        "ok",
        `<div style="display:flex;gap:10px;align-items:flex-start">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="margin-top:2px;">
            <path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <div>
            <strong>Purchase received.</strong><br/>
            That item has been removed from your cart.
          </div>
        </div>`
      );

      setStep(2);
    }
  }

  if (source === "buy") {
    const pid = String(productParam || "").trim();
    if (!pid) {
      setFlowNotice("warn", `<strong>Buy Now:</strong> missing <code>product</code> parameter.`);
      setStep(0);
    } else {
      buyMode = true;

      try { await loadProducts(); } catch { /* ignore */ }
      const pObj = PRODUCT_BY_ID.get(pid) || null;

      const title = pObj?.title || pObj?.name || pid;
      const image = resolveProductImage(pid, "");
      const price = normalizePriceNumber(readPrice(pObj) ?? 0) || 0;

      const buyLink =
        safeUrl(pObj?.buyLink) ||
        safeUrl(pObj?.squareUrl) ||
        safeUrl(pObj?.squareLink) ||
        safeUrl(pObj?.square) ||
        safeUrl(pObj?.buy_link) ||
        "";

      const accessUrl =
        safeUrl(pObj?.accessUrl) ||
        safeUrl(pObj?.downloadUrl) ||
        safeUrl(pObj?.url) ||
        safeUrl(pObj?.link) ||
        "";

      buyItem = {
        id: `buy-${pid}`,
        productId: pid,
        variantId: null,
        variantLabel: "",
        title,
        price,
        qty: 1,
        image,
        buyLink,
        squareUrl: buyLink,
        accessUrl
      };

      await render([buyItem]);

      setFlowNotice(
        "ok",
        `<div style="display:flex;gap:10px;align-items:flex-start">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="margin-top:2px;">
            <path d="M6 6h15l-2 8H8L6 6Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            <path d="M6 6 5 3H2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <circle cx="9" cy="19" r="1.8" stroke="currentColor" stroke-width="2"/>
            <circle cx="17" cy="19" r="1.8" stroke="currentColor" stroke-width="2"/>
          </svg>
          <div>
            <strong>Buy Now mode.</strong><br/>
            You’re checking out a single item. Hit <strong>Done</strong> on Success to return to your full cart.
          </div>
        </div>`
      );

      setStep(0);
    }
  }

  // Clean URL
  try {
    const clean = window.location.origin + window.location.pathname;
    window.history.replaceState({}, "", clean);
  } catch { }
}

/* =============================
   Wire data module → UI updates
============================= */
wireEvents();
loadProducts().catch(() => {});

// Auth updates
on("auth", async ({ user }) => {
  currentUser = user || null;
  signedOut.style.display = user ? "none" : "block";
  await handleReturnFlow(user);
});

// Cart updates
on("cart", async ({ user, items }) => {
  // If buyMode is active, keep current render (it renders buyItem only)
  if (!buyMode) await render(items || []);
});

// Purchases updates
on("purchases", ({ user, rows }) => {
  purchaseRows = rows || [];
  if (stepIndex === 3) renderSuccess();
});

/* =============================
   Start it all
============================= */
startCartData();
setStep(0);

// Footer year
const y = new Date().getFullYear();
document.getElementById("footer-text").innerHTML =
  `&copy; 2019-${y} Unlim8ted Studio Productions. All rights reserved.`;
</script>

</body>

</html>
